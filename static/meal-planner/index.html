<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a2e">
<title>✨ Weekly Meal Planner</title>
<style>
/* ===== Revolutionary Design System ===== */
:root {
  /* Colors - Dynamic Gradient Palette */
  --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --primary-solid: #667eea;
  --secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --success: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  --warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  --danger: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
  
  /* Surfaces - Glassmorphism */
  --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  --bg-secondary: rgba(255, 255, 255, 0.05);
  --bg-card: rgba(255, 255, 255, 0.08);
  --bg-sheet: rgba(255, 255, 255, 0.12);
  --bg-overlay: rgba(0, 0, 0, 0.7);
  
  /* Text */
  --text-primary: #ffffff;
  --text-secondary: rgba(255, 255, 255, 0.8);
  --text-muted: rgba(255, 255, 255, 0.6);
  --text-inverse: #1a1a2e;
  
  /* Spacing & Layout */
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
  --radius-sm: 12px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --radius-xl: 32px;
  
  /* Shadows & Effects */
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.2);
  --shadow-lg: 0 16px 64px rgba(0, 0, 0, 0.3);
  --glass-border: rgba(255, 255, 255, 0.2);
  --blur: blur(20px);
  
  /* Animation */
  --transition-fast: 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --transition-smooth: 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --spring: 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* ===== Base Styles ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  height: 100%;
  overflow-x: hidden;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', Helvetica, Arial, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overscroll-behavior: none;
}

/* ===== Typography ===== */
.title-xl { font-size: 2rem; font-weight: 800; letter-spacing: -0.02em; }
.title-lg { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.01em; }
.title-md { font-size: 1.25rem; font-weight: 600; }
.title-sm { font-size: 1rem; font-weight: 600; }
.body-lg { font-size: 1rem; font-weight: 400; }
.body-md { font-size: 0.875rem; font-weight: 400; }
.body-sm { font-size: 0.75rem; font-weight: 500; }
.caption { font-size: 0.625rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

/* ===== Glass Components ===== */
.glass {
  background: var(--bg-card);
  border: 1px solid var(--glass-border);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
}

.glass-sheet {
  background: var(--bg-sheet);
  border: 1px solid var(--glass-border);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
}

/* ===== Button System ===== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: var(--radius-lg);
  font-weight: 600;
  font-size: 0.875rem;
  text-decoration: none;
  cursor: pointer;
  transition: all var(--transition-fast);
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.1);
  transform: translateX(-100%);
  transition: transform var(--transition-smooth);
}

.btn:active::before {
  transform: translateX(0);
}

.btn-primary {
  background: var(--primary);
  color: white;
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--bg-card);
  color: var(--text-primary);
  border: 1px solid var(--glass-border);
  backdrop-filter: var(--blur);
}

.btn-accent {
  background: var(--accent);
  color: white;
  box-shadow: var(--shadow-md);
}

.btn-success {
  background: var(--success);
  color: white;
  box-shadow: var(--shadow-md);
}

.btn-danger {
  background: var(--danger);
  color: white;
  box-shadow: var(--shadow-md);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn:active {
  transform: translateY(0);
}

/* ===== Layout ===== */
.app {
  min-height: 100vh;
  padding-bottom: calc(80px + var(--safe-bottom));
  position: relative;
}

/* ===== Header ===== */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  padding: calc(1rem + var(--safe-top)) 1rem 1rem;
  background: var(--bg-card);
  border-bottom: 1px solid var(--glass-border);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
}

.header-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}

.header-left {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.header-title {
  background: var(--primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 1.5rem;
  font-weight: 800;
  letter-spacing: -0.02em;
}

.header-subtitle {
  color: var(--text-secondary);
  font-size: 0.875rem;
  font-weight: 500;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

/* ===== Toggle Switch ===== */
.toggle {
  position: relative;
  width: 60px;
  height: 32px;
  background: var(--bg-secondary);
  border-radius: 16px;
  cursor: pointer;
  transition: all var(--transition-smooth);
  border: 1px solid var(--glass-border);
}

.toggle.active {
  background: var(--accent);
  box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
}

.toggle-knob {
  position: absolute;
  top: 2px;
  left: 2px;
  width: 28px;
  height: 28px;
  background: white;
  border-radius: 50%;
  transition: all var(--spring);
  box-shadow: var(--shadow-sm);
}

.toggle.active .toggle-knob {
  transform: translateX(28px);
}

/* ===== Main Content ===== */
.main {
  padding: 1rem;
}

/* ===== Day Cards ===== */
.day-grid {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.day-card {
  background: var(--bg-card);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  box-shadow: var(--shadow-sm);
  transition: all var(--transition-smooth);
  position: relative;
  overflow: hidden;
}

.day-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--primary);
  transform: scaleX(0);
  transition: transform var(--transition-smooth);
}

.day-card:hover::before {
  transform: scaleX(1);
}

.day-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
  border-color: rgba(255, 255, 255, 0.3);
}

.day-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.day-info h3 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
}

.day-date {
  color: var(--text-secondary);
  font-size: 0.875rem;
  font-weight: 500;
}

/* ===== Meal Fields ===== */
.meal-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.meal-field {
  background: var(--bg-secondary);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  padding: 1rem;
  cursor: pointer;
  transition: all var(--transition-fast);
  position: relative;
  overflow: hidden;
  min-height: 80px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.meal-field::before {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.05);
  transform: translateY(100%);
  transition: transform var(--transition-smooth);
}

.meal-field:hover::before {
  transform: translateY(0);
}

.meal-field:active {
  transform: scale(0.98);
}

.meal-label {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.meal-value {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-primary);
  line-height: 1.3;
}

.meal-placeholder {
  color: var(--text-muted);
  font-style: italic;
}

.side-full {
  grid-column: 1 / -1;
}

/* ===== Mode Selector ===== */
.mode-selector {
  display: flex;
  gap: 0.5rem;
  background: var(--bg-secondary);
  padding: 0.25rem;
  border-radius: var(--radius-md);
  border: 1px solid var(--glass-border);
}

.mode-btn {
  flex: 1;
  padding: 0.5rem 0.75rem;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  font-weight: 600;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all var(--transition-fast);
  text-transform: capitalize;
}

.mode-btn.active {
  background: var(--primary);
  color: white;
  box-shadow: var(--shadow-sm);
  transform: scale(1.05);
}

/* ===== Bottom Navigation ===== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 200;
  background: var(--bg-sheet);
  border-top: 1px solid var(--glass-border);
  padding: 1rem;
  padding-bottom: calc(1rem + var(--safe-bottom));
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
}

.nav-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
}

.nav-btn {
  padding: 1rem;
  border-radius: var(--radius-lg);
  font-weight: 600;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  position: relative;
  overflow: hidden;
}

.nav-btn .emoji {
  font-size: 1.2rem;
}

/* ===== Sheets & Overlays ===== */
.overlay {
  position: fixed;
  inset: 0;
  background: var(--bg-overlay);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: 300;
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition-smooth);
}

.overlay.show {
  opacity: 1;
  visibility: visible;
}

.sheet {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 400;
  background: var(--bg-sheet);
  border: 1px solid var(--glass-border);
  border-bottom: none;
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  max-height: 80vh;
  transform: translateY(100%);
  transition: transform var(--spring);
  box-shadow: var(--shadow-lg);
}

.sheet.show {
  transform: translateY(0);
}

.sheet-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--glass-border);
  text-align: center;
  position: relative;
}

.sheet-handle {
  width: 40px;
  height: 4px;
  background: var(--text-muted);
  border-radius: 2px;
  margin: 0 auto 1rem;
  opacity: 0.5;
}

.sheet-title {
  font-size: 1.125rem;
  font-weight: 700;
}

.sheet-body {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  max-height: calc(80vh - 140px);
}

.sheet-footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--glass-border);
  display: flex;
  gap: 1rem;
}

/* ===== Meal Options ===== */
.meal-options {
  padding: 1rem 0;
}

.option-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer;
  transition: all var(--transition-fast);
  position: relative;
}

.option-item:hover {
  background: rgba(255, 255, 255, 0.05);
}

.option-item.selected {
  background: rgba(103, 126, 234, 0.2);
  color: var(--primary-solid);
}

.option-item.selected::before {
  content: '✓';
  position: absolute;
  right: 1.5rem;
  color: var(--primary-solid);
  font-weight: bold;
}

.custom-input {
  display: flex;
  gap: 1rem;
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--glass-border);
  background: var(--bg-secondary);
}

.custom-input input {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  padding: 0.75rem 1rem;
  color: var(--text-primary);
  font-size: 0.875rem;
}

.custom-input input::placeholder {
  color: var(--text-muted);
}

.custom-input input:focus {
  outline: none;
  border-color: var(--primary-solid);
  box-shadow: 0 0 0 2px rgba(103, 126, 234, 0.2);
}

/* ===== Grocery List ===== */
.grocery-section {
  margin-bottom: 1.5rem;
}

.grocery-section h4 {
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 0.75rem;
  padding: 0 1.5rem;
  color: var(--text-secondary);
}

.grocery-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem 1.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.grocery-item input[type="checkbox"] {
  width: 20px;
  height: 20px;
  accent-color: var(--primary-solid);
}

.grocery-item label {
  flex: 1;
  font-size: 0.875rem;
  cursor: pointer;
}

/* ===== Share Text ===== */
.share-content {
  padding: 1.5rem;
}

.share-text {
  background: var(--bg-secondary);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  padding: 1rem;
  font-family: ui-monospace, 'SF Mono', monospace;
  font-size: 0.75rem;
  line-height: 1.5;
  white-space: pre-wrap;
  max-height: 300px;
  overflow-y: auto;
  color: var(--text-secondary);
}

/* ===== Loading States ===== */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 2rem;
  color: var(--text-muted);
}

.loading::before {
  content: '';
  width: 20px;
  height: 20px;
  border: 2px solid transparent;
  border-top: 2px solid var(--primary-solid);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===== Animations ===== */
.fade-in {
  animation: fadeIn 0.6s ease-out forwards;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.slide-up {
  animation: slideUp 0.4s ease-out forwards;
}

@keyframes slideUp {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* ===== Responsive Design ===== */
@media (max-width: 390px) {
  .meal-grid {
    grid-template-columns: 1fr;
  }
  
  .nav-grid {
    grid-template-columns: 1fr;
    gap: 0.5rem;
  }
  
  .mode-selector {
    flex-direction: column;
    gap: 0.25rem;
  }
}

/* ===== Accessibility ===== */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* ===== Focus Styles ===== */
:focus-visible {
  outline: 2px solid var(--primary-solid);
  outline-offset: 2px;
}
</style>
</head>
<body>

<div id="app" class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="header-title">✨ Meal Planner</h1>
        <div id="dateRange" class="header-subtitle"></div>
      </div>
      <div class="header-right">
        <div id="weekendToggle" class="toggle" role="switch" aria-label="Include weekend" tabindex="0">
          <div class="toggle-knob"></div>
        </div>
        <button id="clearBtn" class="btn btn-danger body-sm">Clear All</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div id="dayGrid" class="day-grid" aria-live="polite"></div>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="nav-grid">
      <button id="shuffleBtn" class="nav-btn btn-primary">
        <span class="emoji">🎲</span>
        <span>Randomize</span>
      </button>
      <button id="groceryBtn" class="nav-btn btn-success">
        <span class="emoji">🛒</span>
        <span>Grocery List</span>
      </button>
    </div>
    <button id="shareBtn" class="btn btn-accent" style="margin-top: 0.75rem; width: 100%;">
      <span class="emoji">📤</span>
      <span>Share Plan</span>
    </button>
  </nav>
</div>

<!-- Overlay -->
<div id="overlay" class="overlay"></div>

<!-- Meal Picker Sheet -->
<div id="mealPicker" class="sheet" role="dialog" aria-modal="true">
  <div class="sheet-header">
    <div class="sheet-handle"></div>
    <h2 id="pickerTitle" class="sheet-title">Choose Meal</h2>
  </div>
  <div id="customInputSection" class="custom-input" style="display: none;">
    <input id="customInput" type="text" placeholder="Enter custom meal name...">
    <button id="customUseBtn" class="btn btn-primary">Add</button>
  </div>
  <div class="sheet-body">
    <div id="mealOptions" class="meal-options"></div>
  </div>
  <div class="sheet-footer">
    <button id="pickerCloseBtn" class="btn btn-secondary" style="flex: 1;">Cancel</button>
  </div>
</div>

<!-- Grocery Sheet -->
<div id="grocerySheet" class="sheet" role="dialog" aria-modal="true">
  <div class="sheet-header">
    <div class="sheet-handle"></div>
    <h2 class="sheet-title">🛒 Grocery List</h2>
  </div>
  <div class="sheet-body">
    <div id="groceryContent"></div>
  </div>
  <div class="sheet-footer">
    <button id="groceryCopyBtn" class="btn btn-primary" style="flex: 1;">Copy List</button>
    <button id="groceryCloseBtn" class="btn btn-secondary" style="flex: 1;">Done</button>
  </div>
</div>

<!-- Share Sheet -->
<div id="shareSheet" class="sheet" role="dialog" aria-modal="true">
  <div class="sheet-header">
    <div class="sheet-handle"></div>
    <h2 class="sheet-title">📤 Share Meal Plan</h2>
  </div>
  <div class="sheet-body">
    <div class="share-content">
      <div id="shareText" class="share-text"></div>
    </div>
  </div>
  <div class="sheet-footer">
    <button id="shareCopyBtn" class="btn btn-primary" style="flex: 1;">Copy Text</button>
    <button id="shareCloseBtn" class="btn btn-secondary" style="flex: 1;">Done</button>
  </div>
</div>

<script>
/* ========= Enhanced Configuration ========== */
const MEALS = {
  lunch: [
    "🍝 Ravioli burro e salvia", "🍋 Spaghetti al limone", "🫘 Pasta e ceci", 
    "🐟 Pasta col tonno", "🍅 Pasta sugo tonno", "🥪 Piadine prosciutto provolone",
    "🍳 Uova fritte", "🌿 Pasta al pesto", "🍅 Pasta coi pomodorini", 
    "🫘 Lenticchie", "🧄 Spaghetti aglio e olio", "🥓 Carbonara",
    "🍳 Frittata di pasta", "🫘 Pasta e fagioli", "❌ None", "✏️ Custom…"
  ],
  dinner: {
    regular: [
      "🐟 Salmone col riso", "🥒 Frittata di zucchine", "🍖 Polpette", 
      "🍋 Pollo al limone", "🐟 Merluzzo", "🍔 Hamburger", "🍗 Cotolette",
      "🌭 Salsicce", "🥕 Minestrone", "🍗 Pollo al forno", 
      "🍋 Scaloppine al limone", "🍅 Caprese", "❌ None", "✏️ Custom…"
    ],
    quick: [
      "🍗 Cordon bleu", "🌭 Wurstel", "🥟 Dumplings", "🐟 Fish sticks", 
      "🍗 Pollo allo spiedo", "❌ None", "✏️ Custom…"
    ],
    delivery: [
      "🍕 Pizza Delivery", "🥙 Greco Delivery", "🥡 Chinese Delivery", 
      "🍜 Vietnamese Delivery", "🍜 Ramen Delivery", "❌ None", "✏️ Custom…"
    ],
    weekend: [
      "🍝 Pasta al forno", "🍆 Parmigiana di melanzane", "🥒 Zucchine ripiene",
      "🍝 Lasagna", "🥩 Spezzatino con patate", "🍝 Tortellini con la panna",
      "🍝 Tortellini col sugo", "🍝 Pasta col ragù", "🍖 Polpettone",
      "🌽 Polenta col sugo", "🍝 Cannelloni", "🥩 Bistecca", "❌ None", "✏️ Custom…"
    ]
  },
  side: [
    "🥔 Purè di patate", "🥦 Broccoli al vapore", "🍅 Insalata di pomodori",
    "🥔 Tater tots", "🫐 Barbabietole", "🌽 Insalata di mais", "🥔 Patate lesse",
    "🥕 Carote al forno", "🥕 Carote a insalata", "🥒 Zucchine trifolate",
    "🥒 Insalata di cetrioli", "🥗 Insalata", "❌ None", "✏️ Custom…"
  ]
};

const INGREDIENTS = {
  "🍝 Ravioli burro e salvia": ["ravioli", "sage", "butter"],
  "🍋 Spaghetti al limone": ["spaghetti", "lemon", "olive oil"],
  "🫘 Pasta e ceci": ["pasta", "chickpeas", "rosemary"],
  "🐟 Pasta col tonno": ["spaghetti", "tuna", "capers"],
  "🍅 Pasta sugo tonno": ["pasta", "tuna", "tomato sauce"],
  "🥪 Piadine prosciutto provolone": ["flatbread", "prosciutto", "provolone"],
  "🍳 Uova fritte": ["eggs", "olive oil"],
  "🌿 Pasta al pesto": ["pasta", "pesto", "pine nuts"],
  "🍅 Pasta coi pomodorini": ["pasta", "cherry tomatoes", "basil"],
  "🫘 Lenticchie": ["lentils", "vegetables", "croutons"],
  "🧄 Spaghetti aglio e olio": ["spaghetti", "garlic", "olive oil", "chili"],
  "🥓 Carbonara": ["spaghetti", "eggs", "bacon", "parmesan"],
  "🍳 Frittata di pasta": ["eggs", "leftover pasta", "cheese"],
  "🫘 Pasta e fagioli": ["pasta", "beans", "vegetables"],
  "🐟 Salmone col riso": ["salmon", "rice", "vegetables"],
  "🥒 Frittata di zucchine": ["eggs", "zucchini", "cheese"],
  "🍖 Polpette": ["ground beef", "breadcrumbs", "eggs", "tomato sauce"],
  "🍋 Pollo al limone": ["chicken breast", "lemon", "herbs"],
  "🐟 Merluzzo": ["cod", "vegetables", "olive oil"],
  "🍔 Hamburger": ["burger buns", "ground beef", "cheese", "lettuce", "tomato"],
  "🍗 Cotolette": ["cutlets", "breadcrumbs", "eggs"],
  "🌭 Salsicce": ["sausages", "vegetables"],
  "🥕 Minestrone": ["mixed vegetables", "pasta", "beans"],
  "🍗 Pollo al forno": ["chicken thighs", "potatoes", "herbs"],
  "🍋 Scaloppine al limone": ["veal cutlets", "lemon", "capers"],
  "🍅 Caprese": ["mozzarella", "tomatoes", "basil"],
  "🥔 Purè di patate": ["potatoes", "milk", "butter"],
  "🥦 Broccoli al vapore": ["broccoli"],
  "🍅 Insalata di pomodori": ["tomatoes", "olive oil", "basil"],
  "🥔 Tater tots": ["frozen tater tots"],
  "🫐 Barbabietole": ["beets"],
  "🌽 Insalata di mais": ["corn", "vegetables"],
  "🥔 Patate lesse": ["potatoes"],
  "🥕 Carote al forno": ["carrots", "olive oil"],
  "🥕 Carote a insalata": ["carrots"],
  "🥒 Zucchine trifolate": ["zucchini", "garlic"],
  "🥒 Insalata di cetrioli": ["cucumbers"],
  "🥗 Insalata": ["mixed greens", "vegetables"]
};

const STORE_CATEGORIES = {
  "🏪 Supermarket": ["pasta", "rice", "eggs", "milk", "bread", "vegetables", "meat", "cheese"],
  "🥩 Butcher": ["ground beef", "chicken breast", "chicken thighs", "sausages", "bacon"],
  "🐟 Fish Market": ["salmon", "cod", "tuna"],
  "🥬 Fresh Produce": ["tomatoes", "basil", "zucchini", "carrots", "broccoli", "lettuce"],
  "🏬 Specialty Store": ["pesto", "prosciutto", "provolone", "capers", "pine nuts"]
};

/* ========= Enhanced State Management ========= */
class MealPlannerState {
  constructor() {
    this.weekendEnabled = true;
    this.meals = {};
    this.currentPicker = null;
    this.init();
  }

  init() {
    this.loadFromStorage();
    this.generateWeekKeys();
  }

  generateWeekKeys() {
    const today = new Date();
    const monday = new Date(today);
    const dayOfWeek = today.getDay();
    const daysUntilMonday = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
    monday.setDate(today.getDate() + daysUntilMonday);

    this.weekStart = monday;
    this.weekKeys = [];
    
    for (let i = 0; i < 7; i++) {
      const date = new Date(monday);
      date.setDate(monday.getDate() + i);
      const key = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
      this.weekKeys.push(key);
      
      if (!this.meals[key]) {
        this.meals[key] = {
          lunch: "",
          dinner: "",
          side: "",
          mode: "regular"
        };
      }
    }
  }

  loadFromStorage() {
    try {
      const saved = localStorage.getItem('mealPlannerState');
      if (saved) {
        const data = JSON.parse(saved);
        this.weekendEnabled = data.weekendEnabled ?? true;
        this.meals = data.meals ?? {};
      }
    } catch (e) {
      console.warn('Failed to load from storage:', e);
    }
  }

  saveToStorage() {
    try {
      localStorage.setItem('mealPlannerState', JSON.stringify({
        weekendEnabled: this.weekendEnabled,
        meals: this.meals
      }));
    } catch (e) {
      console.warn('Failed to save to storage:', e);
    }
  }

  updateMeal(dayKey, mealType, value) {
    this.meals[dayKey][mealType] = value;
    this.saveToStorage();
  }

  updateMode(dayKey, mode) {
    this.meals[dayKey].mode = mode;
    if (mode === 'delivery') {
      this.meals[dayKey].side = "";
    }
    this.saveToStorage();
  }

  clearAll() {
    this.weekKeys.forEach(key => {
      if (this.meals[key]) {
        this.meals[key] = {
          lunch: "",
          dinner: "",
          side: "",
          mode: this.meals[key].mode
        };
      }
    });
    this.saveToStorage();
  }

  randomizeMeals() {
    this.weekKeys.forEach((key, index) => {
      if (index >= 5 && !this.weekendEnabled) return;

      const dayMeals = this.meals[key];
      const isWeekend = index >= 5;
      
      // Randomize lunch
      const lunchOptions = MEALS.lunch.filter(m => !m.includes('None') && !m.includes('Custom'));
      dayMeals.lunch = lunchOptions[Math.floor(Math.random() * lunchOptions.length)];
      
      // Randomize dinner based on mode
      let dinnerOptions;
      switch (dayMeals.mode) {
        case 'quick':
          dinnerOptions = MEALS.dinner.quick.filter(m => !m.includes('None') && !m.includes('Custom'));
          break;
        case 'delivery':
          dinnerOptions = MEALS.dinner.delivery.filter(m => !m.includes('None') && !m.includes('Custom'));
          break;
        default:
          dinnerOptions = isWeekend 
            ? MEALS.dinner.weekend.filter(m => !m.includes('None') && !m.includes('Custom'))
            : MEALS.dinner.regular.filter(m => !m.includes('None') && !m.includes('Custom'));
      }
      dayMeals.dinner = dinnerOptions[Math.floor(Math.random() * dinnerOptions.length)];
      
      // Randomize side (unless delivery)
      if (dayMeals.mode !== 'delivery') {
        const sideOptions = MEALS.side.filter(m => !m.includes('None') && !m.includes('Custom'));
        dayMeals.side = sideOptions[Math.floor(Math.random() * sideOptions.length)];
      }
    });
    
    this.saveToStorage();
  }

  generateGroceryList() {
    const ingredients = new Map();
    
    Object.values(this.meals).forEach(dayMeals => {
      ['lunch', 'dinner', 'side'].forEach(mealType => {
        const meal = dayMeals[mealType];
        if (meal && INGREDIENTS[meal]) {
          INGREDIENTS[meal].forEach(ingredient => {
            const count = ingredients.get(ingredient) || 0;
            ingredients.set(ingredient, count + 1);
          });
        }
      });
    });

    const categorized = {};
    Object.keys(STORE_CATEGORIES).forEach(category => {
      categorized[category] = [];
    });

    ingredients.forEach((count, ingredient) => {
      let placed = false;
      Object.entries(STORE_CATEGORIES).forEach(([category, items]) => {
        if (items.includes(ingredient)) {
          categorized[category].push({ name: ingredient, count });
          placed = true;
        }
      });
      
      if (!placed) {
        if (!categorized["🛒 Other"]) categorized["🛒 Other"] = [];
        categorized["🛒 Other"].push({ name: ingredient, count });
      }
    });

    // Remove empty categories
    Object.keys(categorized).forEach(category => {
      if (categorized[category].length === 0) {
        delete categorized[category];
      }
    });

    return categorized;
  }
}

/* ========= Enhanced UI Controller ========= */
class MealPlannerUI {
  constructor() {
    this.state = new MealPlannerState();
    this.initializeElements();
    this.bindEvents();
    this.render();
  }

  initializeElements() {
    this.elements = {
      weekendToggle: document.getElementById('weekendToggle'),
      clearBtn: document.getElementById('clearBtn'),
      dayGrid: document.getElementById('dayGrid'),
      dateRange: document.getElementById('dateRange'),
      shuffleBtn: document.getElementById('shuffleBtn'),
      groceryBtn: document.getElementById('groceryBtn'),
      shareBtn: document.getElementById('shareBtn'),
      overlay: document.getElementById('overlay'),
      mealPicker: document.getElementById('mealPicker'),
      pickerTitle: document.getElementById('pickerTitle'),
      mealOptions: document.getElementById('mealOptions'),
      customInputSection: document.getElementById('customInputSection'),
      customInput: document.getElementById('customInput'),
      customUseBtn: document.getElementById('customUseBtn'),
      pickerCloseBtn: document.getElementById('pickerCloseBtn'),
      grocerySheet: document.getElementById('grocerySheet'),
      groceryContent: document.getElementById('groceryContent'),
      groceryCopyBtn: document.getElementById('groceryCopyBtn'),
      groceryCloseBtn: document.getElementById('groceryCloseBtn'),
      shareSheet: document.getElementById('shareSheet'),
      shareText: document.getElementById('shareText'),
      shareCopyBtn: document.getElementById('shareCopyBtn'),
      shareCloseBtn: document.getElementById('shareCloseBtn')
    };
  }

  bindEvents() {
    // Weekend toggle
    this.elements.weekendToggle.addEventListener('click', () => {
      this.state.weekendEnabled = !this.state.weekendEnabled;
      this.state.saveToStorage();
      this.render();
    });

    // Clear all
    this.elements.clearBtn.addEventListener('click', () => {
      if (confirm('🗑️ Clear all meals? This cannot be undone.')) {
        this.state.clearAll();
        this.render();
      }
    });

    // Navigation buttons
    this.elements.shuffleBtn.addEventListener('click', () => {
      this.elements.shuffleBtn.style.transform = 'scale(0.95)';
      setTimeout(() => {
        this.elements.shuffleBtn.style.transform = '';
        this.state.randomizeMeals();
        this.render();
      }, 150);
    });

    this.elements.groceryBtn.addEventListener('click', () => this.showGrocerySheet());
    this.elements.shareBtn.addEventListener('click', () => this.showShareSheet());

    // Overlay close
    this.elements.overlay.addEventListener('click', () => this.closeAllSheets());

    // Picker events
    this.elements.customUseBtn.addEventListener('click', () => this.useCustomMeal());
    this.elements.pickerCloseBtn.addEventListener('click', () => this.closeMealPicker());

    // Grocery sheet events
    this.elements.groceryCopyBtn.addEventListener('click', () => this.copyGroceryList());
    this.elements.groceryCloseBtn.addEventListener('click', () => this.closeGrocerySheet());

    // Share sheet events
    this.elements.shareCopyBtn.addEventListener('click', () => this.copyShareText());
    this.elements.shareCloseBtn.addEventListener('click', () => this.closeShareSheet());

    // Custom input enter key
    this.elements.customInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        this.useCustomMeal();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        this.closeAllSheets();
      }
    });
  }

  render() {
    this.renderHeader();
    this.renderDayGrid();
    this.renderWeekendToggle();
  }

  renderHeader() {
    const endDate = new Date(this.state.weekStart);
    endDate.setDate(this.state.weekStart.getDate() + 6);
    
    this.elements.dateRange.textContent = 
      `${this.state.weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} – ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
  }

  renderWeekendToggle() {
    this.elements.weekendToggle.classList.toggle('active', this.state.weekendEnabled);
    this.elements.weekendToggle.setAttribute('aria-checked', this.state.weekendEnabled);
  }

  renderDayGrid() {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const dayEmojis = ['📅', '📅', '📅', '📅', '📅', '🎉', '🎉'];
    
    this.elements.dayGrid.innerHTML = '';

    this.state.weekKeys.forEach((key, index) => {
      if (index >= 5 && !this.state.weekendEnabled) return;

      const dayMeals = this.state.meals[key];
      const isWeekend = index >= 5;
      const date = new Date(this.state.weekStart);
      date.setDate(this.state.weekStart.getDate() + index);

      const dayCard = document.createElement('div');
      dayCard.className = 'day-card fade-in';
      dayCard.style.animationDelay = `${index * 0.1}s`;
      
      dayCard.innerHTML = `
        <div class="day-header">
          <div class="day-info">
            <h3>${dayEmojis[index]} ${days[index]}</h3>
            <div class="day-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
          </div>
        </div>

        <div class="meal-grid">
          <div class="meal-field" data-day="${key}" data-meal="lunch">
            <div class="meal-label">Lunch</div>
            <div class="meal-value ${!dayMeals.lunch ? 'meal-placeholder' : ''}">
              ${dayMeals.lunch || 'Tap to choose'}
            </div>
          </div>
          
          <div class="meal-field" data-day="${key}" data-meal="dinner">
            <div class="meal-label">Dinner</div>
            <div class="meal-value ${!dayMeals.dinner ? 'meal-placeholder' : ''}">
              ${dayMeals.dinner || 'Tap to choose'}
            </div>
          </div>
          
          <div class="meal-field ${dayMeals.mode === 'delivery' ? 'side-full' : ''}" 
               data-day="${key}" data-meal="side" 
               ${dayMeals.mode === 'delivery' ? 'style="opacity:0.5;pointer-events:none"' : ''}>
            <div class="meal-label">Side Dish</div>
            <div class="meal-value ${!dayMeals.side && dayMeals.mode !== 'delivery' ? 'meal-placeholder' : ''}">
              ${dayMeals.mode === 'delivery' ? 'Not needed for delivery' : (dayMeals.side || 'Tap to choose')}
            </div>
          </div>
        </div>

        <div class="mode-selector">
          <button class="mode-btn ${dayMeals.mode === 'regular' ? 'active' : ''}" 
                  data-day="${key}" data-mode="regular">Regular</button>
          <button class="mode-btn ${dayMeals.mode === 'quick' ? 'active' : ''}" 
                  data-day="${key}" data-mode="quick">Quick</button>
          <button class="mode-btn ${dayMeals.mode === 'delivery' ? 'active' : ''}" 
                  data-day="${key}" data-mode="delivery">Delivery</button>
        </div>
      `;

      this.elements.dayGrid.appendChild(dayCard);
    });

    // Add event listeners to meal fields and mode buttons
    this.elements.dayGrid.addEventListener('click', (e) => {
      const mealField = e.target.closest('.meal-field');
      const modeBtn = e.target.closest('.mode-btn');

      if (mealField && !mealField.style.pointerEvents) {
        const dayKey = mealField.dataset.day;
        const mealType = mealField.dataset.meal;
        this.showMealPicker(dayKey, mealType);
      } else if (modeBtn) {
        const dayKey = modeBtn.dataset.day;
        const mode = modeBtn.dataset.mode;
        this.state.updateMode(dayKey, mode);
        this.render();
      }
    });
  }

  showMealPicker(dayKey, mealType) {
    this.state.currentPicker = { dayKey, mealType };
    const dayMeals = this.state.meals[dayKey];
    const isWeekend = this.state.weekKeys.indexOf(dayKey) >= 5;

    this.elements.pickerTitle.textContent = `Choose ${mealType.charAt(0).toUpperCase() + mealType.slice(1)}`;
    
    let options = [];
    if (mealType === 'lunch') {
      options = MEALS.lunch;
    } else if (mealType === 'dinner') {
      switch (dayMeals.mode) {
        case 'quick': options = MEALS.dinner.quick; break;
        case 'delivery': options = MEALS.dinner.delivery; break;
        default: options = isWeekend ? MEALS.dinner.weekend : MEALS.dinner.regular;
      }
    } else {
      options = MEALS.side;
    }

    this.renderMealOptions(options, dayMeals[mealType]);
    this.showSheet(this.elements.mealPicker);
  }

  renderMealOptions(options, currentValue) {
    this.elements.mealOptions.innerHTML = '';
    this.elements.customInputSection.style.display = 'none';
    this.elements.customInput.value = '';

    options.forEach(option => {
      const optionEl = document.createElement('div');
      optionEl.className = `option-item ${option === currentValue ? 'selected' : ''}`;
      optionEl.textContent = option;
      
      optionEl.addEventListener('click', () => {
        if (option.includes('Custom…')) {
          this.elements.customInputSection.style.display = 'flex';
          this.elements.customInput.focus();
        } else {
          const value = option.includes('None') ? '' : option;
          this.updateCurrentMeal(value);
          this.closeMealPicker();
        }
      });

      this.elements.mealOptions.appendChild(optionEl);
    });
  }

  useCustomMeal() {
    const customValue = this.elements.customInput.value.trim();
    if (customValue) {
      this.updateCurrentMeal(customValue);
      this.closeMealPicker();
    }
  }

  updateCurrentMeal(value) {
    if (!this.state.currentPicker) return;
    
    const { dayKey, mealType } = this.state.currentPicker;
    this.state.updateMeal(dayKey, mealType, value);
    this.render();
  }

  showGrocerySheet() {
    const groceryList = this.state.generateGroceryList();
    this.renderGroceryList(groceryList);
    this.showSheet(this.elements.grocerySheet);
  }

  renderGroceryList(groceryList) {
    this.elements.groceryContent.innerHTML = '';

    if (Object.keys(groceryList).length === 0) {
      this.elements.groceryContent.innerHTML = `
        <div class="loading">
          <span>No ingredients found. Add some meals first! 🍽️</span>
        </div>
      `;
      return;
    }

    Object.entries(groceryList).forEach(([category, items]) => {
      const section = document.createElement('div');
      section.className = 'grocery-section';
      
      const title = document.createElement('h4');
      title.textContent = category;
      section.appendChild(title);

      items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'grocery-item';
        itemEl.innerHTML = `
          <input type="checkbox" id="item-${item.name}">
          <label for="item-${item.name}">
            ${item.name}${item.count > 1 ? ` ×${item.count}` : ''}
          </label>
        `;
        section.appendChild(itemEl);
      });

      this.elements.groceryContent.appendChild(section);
    });
  }

  showShareSheet() {
    const shareText = this.generateShareText();
    this.elements.shareText.textContent = shareText;
    this.showSheet(this.elements.shareSheet);
  }

  generateShareText() {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    let text = '✨ Weekly Meal Plan\n';
    
    const endDate = new Date(this.state.weekStart);
    endDate.setDate(this.state.weekStart.getDate() + 6);
    text += `${this.state.weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} – ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}\n\n`;

    this.state.weekKeys.forEach((key, index) => {
      if (index >= 5 && !this.state.weekendEnabled) return;
      
      const dayMeals = this.state.meals[key];
      text += `${days[index]}\n`;
      
      if (dayMeals.lunch) text += `  🥙 Lunch: ${dayMeals.lunch}\n`;
      if (dayMeals.dinner) {
        text += `  🍽️ Dinner: ${dayMeals.dinner}`;
        if (dayMeals.side) text += ` with ${dayMeals.side}`;
        text += '\n';
      }
      
      if (!dayMeals.lunch && !dayMeals.dinner) {
        text += '  (No meals planned)\n';
      }
      
      text += '\n';
    });

    // Add grocery list
    const groceryList = this.state.generateGroceryList();
    if (Object.keys(groceryList).length > 0) {
      text += '🛒 Grocery List\n\n';
      Object.entries(groceryList).forEach(([category, items]) => {
        text += `${category}\n`;
        items.forEach(item => {
          text += `• ${item.name}${item.count > 1 ? ` ×${item.count}` : ''}\n`;
        });
        text += '\n';
      });
    }

    return text.trim();
  }

  async copyGroceryList() {
    const groceryList = this.state.generateGroceryList();
    let text = '🛒 Grocery List\n\n';
    
    Object.entries(groceryList).forEach(([category, items]) => {
      text += `${category}\n`;
      items.forEach(item => {
        text += `• ${item.name}${item.count > 1 ? ` ×${item.count}` : ''}\n`;
      });
      text += '\n';
    });

    try {
      await navigator.clipboard.writeText(text.trim());
      this.elements.groceryCopyBtn.textContent = '✅ Copied!';
      setTimeout(() => {
        this.elements.groceryCopyBtn.innerHTML = '<span class="emoji">📋</span><span>Copy List</span>';
      }, 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  }

  async copyShareText() {
    try {
      await navigator.clipboard.writeText(this.elements.shareText.textContent);
      this.elements.shareCopyBtn.textContent = '✅ Copied!';
      setTimeout(() => {
        this.elements.shareCopyBtn.innerHTML = '<span class="emoji">📋</span><span>Copy Text</span>';
      }, 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  }

  showSheet(sheet) {
    this.elements.overlay.classList.add('show');
    sheet.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  hideSheet(sheet) {
    this.elements.overlay.classList.remove('show');
    sheet.classList.remove('show');
    document.body.style.overflow = '';
  }

  closeMealPicker() {
    this.hideSheet(this.elements.mealPicker);
    this.state.currentPicker = null;
  }

  closeGrocerySheet() {
    this.hideSheet(this.elements.grocerySheet);
  }

  closeShareSheet() {
    this.hideSheet(this.elements.shareSheet);
  }

  closeAllSheets() {
    this.closeMealPicker();
    this.closeGrocerySheet();
    this.closeShareSheet();
  }
}

/* ========= Initialize Application ========= */
document.addEventListener('DOMContentLoaded', () => {
  window.mealPlanner = new MealPlannerUI();
  
  // Add some delightful touches
  console.log('✨ Revolutionary Meal Planner loaded successfully!');
  
  // Simulate haptic feedback on supported devices
  if ('vibrate' in navigator) {
    document.addEventListener('click', (e) => {
      if (e.target.closest('.btn, .meal-field, .mode-btn')) {
        navigator.vibrate(10);
      }
    });
  }
});
</script>

</body>
</html>
