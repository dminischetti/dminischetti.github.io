<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="color-scheme" content="light dark">
<title>Weekly Meal Planner</title>
<style>
/* --- SF Pro Display Font Stack --- */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}

:root{
  /* iOS System Colors */
  --bg-primary:#f2f2f7;--bg-secondary:#ffffff;--bg-tertiary:#ffffff;
  --text-primary:#1d1d1f;--text-secondary:#86868b;--text-tertiary:#c7c7cc;
  --border-color:#c7c7cc;--border-secondary:#f2f2f7;
  
  /* iOS Semantic Colors */
  --blue:#007aff;--blue-light:#cce7ff;--blue-bg:#f0f8ff;
  --orange:#ff9500;--orange-light:#ffe0b3;--orange-bg:#fff8e1;
  --purple:#af52de;--purple-light:#e6ccff;--purple-bg:#faf0ff;
  --green:#34c759;--red:#ff3b30;--gray:#8e8e93;
  
  /* System Elements */
  --separator:#c6c6c8;--fill-quaternary:rgba(118,118,128,.08);
  --grouped-bg:#f2f2f7;--grouped-secondary:#ffffff;
  
  /* Elevation */
  --shadow-1:0 1px 3px rgba(0,0,0,.12), 0 1px 2px rgba(0,0,0,.24);
  --shadow-2:0 3px 6px rgba(0,0,0,.16), 0 3px 6px rgba(0,0,0,.23);
  --shadow-3:0 10px 20px rgba(0,0,0,.19), 0 6px 6px rgba(0,0,0,.23);
  
  --safe-area-top:env(safe-area-inset-top);
  --safe-area-bottom:env(safe-area-inset-bottom);
}

[data-theme="dark"]{
  --bg-primary:#000000;--bg-secondary:#1c1c1e;--bg-tertiary:#2c2c2e;
  --text-primary:#f2f2f7;--text-secondary:#98989d;--text-tertiary:#48484a;
  --border-color:#48484a;--border-secondary:#3a3a3c;
  
  --blue:#0a84ff;--blue-light:#002d52;--blue-bg:#001a33;
  --orange:#ff9f0a;--orange-light:#4d3800;--orange-bg:#2d2000;
  --purple:#bf5af2;--purple-light:#4d0052;--purple-bg:#2d0033;
  --green:#30d158;--red:#ff453a;--gray:#8e8e93;
  
  --separator:#38383a;--fill-quaternary:rgba(118,118,128,.16);
  --grouped-bg:#000000;--grouped-secondary:#1c1c1e;
  
  --shadow-1:0 1px 3px rgba(0,0,0,.5), 0 1px 2px rgba(0,0,0,.6);
  --shadow-2:0 3px 6px rgba(0,0,0,.6), 0 3px 6px rgba(0,0,0,.7);
  --shadow-3:0 10px 20px rgba(0,0,0,.8), 0 6px 6px rgba(0,0,0,.7);
}

/* Typography Scale */
.title-large{font-size:34px;font-weight:700;line-height:1.12;letter-spacing:-.5px}
.title-1{font-size:28px;font-weight:700;line-height:1.14;letter-spacing:-.3px}
.title-2{font-size:22px;font-weight:700;line-height:1.18;letter-spacing:-.2px}
.title-3{font-size:20px;font-weight:600;line-height:1.2}
.headline{font-size:17px;font-weight:600;line-height:1.24}
.body{font-size:17px;font-weight:400;line-height:1.41}
.callout{font-size:16px;font-weight:400;line-height:1.31}
.subhead{font-size:15px;font-weight:400;line-height:1.33}
.footnote{font-size:13px;font-weight:400;line-height:1.38}
.caption-1{font-size:12px;font-weight:400;line-height:1.33}
.caption-2{font-size:11px;font-weight:600;line-height:1.27;letter-spacing:.06em;text-transform:uppercase}

body{
  font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','SF Pro Text',system-ui,sans-serif;
  background:var(--bg-primary);min-height:100vh;color:var(--text-primary);
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  overscroll-behavior:none;
}

/* Navigation Header */
.nav-header{
  background:var(--bg-secondary);
  padding-top:var(--safe-area-top);
  position:sticky;top:0;z-index:1000;
  border-bottom:0.33px solid var(--separator);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
}

.nav-content{padding:8px 20px 12px}
.nav-title{
  font-size:34px;font-weight:700;line-height:1.12;letter-spacing:-.5px;
  color:var(--text-primary);margin-bottom:8px
}

.nav-controls{display:flex;align-items:center;justify-content:space-between}
.week-selector{display:flex;background:var(--fill-quaternary);border-radius:10px;padding:2px}
.week-option{
  padding:6px 16px;border:none;background:transparent;
  color:var(--text-secondary);font-size:15px;font-weight:500;
  border-radius:8px;transition:all .2s cubic-bezier(.25,.46,.45,.94);
  min-width:60px
}
.week-option.active{
  background:var(--bg-secondary);color:var(--text-primary);
  box-shadow:0 1px 3px rgba(0,0,0,.12);font-weight:600
}

.theme-toggle{
  width:36px;height:36px;border:none;background:var(--fill-quaternary);
  border-radius:18px;display:flex;align-items:center;justify-content:center;
  font-size:18px;transition:all .2s cubic-bezier(.25,.46,.45,.94)
}
.theme-toggle:active{transform:scale(.95)}

/* Week View */
.week-container{
  background:var(--bg-primary);
  padding:0 20px 120px;
}

.week-header{
  padding:20px 0 16px;
  display:flex;align-items:center;justify-content:space-between;
}
.week-title{font-size:22px;font-weight:700;color:var(--text-primary)}
.week-range{font-size:15px;color:var(--text-secondary);font-weight:500}

/* Day Cards */
.days-grid{display:flex;flex-direction:column;gap:12px}
.day-card{
  background:var(--bg-secondary);
  border-radius:16px;
  box-shadow:var(--shadow-1);
  overflow:hidden;
  transition:all .3s cubic-bezier(.25,.46,.45,.94);
  border:0.33px solid var(--separator);
}
.day-card:active{transform:scale(.98);box-shadow:var(--shadow-2)}
.day-card.weekend{background:var(--fill-quaternary)}

.day-header{
  padding:16px 20px 12px;
  border-bottom:0.33px solid var(--separator);
  background:linear-gradient(135deg, var(--bg-secondary) 0%, rgba(0,0,0,.01) 100%);
}
.day-header-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px}
.day-name{font-size:20px;font-weight:600;color:var(--text-primary);line-height:1.2}
.day-date{font-size:13px;color:var(--text-secondary);font-weight:500;margin-top:2px}

.day-status{display:flex;align-items:center;gap:8px}
.status-indicator{
  width:8px;height:8px;border-radius:4px;
  background:var(--green);opacity:0;
  transition:opacity .3s cubic-bezier(.25,.46,.45,.94)
}
.day-card.has-meals .status-indicator{opacity:1}
.status-badge{
  padding:4px 8px;border-radius:8px;
  font-size:11px;font-weight:600;
  text-transform:uppercase;letter-spacing:.05em
}
.badge-quick{background:var(--orange-light);color:var(--orange)}
.badge-delivery{background:var(--purple-light);color:var(--purple)}
.badge-locked{background:var(--red);color:white;font-size:10px}

.day-meals{padding:16px 20px}
.meal-preview{display:flex;flex-direction:column;gap:8px}
.meal-item{display:flex;align-items:center;gap:12px}
.meal-icon{
  width:24px;height:24px;border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;flex-shrink:0
}
.meal-icon.lunch{background:var(--orange-bg);color:var(--orange)}
.meal-icon.dinner{background:var(--blue-bg);color:var(--blue)}
.meal-icon.side{background:var(--purple-bg);color:var(--purple)}

.meal-text{flex:1}
.meal-name{font-size:15px;color:var(--text-primary);line-height:1.33}
.meal-empty{font-size:15px;color:var(--text-secondary);font-style:italic}

.chevron-right{
  color:var(--text-tertiary);font-size:14px;
  transform:translateX(0);
  transition:transform .2s cubic-bezier(.25,.46,.45,.94)
}
.day-card:active .chevron-right{transform:translateX(4px)}

/* Weekend Toggle */
.settings-section{
  background:var(--bg-secondary);
  margin:20px 20px 0;border-radius:16px;
  border:0.33px solid var(--separator);
  overflow:hidden
}
.setting-item{
  padding:16px 20px;
  display:flex;align-items:center;justify-content:space-between;
  background:var(--bg-secondary)
}
.setting-label{font-size:17px;color:var(--text-primary);font-weight:400}
.ios-switch{
  width:51px;height:31px;background:var(--separator);
  border-radius:16px;position:relative;
  transition:background .25s cubic-bezier(.25,.46,.45,.94);
  box-shadow:inset 0 0 0 1px rgba(0,0,0,.04)
}
.ios-switch.active{background:var(--green)}
.ios-switch::after{
  content:'';position:absolute;width:27px;height:27px;
  background:#ffffff;border-radius:14px;top:2px;left:2px;
  transition:transform .25s cubic-bezier(.25,.46,.45,.94);
  box-shadow:0 3px 8px rgba(0,0,0,.15), 0 3px 1px rgba(0,0,0,.06)
}
.ios-switch.active::after{transform:translateX(20px)}

/* Day Editor Modal */
.day-editor{
  position:fixed;inset:0;z-index:2000;
  background:var(--bg-primary);
  display:none;flex-direction:column;
  transform:translateX(100%);
  transition:transform .35s cubic-bezier(.32,.72,0,1)
}
.day-editor.show{display:flex;transform:translateX(0)}

.editor-nav{
  background:var(--bg-secondary);
  padding-top:var(--safe-area-top);
  padding-bottom:12px;
  border-bottom:0.33px solid var(--separator);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)
}
.editor-nav-content{
  padding:8px 20px;
  display:flex;align-items:center;justify-content:space-between
}
.nav-button{
  padding:8px 12px;border:none;background:transparent;
  font-size:17px;font-weight:600;border-radius:10px;
  transition:all .2s cubic-bezier(.25,.46,.45,.94);
  min-width:60px;text-align:center
}
.nav-button.close{color:var(--blue)}
.nav-button.done{background:var(--blue);color:white}
.nav-button:active{transform:scale(.95)}

.editor-title{text-align:center;flex:1;margin:0 16px}
.editor-title h2{font-size:20px;font-weight:600;color:var(--text-primary)}
.editor-title p{font-size:13px;color:var(--text-secondary);margin-top:1px;font-weight:500}

.editor-content{
  flex:1;overflow-y:auto;
  padding:20px;-webkit-overflow-scrolling:touch
}

/* Meal Cards in Editor */
.meal-card{
  background:var(--bg-secondary);
  border-radius:16px;margin-bottom:16px;
  border:0.33px solid var(--separator);
  overflow:hidden;box-shadow:var(--shadow-1)
}

.meal-card-header{
  padding:16px 20px 12px;
  border-bottom:0.33px solid var(--separator);
  display:flex;align-items:center;justify-content:space-between
}
.meal-type-info{display:flex;align-items:center;gap:12px}
.meal-type-icon{
  width:28px;height:28px;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:14px;font-weight:600
}
.meal-type-title{font-size:17px;font-weight:600;color:var(--text-primary)}

.lunch-card .meal-type-icon{background:var(--orange);color:white}
.lunch-card .meal-card-header{background:linear-gradient(135deg, var(--orange-bg) 0%, var(--bg-secondary) 100%)}

.dinner-card .meal-type-icon{background:var(--blue);color:white}
.dinner-card .meal-card-header{background:linear-gradient(135deg, var(--blue-bg) 0%, var(--bg-secondary) 100%)}

.side-card .meal-type-icon{background:var(--purple);color:white}
.side-card .meal-card-header{background:linear-gradient(135deg, var(--purple-bg) 0%, var(--bg-secondary) 100%)}

/* Mode Selector */
.mode-selector{
  padding:0 20px 16px;
  display:flex;gap:8px
}
.mode-button{
  flex:1;padding:8px 12px;border:1.5px solid var(--separator);
  background:var(--bg-secondary);border-radius:12px;
  font-size:13px;font-weight:600;color:var(--text-secondary);
  transition:all .2s cubic-bezier(.25,.46,.45,.94);
  display:flex;align-items:center;justify-content:center;gap:4px
}
.mode-button.active{
  border-color:var(--blue);background:var(--blue);color:white
}
.mode-button.quick.active{
  border-color:var(--orange);background:var(--orange)
}
.mode-button.delivery.active{
  border-color:var(--purple);background:var(--purple)
}

/* Input Fields */
.input-section{padding:16px 20px}
.input-field{
  width:100%;height:50px;
  padding:0 50px 0 16px;
  border:1.5px solid var(--separator);
  border-radius:12px;background:var(--bg-secondary);
  font-size:17px;color:var(--text-primary);
  font-weight:400;transition:all .2s cubic-bezier(.25,.46,.45,.94);
  position:relative
}
.input-field:focus{
  outline:none;border-color:var(--blue);
  box-shadow:0 0 0 4px rgba(0,122,255,.08)
}
.input-field::placeholder{color:var(--text-secondary)}

.input-container{position:relative}
.shuffle-button{
  position:absolute;right:8px;top:8px;
  width:34px;height:34px;border:none;
  border-radius:8px;background:var(--fill-quaternary);
  display:flex;align-items:center;justify-content:center;
  font-size:16px;color:var(--text-secondary);
  transition:all .2s cubic-bezier(.25,.46,.45,.94)
}
.shuffle-button:active{
  transform:scale(.9);background:var(--blue);color:white
}

/* Day Actions */
.day-actions{
  padding:16px 20px 20px;
  display:grid;grid-template-columns:1fr 1fr;
  gap:12px
}
.action-button{
  height:50px;border:1.5px solid var(--separator);
  background:var(--bg-secondary);border-radius:12px;
  font-size:15px;font-weight:600;color:var(--text-primary);
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .2s cubic-bezier(.25,.46,.45,.94)
}
.action-button:active{transform:scale(.95)}
.action-button.danger{
  background:var(--red);color:white;border-color:var(--red)
}
.action-button.locked{
  background:var(--red);color:white;border-color:var(--red)
}

/* Meal Picker */
.picker-backdrop{
  position:fixed;inset:0;z-index:3000;
  background:rgba(0,0,0,.4);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  display:none;opacity:0;
  transition:opacity .3s cubic-bezier(.25,.46,.45,.94)
}
.picker-backdrop.show{display:flex;opacity:1}

.meal-picker{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--bg-secondary);
  border-radius:16px 16px 0 0;
  max-height:70vh;z-index:3001;
  transform:translateY(100%);
  transition:transform .4s cubic-bezier(.32,.72,0,1);
  box-shadow:var(--shadow-3)
}
.meal-picker.show{transform:translateY(0)}

.picker-header{
  padding:12px 20px 16px;
  border-bottom:0.33px solid var(--separator);
  text-align:center;position:relative
}
.picker-handle{
  width:36px;height:5px;background:var(--text-tertiary);
  border-radius:3px;margin:0 auto 12px;opacity:.5
}
.picker-title{
  font-size:20px;font-weight:600;color:var(--text-primary)
}
.picker-done{
  position:absolute;right:20px;top:16px;
  background:var(--blue);color:white;
  padding:8px 16px;border:none;border-radius:20px;
  font-size:15px;font-weight:600;
  transition:all .2s cubic-bezier(.25,.46,.45,.94)
}
.picker-done:active{transform:scale(.95)}

.picker-options{
  max-height:400px;overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding-bottom:var(--safe-area-bottom)
}
.picker-option{
  padding:16px 20px;border-bottom:0.33px solid var(--separator);
  font-size:17px;color:var(--text-primary);
  background:var(--bg-secondary);
  transition:background .2s cubic-bezier(.25,.46,.45,.94);
  display:flex;align-items:center;justify-content:space-between
}
.picker-option:active{background:var(--fill-quaternary)}
.picker-option.selected{
  background:var(--blue-bg);color:var(--blue);font-weight:600
}
.picker-option.special{
  color:var(--blue);font-weight:600;
  background:linear-gradient(135deg, var(--blue-bg) 0%, var(--bg-secondary) 100%)
}

/* Tab Bar */
.tab-bar{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--bg-secondary);
  border-top:0.33px solid var(--separator);
  padding-bottom:var(--safe-area-bottom);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  z-index:1000
}
.tab-content{
  display:flex;padding:8px 0 4px
}
.tab-item{
  flex:1;padding:8px 4px;border:none;background:transparent;
  display:flex;flex-direction:column;align-items:center;gap:4px;
  transition:all .2s cubic-bezier(.25,.46,.45,.94)
}
.tab-item:active{transform:scale(.9)}
.tab-icon{font-size:22px;line-height:1}
.tab-label{font-size:10px;font-weight:500;color:var(--text-secondary);line-height:1}

.tab-item.shuffle{color:var(--orange)}
.tab-item.grocery{color:var(--green)}
.tab-item.share{color:var(--blue)}
.tab-item.clear{color:var(--red)}

/* Modals */
.modal{
  position:fixed;inset:0;z-index:4000;
  background:rgba(0,0,0,.4);backdrop-filter:blur(20px);
  display:none;align-items:flex-end;
  transition:opacity .3s cubic-bezier(.25,.46,.45,.94)
}
.modal.show{display:flex}
.modal-content{
  width:100%;max-height:80vh;
  background:var(--bg-secondary);
  border-radius:16px 16px 0 0;
  display:flex;flex-direction:column;
  box-shadow:var(--shadow-3)
}
.modal-header{
  padding:12px 20px 16px;
  border-bottom:0.33px solid var(--separator);
  text-align:center
}
.modal-handle{
  width:36px;height:5px;background:var(--text-tertiary);
  border-radius:3px;margin:0 auto 12px;opacity:.5
}
.modal-title{
  font-size:20px;font-weight:600;color:var(--text-primary)
}
.modal-body{
  flex:1;overflow-y:auto;padding:20px;
  -webkit-overflow-scrolling:touch
}
.modal-actions{
  padding:16px 20px;display:flex;gap:12px;
  border-top:0.33px solid var(--separator)
}
.modal-button{
  flex:1;height:50px;border:none;border-radius:12px;
  font-size:17px;font-weight:600;
  transition:all .2s cubic-bezier(.25,.46,.45,.94)
}
.modal-button.primary{background:var(--blue);color:white}
.modal-button.secondary{
  background:var(--fill-quaternary);color:var(--text-primary);
  border:1.5px solid var(--separator)
}
.modal-button:active{transform:scale(.95)}

/* Animations */
@keyframes slideInRight{
  from{transform:translateX(100%)}
  to{transform:translateX(0)}
}
@keyframes slideOutRight{
  from{transform:translateX(0)}
  to{transform:translateX(100%)}
}
@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}
@keyframes bounce{
  0%,20%,53%,80%,100%{transform:scale3d(1,1,1)}
  40%,43%{transform:scale3d(1.1,1.1,1.1)}
  70%{transform:scale3d(1.05,1.05,1.05)}
  90%{transform:scale3d(1.02,1.02,1.02)}
}

.animate-slide-in{animation:slideInRight .35s cubic-bezier(.32,.72,0,1)}
.animate-slide-out{animation:slideOutRight .35s cubic-bezier(.32,.72,0,1)}
.animate-fade-in{animation:fadeIn .3s cubic-bezier(.25,.46,.45,.94)}
.animate-bounce{animation:bounce .6s cubic-bezier(.25,.46,.45,.94)}

/* Responsive */
@media (max-width: 375px){
  .nav-content{padding-left:16px;padding-right:16px}
  .week-container{padding-left:16px;padding-right:16px}
}

/* Accessibility */
@media (prefers-reduced-motion: reduce){
  *{animation:none!important;transition:none!important}
}
@media (prefers-contrast: high){
  :root{
    --separator:#000000;
    --border-color:#000000
  }
  [data-theme="dark"]{
    --separator:#ffffff;
    --border-color:#ffffff
  }
}

/* Focus states for accessibility */
button:focus-visible{
  outline:2px solid var(--blue);
  outline-offset:2px
}

/* Touch feedback */
.touch-feedback{
  transition:all .15s cubic-bezier(.25,.46,.45,.94)
}
.touch-feedback:active{
  transform:scale(.96);
  opacity:.8
}

/* Utility classes */
.no-scroll{overflow:hidden;position:fixed;width:100%}
.text-selectable{-webkit-user-select:text;user-select:text}
.haptic{will-change:transform}
</style>
</head>
<body>
  <!-- Navigation Header -->
  <header class="nav-header">
    <div class="nav-content">
      <h1 class="nav-title">Meals</h1>
      <div class="nav-controls">
        <div class="week-selector">
          <button class="week-option" id="thisWeek" onclick="selectWeek('this')">This Week</button>
          <button class="week-option active" id="nextWeek" onclick="selectWeek('next')">Next Week</button>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" aria-label="Toggle theme">◐</button>
      </div>
    </div>
  </header>

  <!-- Week Container -->
  <main class="week-container">
    <div class="week-header">
      <div class="week-title">Plan Your Week</div>
      <div class="week-range" id="weekRange">Sep 2 - Sep 8</div>
    </div>
    
    <div class="days-grid" id="daysGrid">
      <!-- Days will be rendered here -->
    </div>
    
    <!-- Settings -->
    <section class="settings-section">
      <div class="setting-item">
        <span class="setting-label">Include Weekend</span>
        <div class="ios-switch" id="weekendToggle" role="switch" aria-checked="false" onclick="toggleWeekend()"></div>
      </div>
    </section>
  </main>

  <!-- Day Editor Modal -->
  <div class="day-editor" id="dayEditor">
    <nav class="editor-nav">
      <div class="editor-nav-content">
        <button class="nav-button close" onclick="closeDayEditor()">Cancel</button>
        <div class="editor-title">
          <h2 id="editorDayName">Monday</h2>
          <p id="editorDayDate">Sep 2</p>
        </div>
        <button class="nav-button done" onclick="closeDayEditor()">Done</button>
      </div>
    </nav>
    
    <div class="editor-content" id="editorContent">
      <!-- Editor content will be populated dynamically -->
    </div>
  </div>

  <!-- Meal Picker -->
  <div class="picker-backdrop" id="pickerBackdrop" onclick="closePicker()">
    <div class="meal-picker" id="mealPicker" onclick="event.stopPropagation()">
      <div class="picker-header">
        <div class="picker-handle"></div>
        <h3 class="picker-title" id="pickerTitle">Select Meal</h3>
        <button class="picker-done" onclick="closePicker()">Done</button>
      </div>
      <div class="picker-options" id="pickerOptions">
        <!-- Options will be populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Tab Bar -->
  <nav class="tab-bar">
    <div class="tab-content">
      <button class="tab-item shuffle" onclick="shuffleAll()">
        <span class="tab-icon">↻</span>
        <span class="tab-label">Shuffle</span>
      </button>
      <button class="tab-item grocery" onclick="showGrocery()">
        <span class="tab-icon">☰</span>
        <span class="tab-label">List</span>
      </button>
      <button class="tab-item share" onclick="sharePlan()">
        <span class="tab-icon">↗</span>
        <span class="tab-label">Share</span>
      </button>
      <button class="tab-item clear" onclick="clearAll()">
        <span class="tab-icon">⌫</span>
        <span class="tab-label">Clear</span>
      </button>
    </div>
  </nav>

  <!-- Grocery Modal -->
  <div class="modal" id="groceryModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-handle"></div>
        <h3 class="modal-title">Shopping List</h3>
      </div>
      <div class="modal-body" id="groceryList"></div>
      <div class="modal-actions">
        <button class="modal-button secondary" onclick="closeModal('groceryModal')">Close</button>
        <button class="modal-button primary" onclick="shareGrocery()">Share List</button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div class="modal" id="shareModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-handle"></div>
        <h3 class="modal-title">Share Meal Plan</h3>
      </div>
      <div class="modal-body">
        <div class="text-selectable" id="shareText" style="font-family:ui-monospace,monospace;font-size:14px;line-height:1.5;padding:16px;background:var(--fill-quaternary);border-radius:12px"></div>
      </div>
      <div class="modal-actions">
        <button class="modal-button secondary" onclick="closeModal('shareModal')">Close</button>
        <button class="modal-button primary" onclick="copyText(this)">Copy</button>
      </div>
    </div>
  </div>

<script>
// App Configuration
const meals = {
  lunch: [
    "Ravioli burro e salvia","Spaghetti al limone","Pasta e ceci","Pasta col tonno",
    "Pasta sugo tonno","Piadine prosciutto provolone","Uova fritte","Pasta al pesto",
    "Pasta coi pomodorini","Lenticchie","Spaghetti aglio e olio","Carbonara",
    "Frittata di pasta","Pasta e fagioli"
  ],
  dinner: {
    regular: [
      "Salmone col riso","Frittata di zucchine","Polpette","Pollo al limone","Merluzzo",
      "Hamburger","Cotolette","Salsicce","Minestrone","Pollo al forno","Scaloppine al limone","Caprese"
    ],
    quick: ["Cordon bleu","Würstel","Dumplings","Fish sticks","Pollo allo spiedo"],
    delivery: ["Pizza Delivery","Greco Delivery","Chinese Delivery","Vietnamese Delivery","Ramen Delivery"],
    weekend: [
      "Pasta al forno","Parmigiana di melanzane","Zucchine ripiene","Lasagna","Spezzatino con patate",
      "Tortellini con la panna","Tortellini col sugo","Pasta col ragù","Polpettone","Scrimpelle mbuss",
      "Polenta col sugo","Cannelloni","Bistecca"
    ],
    other: ["Colacena"]
  },
  side: [
    "Purè di patate","Broccoli al vapore","Insalata di pomodori","Tater tots","Barbabietole",
    "Insalata di mais","Patate lesse","Carote al forno","Carote a insalata","Zucchine trifolate",
    "Insalata di cetrioli","Insalata"
  ]
};

const ingredients = {
  "Ravioli burro e salvia": ["Ravioli","Sage"],
  "Spaghetti al limone": ["Spaghetti","Lemons"],
  "Pasta e ceci": ["Ditalini","Chickpeas"],
  "Pasta col tonno": ["Spaghetti","Tuna"],
  "Pasta sugo tonno": ["Pasta","Tuna","Tomato sauce"],
  "Piadine prosciutto provolone": ["Flatbreads","Prosciutto","Provolone cheese"],
  "Uova fritte": ["Eggs"],
  "Pasta al pesto": ["Pasta","Pesto"],
  "Pasta coi pomodorini": ["Pasta","Cherry tomatoes"],
  "Lenticchie": ["Lentils","Croutons"],
  "Spaghetti aglio e olio": ["Spaghetti"],
  "Carbonara": ["Spaghetti","Eggs","Bacon"],
  "Frittata di pasta": ["Eggs"],
  "Pasta e fagioli": ["Pasta","Beans"],
  "Salmone col riso": ["Salmon","Rice"],
  "Frittata di zucchine": ["Eggs","Zucchini"],
  "Polpette": ["Ground beef","Eggs","Bread","Breadcrumbs"],
  "Pollo al limone": ["Chicken breast","Lemons"],
  "Merluzzo": ["Cod"],
  "Hamburger": ["Buns","Hamburger buns","American cheese slices","Lettuce","Tomatoes"],
  "Cotolette": ["Breaded cutlets","Breadcrumbs","Eggs"],
  "Salsicce": ["Sausages"],
  "Minestrone": ["Vegetable soup mix","Pasta","Beans"],
  "Pollo al forno": ["Chicken thighs"],
  "Scaloppine al limone": ["Veal cutlets","Lemons"],
  "Caprese": ["Fresh mozzarella","Tomatoes"],
  "Cordon bleu": ["Cordon bleu"],
  "Würstel": ["Hot dogs"],
  "Dumplings": ["Dumplings"],
  "Fish sticks": ["Fish sticks"],
  "Pollo allo spiedo": ["Whole chicken"],
  "Pasta al forno": ["Pasta","Tomato sauce","Shredded mozzarella"],
  "Parmigiana di melanzane": ["Eggplant","Tomato sauce","Shredded mozzarella"],
  "Zucchine ripiene": ["Zucchini","Ground beef","Bread"],
  "Lasagna": ["Lasagna noodles","Meat sauce"],
  "Spezzatino con patate": ["Beef","Potatoes","Onion","Carrots"],
  "Tortellini con la panna": ["Tortellini","Cream"],
  "Tortellini col sugo": ["Tortellini","Tomato sauce"],
  "Pasta col ragù": ["Pasta","Meat sauce"],
  "Polpettone": ["Ground beef","Eggs","Bacon","Bread"],
  "Scrimpelle mbuss": ["Eggs","Flour","Milk","Broth"],
  "Polenta col sugo": ["Polenta","Tomato sauce","Sausages"],
  "Cannelloni": ["Cannelloni","Ricotta","Spinach"],
  "Bistecca": ["Steak"],
  "Purè di patate": ["Potatoes"],
  "Broccoli al vapore": ["Broccoli"],
  "Insalata di pomodori": ["Tomatoes"],
  "Tater tots": ["Tater tots"],
  "Barbabietole": ["Beets"],
  "Insalata di mais": ["Corn"],
  "Patate lesse": ["Potatoes"],
  "Carote al forno": ["Carrots"],
  "Carote a insalata": ["Carrots"],
  "Zucchine trifolate": ["Zucchini"],
  "Insalata di cetrioli": ["Cucumbers"],
  "Insalata": ["Lettuce"],
};

// App State
let data = {};
let week = 'next';
let weekendEnabled = {};
let lockedDays = {};
let dinnerModes = {};
let currentEditingDay = null;
let currentPicker = null;

// App Initialization
function init() {
  loadData();
  updateWeekSelector();
  updateWeekRange();
  renderDays();
  updateWeekendToggle();
  setTheme();
  setupEventListeners();
}

function setupEventListeners() {
  // Swipe gestures for day editor
  let startX = 0;
  const dayEditor = document.getElementById('dayEditor');
  
  dayEditor.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
  }, { passive: true });
  
  dayEditor.addEventListener('touchmove', e => {
    const currentX = e.touches[0].clientX;
    const diffX = currentX - startX;
    if (diffX > 50) {
      dayEditor.style.transform = `translateX(${Math.min(diffX - 50, 100)}px)`;
    }
  }, { passive: true });
  
  dayEditor.addEventListener('touchend', e => {
    const currentX = e.changedTouches[0].clientX;
    const diffX = currentX - startX;
    if (diffX > 100) {
      closeDayEditor();
    } else {
      dayEditor.style.transform = '';
    }
  }, { passive: true });

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      if (currentPicker) closePicker();
      else if (currentEditingDay) closeDayEditor();
      else closeAllModals();
    }
  });
}

function updateWeekSelector() {
  document.getElementById('thisWeek').classList.toggle('active', week === 'this');
  document.getElementById('nextWeek').classList.toggle('active', week === 'next');
}

function updateWeekRange() {
  const start = getWeekStart();
  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  const format = { month: 'short', day: 'numeric' };
  document.getElementById('weekRange').textContent = 
    `${start.toLocaleDateString('en', format)} - ${end.toLocaleDateString('en', format)}`;
}

function renderDays() {
  const container = document.getElementById('daysGrid');
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  const start = getWeekStart();

  container.innerHTML = days.map((dayName, index) => {
    if (index >= 5 && !weekendEnabled[week]) return '';
    
    const dayKey = getDayKey(index, start);
    const dayData = data[dayKey] || { lunch: '', dinner: '', side: '' };
    const isWeekend = index >= 5;
    const isLocked = lockedDays[dayKey];
    const mode = dinnerModes[dayKey] || 'regular';
    const hasMeals = dayData.lunch || dayData.dinner;
    const date = getDateForIndex(index, start);

    let statusBadges = '';
    if (isLocked) statusBadges += '<span class="status-badge badge-locked">🔒 Locked</span>';
    if (mode === 'quick') statusBadges += '<span class="status-badge badge-quick">⚡ Quick</span>';
    if (mode === 'delivery') statusBadges += '<span class="status-badge badge-delivery">🚚 Delivery</span>';

    let mealsPreview = '';
    if (hasMeals) {
      const mealItems = [];
      if (dayData.lunch) {
        mealItems.push(`
          <div class="meal-item">
            <div class="meal-icon lunch">L</div>
            <div class="meal-text">
              <div class="meal-name">${dayData.lunch}</div>
            </div>
          </div>
        `);
      }
      if (dayData.dinner) {
        let dinnerText = dayData.dinner;
        if (dayData.side && mode !== 'delivery') {
          dinnerText += ` with ${dayData.side}`;
        }
        mealItems.push(`
          <div class="meal-item">
            <div class="meal-icon dinner">D</div>
            <div class="meal-text">
              <div class="meal-name">${dinnerText}</div>
            </div>
          </div>
        `);
      }
      mealsPreview = mealItems.join('');
    } else {
      mealsPreview = `
        <div class="meal-item">
          <div class="meal-text">
            <div class="meal-empty">Tap to plan meals</div>
          </div>
        </div>
      `;
    }

    return `
      <div class="day-card ${isWeekend ? 'weekend' : ''} ${hasMeals ? 'has-meals' : ''}" onclick="openDayEditor('${dayKey}')">
        <div class="day-header">
          <div class="day-header-top">
            <div>
              <div class="day-name">${dayName}</div>
              <div class="day-date">${date.toLocaleDateString('en', { month: 'short', day: 'numeric' })}</div>
            </div>
            <div class="day-status">
              <div class="status-indicator"></div>
              ${statusBadges}
              <div class="chevron-right">›</div>
            </div>
          </div>
        </div>
        <div class="day-meals">
          <div class="meal-preview">
            ${mealsPreview}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function openDayEditor(dayKey) {
  currentEditingDay = dayKey;
  const editor = document.getElementById('dayEditor');
  const content = document.getElementById('editorContent');
  
  // Set header info
  const dayIndex = getDayIndex(dayKey);
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  const date = getDateForIndex(dayIndex);
  
  document.getElementById('editorDayName').textContent = days[dayIndex];
  document.getElementById('editorDayDate').textContent = date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
  
  renderDayEditor(dayKey);
  
  editor.classList.add('show', 'animate-slide-in');
  document.body.classList.add('no-scroll');
  
  // Haptic feedback
  if (navigator.vibrate) navigator.vibrate(10);
}

function closeDayEditor() {
  const editor = document.getElementById('dayEditor');
  editor.classList.remove('show');
  document.body.classList.remove('no-scroll');
  currentEditingDay = null;
  renderDays(); // Update main view
  
  if (navigator.vibrate) navigator.vibrate(5);
}

function renderDayEditor(dayKey) {
  const content = document.getElementById('editorContent');
  const dayData = data[dayKey] || { lunch: '', dinner: '', side: '' };
  const isWeekend = getDayIndex(dayKey) >= 5;
  const isLocked = lockedDays[dayKey];
  const mode = dinnerModes[dayKey] || 'regular';
  const showSideDish = mode !== 'delivery';

  content.innerHTML = `
    <!-- Lunch Card -->
    <div class="meal-card lunch-card">
      <div class="meal-card-header">
        <div class="meal-type-info">
          <div class="meal-type-icon">L</div>
          <div class="meal-type-title">Lunch</div>
        </div>
      </div>
      <div class="input-section">
        <div class="input-container">
          <input type="text" class="input-field" value="${dayData.lunch}" placeholder="Select lunch meal..." readonly onclick="openPicker('${dayKey}', 'lunch')">
          <button class="shuffle-button" onclick="shuffleMeal('${dayKey}', 'lunch', this)">↻</button>
        </div>
      </div>
    </div>

    <!-- Dinner Card -->
    <div class="meal-card dinner-card">
      <div class="meal-card-header">
        <div class="meal-type-info">
          <div class="meal-type-icon">D</div>
          <div class="meal-type-title">Dinner</div>
        </div>
      </div>
      ${!isWeekend ? `
        <div class="mode-selector">
          <button class="mode-button ${mode === 'regular' ? 'active' : ''}" onclick="setDinnerMode('${dayKey}', 'regular')">🍽️ Regular</button>
          <button class="mode-button quick ${mode === 'quick' ? 'active' : ''}" onclick="setDinnerMode('${dayKey}', 'quick')">⚡ Quick</button>
          <button class="mode-button delivery ${mode === 'delivery' ? 'active' : ''}" onclick="setDinnerMode('${dayKey}', 'delivery')">🚚 Delivery</button>
        </div>
      ` : ''}
      <div class="input-section">
        <div class="input-container">
          <input type="text" class="input-field" value="${dayData.dinner}" placeholder="Select dinner meal..." readonly onclick="openPicker('${dayKey}', 'dinner')">
          <button class="shuffle-button" onclick="shuffleMeal('${dayKey}', 'dinner', this)">↻</button>
        </div>
      </div>
    </div>

    ${showSideDish ? `
      <!-- Side Card -->
      <div class="meal-card side-card">
        <div class="meal-card-header">
          <div class="meal-type-info">
            <div class="meal-type-icon">S</div>
            <div class="meal-type-title">Side Dish</div>
          </div>
        </div>
        <div class="input-section">
          <div class="input-container">
            <input type="text" class="input-field" value="${dayData.side}" placeholder="Select side dish..." readonly onclick="openPicker('${dayKey}', 'side')">
            <button class="shuffle-button" onclick="shuffleMeal('${dayKey}', 'side', this)">↻</button>
          </div>
        </div>
      </div>
    ` : ''}

    <!-- Day Actions -->
    <div class="day-actions">
      <button class="action-button ${isLocked ? 'locked' : ''}" onclick="toggleDayLock('${dayKey}')">
        ${isLocked ? '🔒 Locked' : '🔓 Lock Day'}
      </button>
      <button class="action-button" onclick="shuffleEntireDay('${dayKey}')">
        ↻ Shuffle All
      </button>
      <button class="action-button danger" onclick="clearDay('${dayKey}')">
        ⌫ Clear Day
      </button>
      <button class="action-button" onclick="closeDayEditor()">
        ✓ Done
      </button>
    </div>
  `;
}

function openPicker(dayKey, mealType) {
  currentPicker = { dayKey, mealType };
  const picker = document.getElementById('mealPicker');
  const backdrop = document.getElementById('pickerBackdrop');
  const title = document.getElementById('pickerTitle');
  const options = document.getElementById('pickerOptions');
  
  title.textContent = `Select ${mealType.charAt(0).toUpperCase() + mealType.slice(1)}`;
  
  let mealOptions = [];
  if (mealType === 'lunch') {
    mealOptions = meals.lunch.slice();
  } else if (mealType === 'dinner') {
    const mode = dinnerModes[dayKey] || 'regular';
    const isWeekend = getDayIndex(dayKey) >= 5;
    
    if (mode === 'quick') mealOptions = meals.dinner.quick.slice();
    else if (mode === 'delivery') mealOptions = meals.dinner.delivery.slice();
    else if (isWeekend) mealOptions = meals.dinner.weekend.slice();
    else mealOptions = meals.dinner.regular.slice();
    
    if (!isWeekend && mode === 'regular') {
      mealOptions.push(...meals.dinner.other);
    }
  } else if (mealType === 'side') {
    mealOptions = meals.side.slice();
  }
  
  mealOptions.push('None');
  
  const currentValue = (data[dayKey] || {})[mealType];
  renderPickerOptions(mealOptions, currentValue);
  
  backdrop.classList.add('show');
  picker.classList.add('show');
  
  if (navigator.vibrate) navigator.vibrate(5);
}

function renderPickerOptions(options, currentValue) {
  const container = document.getElementById('pickerOptions');
  
  const customOption = `
    <div class="picker-option special" onclick="addCustomMeal()">
      ➕ Add Custom Meal...
    </div>
  `;
  
  const optionsList = options.map(option => `
    <div class="picker-option ${option === currentValue ? 'selected' : ''}" onclick="selectMeal('${option}')">
      ${option}
      ${option === currentValue ? '<span style="color: var(--blue);">✓</span>' : ''}
    </div>
  `).join('');
  
  container.innerHTML = customOption + optionsList;
}

function selectMeal(mealName) {
  if (!currentPicker) return;
  
  const { dayKey, mealType } = currentPicker;
  if (!data[dayKey]) data[dayKey] = { lunch: '', dinner: '', side: '' };
  
  if (mealName === 'None') {
    data[dayKey][mealType] = '';
  } else {
    data[dayKey][mealType] = mealName;
    if (mealType === 'dinner' && mealName.includes('Delivery')) {
      data[dayKey].side = '';
    }
  }
  
  saveData();
  if (currentEditingDay === dayKey) {
    renderDayEditor(dayKey);
  }
  closePicker();
}

function addCustomMeal() {
  const mealName = prompt('Enter custom meal name:');
  if (mealName && mealName.trim()) {
    selectMeal(mealName.trim());
  }
}

function closePicker() {
  const picker = document.getElementById('mealPicker');
  const backdrop = document.getElementById('pickerBackdrop');
  
  picker.classList.remove('show');
  backdrop.classList.remove('show');
  currentPicker = null;
}

function setDinnerMode(dayKey, mode) {
  dinnerModes[dayKey] = mode;
  if (!data[dayKey]) data[dayKey] = { lunch: '', dinner: '', side: '' };
  
  // Clear incompatible selections
  const isWeekend = getDayIndex(dayKey) >= 5;
  const validOptions = mode === 'quick' ? meals.dinner.quick
                     : mode === 'delivery' ? meals.dinner.delivery
                     : isWeekend ? meals.dinner.weekend
                     : meals.dinner.regular;
  
  if (data[dayKey].dinner && !validOptions.includes(data[dayKey].dinner)) {
    data[dayKey].dinner = '';
  }
  
  if (mode === 'delivery') {
    data[dayKey].side = '';
  }
  
  saveData();
  renderDayEditor(dayKey);
  
  if (navigator.vibrate) navigator.vibrate(5);
}

function toggleDayLock(dayKey) {
  lockedDays[dayKey] = !lockedDays[dayKey];
  saveData();
  renderDayEditor(dayKey);
  if (navigator.vibrate) navigator.vibrate(8);
}

function shuffleMeal(dayKey, mealType, button) {
  if (lockedDays[dayKey]) return;
  
  if (!data[dayKey]) data[dayKey] = { lunch: '', dinner: '', side: '' };
  
  button?.classList.add('animate-bounce');
  
  let options = [];
  if (mealType === 'lunch') {
    options = meals.lunch;
  } else if (mealType === 'dinner') {
    const mode = dinnerModes[dayKey] || 'regular';
    const isWeekend = getDayIndex(dayKey) >= 5;
    
    options = mode === 'quick' ? meals.dinner.quick
            : mode === 'delivery' ? meals.dinner.delivery
            : isWeekend ? meals.dinner.weekend
            : meals.dinner.regular;
  } else if (mealType === 'side') {
    options = meals.side;
  }
  
  if (options.length > 0) {
    const randomMeal = options[Math.floor(Math.random() * options.length)];
    data[dayKey][mealType] = randomMeal;
  }
  
  setTimeout(() => {
    button?.classList.remove('animate-bounce');
    saveData();
    renderDayEditor(dayKey);
  }, 600);
  
  if (navigator.vibrate) navigator.vibrate([10, 5, 10]);
}

function shuffleEntireDay(dayKey) {
  if (lockedDays[dayKey]) return;
  
  if (!data[dayKey]) data[dayKey] = { lunch: '', dinner: '', side: '' };
  
  const mode = dinnerModes[dayKey] || 'regular';
  const isWeekend = getDayIndex(dayKey) >= 5;
  
  // Shuffle lunch
  if (meals.lunch.length > 0) {
    data[dayKey].lunch = meals.lunch[Math.floor(Math.random() * meals.lunch.length)];
  }
  
  // Shuffle dinner
  let dinnerOptions = mode === 'quick' ? meals.dinner.quick
                    : mode === 'delivery' ? meals.dinner.delivery
                    : isWeekend ? meals.dinner.weekend
                    : meals.dinner.regular;
  
  if (dinnerOptions.length > 0) {
    data[dayKey].dinner = dinnerOptions[Math.floor(Math.random() * dinnerOptions.length)];
  }
  
  // Shuffle side dish (if applicable)
  if (mode !== 'delivery' && meals.side.length > 0) {
    data[dayKey].side = meals.side[Math.floor(Math.random() * meals.side.length)];
  }
  
  saveData();
  renderDayEditor(dayKey);
  
  if (navigator.vibrate) navigator.vibrate([15, 10, 15]);
}

function clearDay(dayKey) {
  if (!confirm('Clear all meals for this day?')) return;
  
  data[dayKey] = { lunch: '', dinner: '', side: '' };
  saveData();
  renderDayEditor(dayKey);
  
  if (navigator.vibrate) navigator.vibrate(20);
}

function selectWeek(selectedWeek) {
  if (week !== selectedWeek) {
    week = selectedWeek;
    updateWeekSelector();
    updateWeekRange();
    renderDays();
    updateWeekendToggle();
    saveData();
  }
}

function toggleWeekend() {
  weekendEnabled[week] = !weekendEnabled[week];
  updateWeekendToggle();
  
  if (!weekendEnabled[week]) {
    // Clear weekend data
    for (let i = 5; i <= 6; i++) {
      const dayKey = getDayKey(i);
      delete data[dayKey];
      delete lockedDays[dayKey];
      delete dinnerModes[dayKey];
    }
  }
  
  saveData();
  renderDays();
  
  if (navigator.vibrate) navigator.vibrate(10);
}

function updateWeekendToggle() {
  const toggle = document.getElementById('weekendToggle');
  const enabled = !!weekendEnabled[week];
  toggle.classList.toggle('active', enabled);
  toggle.setAttribute('aria-checked', enabled);
}

function setTheme() {
  const saved = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const isDark = saved ? saved === 'dark' : prefersDark;
  
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('themeToggle').textContent = isDark ? '◑' : '◐';
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  document.getElementById('themeToggle').textContent = next === 'dark' ? '◑' : '◐';
  
  if (navigator.vibrate) navigator.vibrate(5);
}

// Tab Bar Actions
function shuffleAll() {
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  let shuffledCount = 0;
  
  days.forEach((_, index) => {
    if (index >= 5 && !weekendEnabled[week]) return;
    
    const dayKey = getDayKey(index);
    if (!lockedDays[dayKey]) {
      shuffleEntireDay(dayKey);
      shuffledCount++;
    }
  });
  
  if (shuffledCount > 0) {
    renderDays();
    if (navigator.vibrate) navigator.vibrate([20, 10, 20, 10, 20]);
  }
}

function showGrocery() {
  const modal = document.getElementById('groceryModal');
  const list = document.getElementById('groceryList');
  
  const allIngredients = {};
  Object.values(data).forEach(dayData => {
    ['lunch', 'dinner', 'side'].forEach(mealType => {
      const meal = dayData[mealType];
      if (meal && ingredients[meal]) {
        ingredients[meal].forEach(ingredient => {
          allIngredients[ingredient] = (allIngredients[ingredient] || 0) + 1;
        });
      }
    });
  });
  
  if (Object.keys(allIngredients).length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary)">No meals planned yet</div>';
  } else {
    const sortedIngredients = Object.entries(allIngredients)
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([ingredient, count]) => `
        <div style="padding:12px 0;border-bottom:0.33px solid var(--separator);display:flex;justify-content:space-between;">
          <span style="font-size:17px;color:var(--text-primary)">${ingredient}</span>
          ${count > 1 ? `<span style="font-size:13px;color:var(--text-secondary);font-weight:600">×${count}</span>` : ''}
        </div>
      `).join('');
    
    list.innerHTML = sortedIngredients;
  }
  
  modal.classList.add('show');
}

function shareGrocery() {
  const allIngredients = {};
  Object.values(data).forEach(dayData => {
    ['lunch', 'dinner', 'side'].forEach(mealType => {
      const meal = dayData[mealType];
      if (meal && ingredients[meal]) {
        ingredients[meal].forEach(ingredient => {
          allIngredients[ingredient] = (allIngredients[ingredient] || 0) + 1;
        });
      }
    });
  });
  
  const groceryText = '🛒 Shopping List\n\n' + 
    Object.entries(allIngredients)
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([ingredient, count]) => `☐ ${ingredient}${count > 1 ? ` (×${count})` : ''}`)
      .join('\n');
  
  if (navigator.share) {
    navigator.share({
      title: 'Shopping List',
      text: groceryText
    }).catch(() => {
      copyToClipboard(groceryText);
    });
  } else {
    copyToClipboard(groceryText);
  }
  
  closeModal('groceryModal');
}

function sharePlan() {
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  const start = getWeekStart();
  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  
  let planText = `📅 Meal Plan - ${week === 'this' ? 'This' : 'Next'} Week\n`;
  planText += `${start.toLocaleDateString('en', { month: 'short', day: 'numeric' })} - ${end.toLocaleDateString('en', { month: 'short', day: 'numeric' })}\n\n`;
  
  days.forEach((dayName, index) => {
    if (index >= 5 && !weekendEnabled[week]) return;
    
    const dayKey = getDayKey(index, start);
    const dayData = data[dayKey] || {};
    const mode = dinnerModes[dayKey] || 'regular';
    
    planText += `${dayName}\n`;
    if (dayData.lunch) planText += `  Lunch: ${dayData.lunch}\n`;
    if (dayData.dinner) {
      planText += `  Dinner: ${dayData.dinner}`;
      if (dayData.side && mode !== 'delivery') planText += ` with ${dayData.side}`;
      planText += '\n';
    }
    if (!dayData.lunch && !dayData.dinner) planText += '  No meals planned\n';
    planText += '\n';
  });
  
  const shareText = document.getElementById('shareText');
  shareText.textContent = planText;
  
  document.getElementById('shareModal').classList.add('show');
}

function copyText(button) {
  const text = document.getElementById('shareText').textContent;
  copyToClipboard(text);
  
  const original = button.textContent;
  button.textContent = 'Copied!';
  button.style.background = 'var(--green)';
  
  setTimeout(() => {
    button.textContent = original;
    button.style.background = '';
    closeModal('shareModal');
  }, 1000);
}

function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text);
  } else {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
  }
  
  if (navigator.vibrate) navigator.vibrate(10);
}

function clearAll() {
  if (!confirm('Clear all meal plans?')) return;
  
  data = {};
  lockedDays = {};
  dinnerModes = {};
  
  saveData();
  renderDays();
  
  if (currentEditingDay) {
    closeDayEditor();
  }
  
  if (navigator.vibrate) navigator.vibrate(30);
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

function closeAllModals() {
  document.querySelectorAll('.modal').forEach(modal => {
    modal.classList.remove('show');
  });
}

// Utility Functions
function getDayKey(index, startDate = null) {
  const date = getDateForIndex(index, startDate);
  return `${week}-${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
}

function getDayIndex(dayKey) {
  const parts = dayKey.split('-');
  const date = new Date(parseInt(parts[1]), parseInt(parts[2]), parseInt(parts[3]));
  const start = getWeekStart();
  return Math.floor((date - start) / (1000 * 60 * 60 * 24));
}

function getDateForIndex(index, startDate = null) {
  const start = startDate || getWeekStart();
  const date = new Date(start);
  date.setDate(start.getDate() + index);
  return date;
}

function getWeekStart() {
  const now = new Date();
  const dayOfWeek = (now.getDay() + 6) % 7; // Make Monday = 0
  const start = new Date(now);
  start.setDate(now.getDate() - dayOfWeek + (week === 'next' ? 7 : 0));
  start.setHours(0, 0, 0, 0);
  return start;
}

function saveData() {
  localStorage.setItem('mealPlanData', JSON.stringify(data));
  localStorage.setItem('mealPlanWeek', week);
  localStorage.setItem('mealPlanWeekend', JSON.stringify(weekendEnabled));
  localStorage.setItem('mealPlanLocked', JSON.stringify(lockedDays));
  localStorage.setItem('mealPlanModes', JSON.stringify(dinnerModes));
}

function loadData() {
  try {
    data = JSON.parse(localStorage.getItem('mealPlanData') || '{}');
    week = localStorage.getItem('mealPlanWeek') || 'next';
    weekendEnabled = JSON.parse(localStorage.getItem('mealPlanWeekend') || '{}');
    lockedDays = JSON.parse(localStorage.getItem('mealPlanLocked') || '{}');
    dinnerModes = JSON.parse(localStorage.getItem('mealPlanModes') || '{}');
  } catch (e) {
    console.error('Error loading data:', e);
  }
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>

