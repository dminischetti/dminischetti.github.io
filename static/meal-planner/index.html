<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Tasty Planning</title>
  <style>
    :root {
      /* Dark Theme with Vibrant Accents */
      --bg-gradient: linear-gradient(135deg, #1a0f2e 0%, #2d1b69 50%, #0f172a 100%);
      --surface-glass: rgba(139, 92, 246, 0.03);
      --surface-hover: rgba(139, 92, 246, 0.08);
      --surface-card: rgba(15, 23, 42, 0.6);
      --border-subtle: rgba(139, 92, 246, 0.15);
      --border-default: rgba(139, 92, 246, 0.25);
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-tertiary: #94a3b8;
      --accent-violet: #8b5cf6;
      --accent-purple: #a855f7;
      --accent-pink: #ec4899;
      --accent-blue: #3b82f6;
      --accent-cyan: #06b6d4;
      --accent-emerald: #10b981;
      --accent-amber: #f59e0b;
    }
    
    :root[data-theme="light"] {
      /* Pastel Light Theme */
      --bg-gradient: linear-gradient(135deg, #fef3c7 0%, #fde8ff 50%, #e0f2fe 100%);
      --surface-glass: rgba(255, 255, 255, 0.7);
      --surface-hover: rgba(168, 85, 247, 0.08);
      --surface-card: rgba(255, 255, 255, 0.8);
      --border-subtle: rgba(168, 85, 247, 0.15);
      --border-default: rgba(168, 85, 247, 0.2);
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-tertiary: #64748b;
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    
    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text-primary);
    }
    
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-subtle);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    :root[data-theme="light"] .header {
      background: rgba(255, 255, 255, 0.85);
    }
    
    .header-title {
      flex: 1;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--accent-violet) 0%, var(--accent-pink) 50%, var(--accent-cyan) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .btn-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--surface-glass);
      border: 1px solid var(--border-default);
      color: var(--text-primary);
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 20px;
    }
    
    .weekend-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      background: var(--surface-glass);
      border: 1px solid var(--border-default);
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }
    
    .toggle-label {
      padding: 0 4px;
      color: var(--text-secondary);
    }
    
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--surface-glass);
      border: 1px solid var(--border-default);
      border-radius: 999px;
      transition: all 0.3s;
    }
    
    .toggle-switch.active {
      background: var(--accent-violet);
      border-color: var(--accent-violet);
    }
    
    .toggle-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .toggle-switch.active .toggle-knob {
      transform: translateX(20px);
    }
    
    .container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .week-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      padding: 16px;
      background: var(--surface-card);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
    }
    
    .week-date {
      font-size: 20px;
      font-weight: 600;
      text-align: center;
    }
    
    .day-card {
      margin-bottom: 12px;
      padding: 16px;
      background: var(--surface-card);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-default);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .day-card.incomplete {
      opacity: 0.7;
      border-style: dashed;
    }
    
    .day-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.2);
    }
    
    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .day-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .day-date {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .meal-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      margin-bottom: 8px;
      background: var(--surface-glass);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      cursor: pointer;
    }
    
    .meal-item.empty {
      opacity: 0.5;
    }
    
    .meal-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      font-size: 20px;
    }
    
    .meal-icon.lunch {
      background: linear-gradient(135deg, var(--accent-amber), var(--accent-amber));
    }
    
    .meal-icon.dinner {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
    }
    
    .meal-content {
      flex: 1;
    }
    
    .meal-title {
      font-weight: 600;
      margin: 0;
    }
    
    .meal-description {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0;
    }
    
    .busy-toggle {
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 600;
      background: var(--surface-glass);
      border: 1px solid var(--border-default);
      border-radius: 999px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .busy-toggle.active {
      background: var(--accent-purple);
      border-color: var(--accent-purple);
      color: white;
    }
    
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: flex-end;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      z-index: 1000;
    }
    
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 28px 28px 0 0;
      transform: translateY(100%);
      transition: transform 0.3s;
      max-height: 85vh;
      overflow: hidden;
    }
    
    :root[data-theme="light"] .modal {
      background: rgba(255, 255, 255, 0.98);
    }
    
    .modal-overlay.show .modal {
      transform: translateY(0);
    }
    
    .modal-header {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid var(--border-subtle);
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 4px 0 0;
    }
    
    .modal-body {
      max-height: 50vh;
      overflow-y: auto;
      padding: 0;
    }
    
    .modal-footer {
      display: flex;
      gap: 8px;
      padding: 16px;
      background: var(--surface-glass);
      border-top: 1px solid var(--border-subtle);
    }
    
    .controls {
      display: flex;
      gap: 8px;
      padding: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .bento-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 12px;
    }
    
    .bento-item {
      position: relative;
      padding: 16px 8px;
      background: var(--surface-glass);
      border: 1px solid var(--border-default);
      border-radius: 16px;
      cursor: pointer;
      text-align: center;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .bento-item:hover {
      background: var(--surface-hover);
      transform: scale(1.05);
    }
    
    .bento-item.selected {
      background: rgba(139, 92, 246, 0.15);
      border-color: var(--accent-violet);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2) inset;
    }
    
    .bento-item.selected::before {
      content: '✓';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 20px;
      height: 20px;
      background: var(--accent-violet);
      color: white;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 12px;
    }
    
    .bento-emoji {
      font-size: 24px;
      display: block;
      margin-bottom: 4px;
    }
    
    .btn {
      flex: 1;
      padding: 12px 16px;
      font-weight: 600;
      background: var(--surface-glass);
      color: var(--text-primary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      cursor: pointer;
    }
    
    .btn-primary {
      background: var(--accent-violet);
      border-color: var(--accent-violet);
      color: white;
    }
    
    .btn-danger {
      background: var(--accent-pink);
      border-color: var(--accent-pink);
      color: white;
    }
    
    .menu-grid {
      display: grid;
      gap: 8px;
      padding: 12px;
    }
    
    .menu-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--surface-glass);
      border: 1px solid var(--border-default);
      border-radius: 16px;
      cursor: pointer;
    }
    
    .menu-item:hover {
      background: var(--surface-hover);
    }
    
    .menu-item-icon {
      font-size: 24px;
    }
    
    .menu-item-content h4 {
      margin: 0;
      font-weight: 600;
    }
    
    .menu-item-content p {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      padding: 0 12px 12px;
    }
    
    .btn-action {
      flex: 1;
      padding: 8px;
      font-size: 13px;
      font-weight: 600;
      background: var(--surface-glass);
      color: var(--text-primary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      cursor: pointer;
    }
    
    .btn-action:hover {
      background: var(--surface-hover);
    }
    
    .store-section {
      margin: 12px;
      padding: 16px;
      background: var(--surface-glass);
      border: 1px solid var(--border-default);
      border-radius: 16px;
    }
    
    .store-title {
      margin: 0 0 12px;
      font-weight: 600;
    }
    
    .grocery-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      margin-bottom: 8px;
      background: var(--surface-glass);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
    }
    
    .checkbox {
      width: 24px;
      height: 24px;
      background: var(--surface-glass);
      border: 2px solid var(--border-default);
      border-radius: 8px;
      cursor: pointer;
      display: grid;
      place-items: center;
    }
    
    .checkbox.checked {
      background: var(--accent-emerald);
      border-color: var(--accent-emerald);
    }
    
    .checkbox.checked::after {
      content: '✓';
      color: white;
      font-weight: bold;
    }
    
    .grocery-item-text {
      flex: 1;
    }
    
    .grocery-item.checked .grocery-item-text {
      opacity: 0.5;
      text-decoration: line-through;
    }
    
    .toast {
      position: fixed;
      left: 50%;
      bottom: 100px;
      transform: translateX(-50%) translateY(20px);
      padding: 12px 20px;
      background: rgba(15, 23, 42, 0.95);
      color: white;
      font-size: 14px;
      font-weight: 600;
      border-radius: 999px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      z-index: 2000;
    }
    
    :root[data-theme="light"] .toast {
      background: rgba(255, 255, 255, 0.95);
      color: var(--text-primary);
    }
    
    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    
    .input-group {
      padding: 0 12px 12px;
    }
    
    .input-label {
      display: block;
      margin: 0 0 8px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
    }
    
    .input {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      background: var(--surface-glass);
      color: var(--text-primary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
    }
    
    .radio-group {
      display: flex;
      gap: 8px;
    }
    
    .radio {
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      background: var(--surface-glass);
      color: var(--text-secondary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      cursor: pointer;
    }
    
    .radio.active {
      background: var(--accent-violet);
      border-color: var(--accent-violet);
      color: white;
    }
  </style>
</head>
<body>
  <header class="header">
    <button id="menuBtn" class="btn-icon">☰</button>
    <h1 class="header-title">Tasty Planning</h1>
    <button id="weekendToggle" class="weekend-toggle">
      <span class="toggle-label">Weekends</span>
      <div class="toggle-switch active" id="weekendSwitch">
        <div class="toggle-knob"></div>
      </div>
    </button>
  </header>
  
  <div class="container">
    <div class="week-nav">
      <div class="week-date" id="weekDate"></div>
    </div>
    <div id="daysList"></div>
  </div>
  
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle"></h2>
        <p class="modal-subtitle" id="modalSubtitle"></p>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer" id="modalFooter"></div>
    </div>
  </div>
  
  <div id="toast" class="toast"></div>
  
  <script>
    // Configuration
    const CONFIG = {
      storageKey: 'mp_enhanced_v3',
      animations: { modal: 300, toast: 1500 }
    };
    
    const MEAL_EMOJIS = {
      "Ravioli burro e salvia": "🥟",
      "Spaghetti al limone": "🍝",
      "Pasta e ceci": "🍝",
      "Pasta col tonno": "🐟",
      "Pasta sugo tonno": "🐟",
      "Piadine prosciutto provolone": "🥪",
      "Uova fritte": "🍳",
      "Pasta al pesto": "🌿",
      "Pasta coi pomodorini": "🍅",
      "Lenticchie": "🥘",
      "Spaghetti aglio e olio": "🧄",
      "Carbonara": "🥓",
      "Frittata di pasta": "🍳",
      "Pasta e fagioli": "🫘",
      "Salmone col riso": "🍣",
      "Frittata di zucchine": "🥒",
      "Polpette": "🧆",
      "Pollo al limone": "🍗",
      "Merluzzo": "🐟",
      "Hamburger": "🍔",
      "Cotolette": "🥩",
      "Salsicce": "🌭",
      "Minestrone": "🍲",
      "Pollo al forno": "🍗",
      "Scaloppine al limone": "🥩",
      "Caprese": "🧀",
      "Cordon bleu": "🥩",
      "Würstel": "🌭",
      "Dumplings": "🥟",
      "Fish sticks": "🐟",
      "Pollo allo spiedo": "🍗",
      "Pasta al forno": "🍝",
      "Parmigiana di melanzane": "🍆",
      "Zucchine ripiene": "🥒",
      "Lasagna": "🍝",
      "Spezzatino con patate": "🥘",
      "Tortellini con la panna": "🥟",
      "Tortellini col sugo": "🥟",
      "Pasta col ragù": "🍝",
      "Polpettone": "🥩",
      "Scrimpelle mbuss": "🥞",
      "Polenta col sugo": "🌽",
      "Cannelloni": "🥟",
      "Bistecca": "🥩",
      "Pizza Delivery": "🍕",
      "Greco Delivery": "🥙",
      "Chinese Delivery": "🥡",
      "Vietnamese Delivery": "🍜",
      "Ramen Delivery": "🍜",
      "Purè di patate": "🥔",
      "Broccoli al vapore": "🥦",
      "Insalata di pomodori": "🍅",
      "Tater tots": "🥔",
      "Barbabietole": "🥬",
      "Insalata di mais": "🌽",
      "Patate lesse": "🥔",
      "Carote al forno": "🥕",
      "Carote a insalata": "🥕",
      "Zucchine trifolate": "🥒",
      "Insalata di cetrioli": "🥒",
      "Insalata": "🥗",
      "None": "❌",
      "Custom": "✏️"
    };
    
    const INGREDIENT_EMOJIS = {
      "Ravioli": "🥟", "Sage": "🌿", "Spaghetti": "🍝", "Lemons": "🍋",
      "Ditalini": "🍝", "Chickpeas": "🫘", "Tuna": "🐟", "Pasta": "🍝",
      "Tomato sauce": "🍅", "Flatbreads": "🫓", "Prosciutto": "🥩",
      "Provolone cheese": "🧀", "Eggs": "🥚", "Pesto": "🌿", 
      "Cherry tomatoes": "🍅", "Lentils": "🫘", "Croutons": "🍞",
      "Bacon": "🥓", "Beans": "🫘", "Salmon": "🍣", "Rice": "🍚",
      "Zucchini": "🥒", "Ground beef": "🥩", "Bread": "🍞", "Breadcrumbs": "🍞",
      "Chicken breast": "🍗", "Cod": "🐟", "Hamburger buns": "🍔",
      "American cheese slices": "🧀", "Lettuce": "🥬", "Tomatoes": "🍅",
      "Breaded cutlets": "🥩", "Sausages": "🌭", "Vegetable soup mix": "🥕",
      "Chicken thighs": "🍗", "Veal cutlets": "🥩", "Fresh mozzarella": "🧀",
      "Cordon bleu": "🥩", "Hot dogs": "🌭", "Dumplings": "🥟",
      "Fish sticks": "🐟", "Whole chicken": "🍗", "Shredded mozzarella": "🧀",
      "Eggplant": "🍆", "Beef": "🥩", "Potatoes": "🥔", "Onion": "🧅",
      "Carrots": "🥕", "Tortellini": "🥟", "Cream": "🥛", "Meat sauce": "🍖",
      "Flour": "🌾", "Milk": "🥛", "Broth": "🍲", "Polenta": "🌽",
      "Ricotta": "🧀", "Spinach": "🥬", "Lasagna noodles": "🍝", "Steak": "🥩",
      "Broccoli": "🥦", "Tater tots": "🥔", "Beets": "🥬", "Corn": "🌽",
      "Cucumbers": "🥒", "Butter": "🧈", "Pesto sauce": "🌿"
    };
    
    const MEAL_DATA = {
      lunch: [
        "None", "Ravioli burro e salvia", "Spaghetti al limone", "Pasta e ceci", 
        "Pasta col tonno", "Pasta sugo tonno", "Piadine prosciutto provolone", 
        "Uova fritte", "Pasta al pesto", "Pasta coi pomodorini", "Lenticchie", 
        "Spaghetti aglio e olio", "Carbonara", "Frittata di pasta", "Pasta e fagioli", "Custom"
      ],
      dinnerRegular: [
        "None", "Salmone col riso", "Frittata di zucchine", "Polpette", "Pollo al limone",
        "Merluzzo", "Hamburger", "Cotolette", "Salsicce", "Minestrone", "Pollo al forno",
        "Scaloppine al limone", "Caprese", "Custom"
      ],
      dinnerQuick: [
        "None", "Cordon bleu", "Würstel", "Dumplings", "Fish sticks", "Pollo allo spiedo", "Custom"
      ],
      delivery: [
        "None", "Pizza Delivery", "Greco Delivery", "Chinese Delivery", 
        "Vietnamese Delivery", "Ramen Delivery", "Custom"
      ],
      dinnerWeekend: [
        "None", "Pasta al forno", "Parmigiana di melanzane", "Zucchine ripiene", 
        "Lasagna", "Spezzatino con patate", "Tortellini con la panna", 
        "Tortellini col sugo", "Pasta col ragù", "Polpettone", "Scrimpelle mbuss", 
        "Polenta col sugo", "Cannelloni", "Bistecca", "Custom"
      ],
      side: [
        "None", "Purè di patate", "Broccoli al vapore", "Insalata di pomodori", 
        "Tater tots", "Barbabietole", "Insalata di mais", "Patate lesse", 
        "Carote al forno", "Carote a insalata", "Zucchine trifolate", 
        "Insalata di cetrioli", "Insalata", "Custom"
      ]
    };
    
    const INGREDIENTS = {
      "Ravioli burro e salvia": ["Ravioli", "Sage"],
      "Spaghetti al limone": ["Spaghetti", "Lemons"],
      "Pasta e ceci": ["Ditalini", "Chickpeas"],
      "Pasta col tonno": ["Spaghetti", "Tuna"],
      "Pasta sugo tonno": ["Pasta", "Tuna", "Tomato sauce"],
      "Piadine prosciutto provolone": ["Flatbreads", "Prosciutto", "Provolone cheese"],
      "Uova fritte": ["Eggs"],
      "Pasta al pesto": ["Pasta", "Pesto sauce"],
      "Pasta coi pomodorini": ["Pasta", "Cherry tomatoes"],
      "Lenticchie": ["Lentils", "Croutons"],
      "Spaghetti aglio e olio": ["Spaghetti"],
      "Carbonara": ["Spaghetti", "Eggs", "Bacon"],
      "Frittata di pasta": ["Eggs"],
      "Pasta e fagioli": ["Pasta", "Beans"],
      "Salmone col riso": ["Salmon", "Rice"],
      "Frittata di zucchine": ["Eggs", "Zucchini"],
      "Polpette": ["Ground beef", "Eggs", "Bread", "Breadcrumbs"],
      "Pollo al limone": ["Chicken breast", "Lemons"],
      "Merluzzo": ["Cod"],
      "Hamburger": ["Hamburger buns", "Ground beef", "American cheese slices", "Lettuce", "Tomatoes"],
      "Cotolette": ["Breaded cutlets", "Breadcrumbs", "Eggs"],
      "Salsicce": ["Sausages"],
      "Minestrone": ["Vegetable soup mix", "Pasta", "Beans"],
      "Pollo al forno": ["Chicken thighs"],
      "Scaloppine al limone": ["Veal cutlets", "Lemons"],
      "Caprese": ["Fresh mozzarella", "Tomatoes"],
      "Cordon bleu": ["Cordon bleu"],
      "Würstel": ["Hot dogs"],
      "Dumplings": ["Dumplings"],
      "Fish sticks": ["Fish sticks"],
      "Pollo allo spiedo": ["Whole chicken"],
      "Pasta al forno": ["Pasta", "Tomato sauce", "Shredded mozzarella"],
      "Parmigiana di melanzane": ["Eggplant", "Tomato sauce", "Shredded mozzarella"],
      "Zucchine ripiene": ["Zucchini", "Ground beef", "Bread"],
      "Lasagna": ["Lasagna noodles", "Meat sauce"],
      "Spezzatino con patate": ["Beef", "Potatoes", "Onion", "Carrots"],
      "Tortellini con la panna": ["Tortellini", "Cream"],
      "Tortellini col sugo": ["Tortellini", "Tomato sauce"],
      "Pasta col ragù": ["Pasta", "Meat sauce"],
      "Polpettone": ["Ground beef", "Eggs", "Bacon", "Bread"],
      "Scrimpelle mbuss": ["Eggs", "Flour", "Milk", "Broth"],
      "Polenta col sugo": ["Polenta", "Tomato sauce", "Sausages"],
      "Cannelloni": ["Cannelloni", "Ricotta", "Spinach"],
      "Bistecca": ["Steak"],
      "Purè di patate": ["Potatoes"],
      "Broccoli al vapore": ["Broccoli"],
      "Insalata di pomodori": ["Tomatoes"],
      "Tater tots": ["Tater tots"],
      "Barbabietole": ["Beets"],
      "Insalata di mais": ["Corn"],
      "Patate lesse": ["Potatoes"],
      "Carote al forno": ["Carrots"],
      "Carote a insalata": ["Carrots"],
      "Zucchine trifolate": ["Zucchini"],
      "Insalata di cetrioli": ["Cucumbers"],
      "Insalata": ["Lettuce"]
    };
    
    const STORES = {
      Aldi: ["Bacon", "Beets", "Cannelloni", "Carrots", "Chicken thighs", "Breaded cutlets", "Croutons", "Dumplings", "Beans", "Fish sticks", "Lemons", "Corn", "Shredded mozzarella", "Potatoes", "Chicken breast", "Flatbreads", "Tomatoes", "Cherry tomatoes", "Provolone cheese", "Prosciutto", "Ravioli", "Sausages", "American cheese slices", "Spinach", "Tater tots", "Tortellini", "Eggs", "Hot dogs", "Zucchini", "Ground beef", "Ricotta", "Milk", "Pesto sauce"],
      Wegmans: ["Steak", "Broccoli", "Cucumbers", "Onion", "Hamburger buns", "Butter", "Lettuce", "Lentils", "Eggplant", "Cod", "Whole chicken", "Sage", "Salmon", "Bread", "Tomato sauce"],
      Amazon: ["Pasta", "Tuna", "Breadcrumbs", "Rice"],
      Other: []
    };
    
    // State Management
    class MealPlannerApp {
      constructor() {
        this.state = this.loadState() || this.createInitialState();
        this.currentDayIndex = null;
        this.init();
      }
      
      createInitialState() {
        const weekStart = this.getWeekStart(new Date());
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        
        return {
          weekStart: weekStart.toISOString(),
          showWeekend: true,
          theme: 'dark',
          days: days.map((name, index) => ({
            name,
            date: new Date(weekStart.getTime() + index * 86400000).toISOString(),
            lunch: null,
            dinner: null,
            side: null,
            busy: false,
            dinnerType: 'regular',
            customLunch: null,
            customDinner: null,
            customSide: null
          })),
          groceryExtras: []
        };
      }
      
      getWeekStart(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
      }
      
      formatWeekDate() {
        const start = new Date(this.state.weekStart);
        const end = new Date(start.getTime() + 6 * 86400000);
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        return `${monthNames[start.getMonth()]} ${start.getDate()} - ${end.getDate()}, ${start.getFullYear()}`;
      }
      
      formatDate(date) {
        const d = new Date(date);
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        return `${monthNames[d.getMonth()]} ${d.getDate()}`;
      }
      
      init() {
        this.applyTheme();
        this.attachEventListeners();
        this.render();
      }
      
      loadState() {
        try {
          const stored = localStorage.getItem(CONFIG.storageKey);
          return stored ? JSON.parse(stored) : null;
        } catch (e) {
          return null;
        }
      }
      
      saveState() {
        try {
          localStorage.setItem(CONFIG.storageKey, JSON.stringify(this.state));
        } catch (e) {
          console.error('Failed to save state:', e);
        }
      }
      
      applyTheme() {
        document.documentElement.setAttribute('data-theme', this.state.theme);
      }
      
      toggleTheme() {
        this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
        this.applyTheme();
        this.saveState();
      }
      
      navigateWeek(direction) {
        const current = new Date(this.state.weekStart);
        const days = direction === 'next' ? 7 : -7;
        const newWeekStart = new Date(current.getTime() + days * 86400000);
        this.state = this.createInitialState();
        this.state.weekStart = newWeekStart.toISOString();
        this.state.days = this.state.days.map((day, index) => ({
          ...day,
          date: new Date(newWeekStart.getTime() + index * 86400000).toISOString()
        }));
        this.saveState();
        this.render();
      }
      
      attachEventListeners() {
        document.getElementById('menuBtn').onclick = () => this.openMenu();
        document.getElementById('weekendToggle').onclick = () => {
          this.state.showWeekend = !this.state.showWeekend;
          const toggleSwitch = document.getElementById('weekendSwitch');
          toggleSwitch.classList.toggle('active', this.state.showWeekend);
          this.saveState();
          this.render();
        };
        
        const overlay = document.getElementById('modalOverlay');
        overlay.onclick = (e) => {
          if (e.target === overlay) this.closeModal();
        };
        
        document.onkeydown = (e) => {
          if (e.key === 'Escape' && overlay.classList.contains('show')) {
            this.closeModal();
          }
        };
      }
      
      render() {
        document.getElementById('weekDate').textContent = this.formatWeekDate();
        this.renderDays();
      }
      
      renderDays() {
        const days = this.state.days.filter(d => 
          this.state.showWeekend || (d.name !== 'Saturday' && d.name !== 'Sunday')
        );
        
        const daysHtml = days.map((day, visualIndex) => {
          const realIndex = this.state.days.indexOf(day);
          const lunchMissing = !day.lunch;
          const dinnerMissing = !day.dinner;
          const sideMissing = day.dinnerType !== 'delivery' && !day.side;
          const incomplete = lunchMissing || dinnerMissing || sideMissing;
          
          const lunchDisplay = day.lunch === 'Custom' ? (day.customLunch || 'Enter custom') : day.lunch;
          const dinnerDisplay = day.dinner === 'Custom' ? (day.customDinner || 'Enter custom') : day.dinner;
          const sideDisplay = day.side === 'Custom' ? (day.customSide || 'Enter custom') : day.side;
          
          const lunchText = day.lunch === 'None' ? 'No lunch' : (lunchDisplay || 'Select lunch');
          const dinnerText = day.dinner === 'None' ? 'No dinner' : (dinnerDisplay || 'Select dinner');
          const sideText = day.dinnerType === 'delivery' ? '' : 
                         (day.side === 'None' ? 'No side' : (sideDisplay || 'Select side'));
          
          const lunchEmoji = day.lunch ? (MEAL_EMOJIS[day.lunch] || '🍽️') : '🍽️';
          const dinnerEmoji = day.dinner ? (MEAL_EMOJIS[day.dinner] || '🍽️') : '🍽️';
          
          return `
            <div class="day-card ${incomplete ? 'incomplete' : ''}">
              <div class="day-header">
                <div>
                  <div class="day-title">${day.name}</div>
                  <div class="day-date">${this.formatDate(day.date)}</div>
                </div>
                ${day.busy ? `<button class="busy-toggle active" data-index="${realIndex}">✓ Busy Night</button>` : ''}
              </div>
              
              <div class="meal-item ${lunchMissing ? 'empty' : ''}" data-meal="lunch" data-index="${realIndex}">
                <div class="meal-icon lunch">${lunchEmoji}</div>
                <div class="meal-content">
                  <h4 class="meal-title">Lunch</h4>
                  <p class="meal-description">${lunchText}</p>
                </div>
              </div>
              
              <div class="meal-item ${dinnerMissing ? 'empty' : ''}" data-meal="dinner" data-index="${realIndex}">
                <div class="meal-icon dinner">${dinnerEmoji}</div>
                <div class="meal-content">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 class="meal-title">Dinner</h4>
                    ${!day.busy ? `<button class="busy-toggle" data-index="${realIndex}">Busy Night</button>` : ''}
                  </div>
                  <p class="meal-description">
                    ${dinnerText}
                    ${day.dinnerType !== 'delivery' && sideText ? ` • ${sideText}` : ''}
                  </p>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        document.getElementById('daysList').innerHTML = daysHtml;
        this.attachDayListeners();
      }
      
      attachDayListeners() {
        document.querySelectorAll('.meal-item').forEach(item => {
          item.onclick = (e) => {
            if (!e.target.closest('.busy-toggle')) {
              const index = parseInt(item.dataset.index);
              const meal = item.dataset.meal;
              if (meal === 'lunch') {
                this.openLunchModal(index);
              } else {
                this.openDinnerModal(index);
              }
            }
          };
        });
        
        document.querySelectorAll('.busy-toggle').forEach(btn => {
          btn.onclick = (e) => {
            e.stopPropagation();
            const index = parseInt(btn.dataset.index);
            const day = this.state.days[index];
            day.busy = !day.busy;
            if (day.busy) {
              day.dinnerType = 'quick';
              day.dinner = null;
            } else {
              day.dinnerType = 'regular';
            }
            this.saveState();
            this.render();
          };
        });
      }
      
      openModal({ title, subtitle = '', bodyHTML = '', footer = [] }) {
        const overlay = document.getElementById('modalOverlay');
        document.getElementById('modalTitle').textContent = title || '';
        document.getElementById('modalSubtitle').textContent = subtitle || '';
        document.getElementById('modalBody').innerHTML = bodyHTML || '';
        
        const modalFooter = document.getElementById('modalFooter');
        modalFooter.innerHTML = '';
        footer.forEach(btn => {
          const button = document.createElement('button');
          button.className = `btn ${btn.type || ''}`;
          button.textContent = btn.label;
          button.onclick = btn.onClick;
          modalFooter.appendChild(button);
        });
        
        overlay.classList.add('show');
      }
      
      closeModal() {
        document.getElementById('modalOverlay').classList.remove('show');
      }
      
      openLunchModal(index) {
        this.currentDayIndex = index;
        const day = this.state.days[index];
        
        const selected = day.lunch;
        const bodyHTML = `
          <div class="action-buttons">
            <button class="btn-action" id="randomizeLunch">🎲 Randomize</button>
            <button class="btn-action" id="clearLunch">🗑️ Clear</button>
          </div>
          ${day.lunch === 'Custom' ? `
            <div class="input-group">
              <label class="input-label">Custom Lunch</label>
              <input class="input" id="customLunchInput" value="${day.customLunch || ''}" placeholder="Enter custom meal">
            </div>
          ` : ''}
          ${this.renderBentoGrid('lunch', selected, MEAL_DATA.lunch)}
        `;
        
        this.openModal({
          title: `Lunch - ${day.name}`,
          subtitle: this.formatDate(day.date),
          bodyHTML,
          footer: [
            { label: 'Cancel', onClick: () => this.closeModal() },
            {
              label: 'Save',
              type: 'btn-primary',
              onClick: () => {
                this.saveState();
                this.render(); // Update view immediately
                this.closeModal();
                this.showToast('Saved! ✓');
              }
            }
          ]
        });
        
        document.getElementById('randomizeLunch').onclick = () => {
          const options = MEAL_DATA.lunch.filter(m => m !== 'None' && m !== 'Custom');
          day.lunch = options[Math.floor(Math.random() * options.length)];
          this.openLunchModal(index);
        };
        
        document.getElementById('clearLunch').onclick = () => {
          day.lunch = null;
          day.customLunch = null;
          this.openLunchModal(index);
        };
        
        if (day.lunch === 'Custom') {
          document.getElementById('customLunchInput').oninput = (e) => {
            day.customLunch = e.target.value;
          };
        }
        
        this.attachBentoListeners('lunch');
      }
      
      openDinnerModal(index) {
        this.currentDayIndex = index;
        const day = this.state.days[index];
        
        const isWeekend = day.name === 'Saturday' || day.name === 'Sunday';
        let dinnerOptions = MEAL_DATA.dinnerRegular;
        
        if (day.busy && day.dinnerType === 'quick') {
          dinnerOptions = MEAL_DATA.dinnerQuick;
        } else if (day.busy && day.dinnerType === 'delivery') {
          dinnerOptions = MEAL_DATA.delivery;
        } else if (!day.busy && isWeekend) {
          dinnerOptions = MEAL_DATA.dinnerWeekend;
        }
        
        const bodyHTML = `
          <div class="controls">
            <button id="busyToggle" class="busy-toggle ${day.busy ? 'active' : ''}">
              ${day.busy ? '✓ Busy Night' : 'Busy Night'}
            </button>
            ${day.busy ? `
              <div class="radio-group">
                <button class="radio ${day.dinnerType === 'quick' ? 'active' : ''}" data-type="quick">
                  Quick
                </button>
                <button class="radio ${day.dinnerType === 'delivery' ? 'active' : ''}" data-type="delivery">
                  Delivery
                </button>
              </div>
            ` : ''}
          </div>
          
          <div class="action-buttons">
            <button class="btn-action" id="randomizeDinner">🎲 Randomize</button>
            <button class="btn-action" id="clearDinner">🗑️ Clear</button>
          </div>
          
          ${day.dinner === 'Custom' ? `
            <div class="input-group">
              <label class="input-label">Custom Dinner</label>
              <input class="input" id="customDinnerInput" value="${day.customDinner || ''}" placeholder="Enter custom meal">
            </div>
          ` : ''}
          
          <div id="dinnerBento">
            ${this.renderBentoGrid('dinner', day.dinner, dinnerOptions)}
          </div>
          
          ${day.dinnerType !== 'delivery' ? `
            <div class="input-group">
              <label class="input-label">Side Dish</label>
            </div>
            ${day.side === 'Custom' ? `
              <div class="input-group">
                <input class="input" id="customSideInput" value="${day.customSide || ''}" placeholder="Enter custom side">
              </div>
            ` : ''}
            <div id="sideBento">
              ${this.renderBentoGrid('side', day.side, MEAL_DATA.side)}
            </div>
          ` : ''}
        `;
        
        this.openModal({
          title: `Dinner - ${day.name}`,
          subtitle: this.formatDate(day.date),
          bodyHTML,
          footer: [
            { label: 'Cancel', onClick: () => this.closeModal() },
            {
              label: 'Save',
              type: 'btn-primary',
              onClick: () => {
                this.saveState();
                this.render(); // Update view immediately
                this.closeModal();
                this.showToast('Saved! ✓');
              }
            }
          ]
        });
        
        document.getElementById('busyToggle').onclick = () => {
          day.busy = !day.busy;
          if (day.busy) {
            day.dinnerType = 'quick';
            day.dinner = null;
          } else {
            day.dinnerType = 'regular';
          }
          this.openDinnerModal(index);
        };
        
        document.getElementById('randomizeDinner').onclick = () => {
          const options = dinnerOptions.filter(m => m !== 'None' && m !== 'Custom');
          day.dinner = options[Math.floor(Math.random() * options.length)];
          
          if (day.dinnerType !== 'delivery') {
            const sideOptions = MEAL_DATA.side.filter(m => m !== 'None' && m !== 'Custom');
            day.side = sideOptions[Math.floor(Math.random() * sideOptions.length)];
          }
          this.openDinnerModal(index);
        };
        
        document.getElementById('clearDinner').onclick = () => {
          day.dinner = null;
          day.customDinner = null;
          day.side = null;
          day.customSide = null;
          this.openDinnerModal(index);
        };
        
        if (day.dinner === 'Custom') {
          document.getElementById('customDinnerInput').oninput = (e) => {
            day.customDinner = e.target.value;
          };
        }
        
        if (day.side === 'Custom') {
          document.getElementById('customSideInput').oninput = (e) => {
            day.customSide = e.target.value;
          };
        }
        
        document.querySelectorAll('.radio[data-type]').forEach(radio => {
          radio.onclick = () => {
            day.dinnerType = radio.dataset.type;
            day.dinner = null;
            if (radio.dataset.type === 'delivery') {
              day.side = null;
            }
            this.openDinnerModal(index);
          };
        });
        
        this.attachBentoListeners('dinner', dinnerOptions);
        if (day.dinnerType !== 'delivery') {
          this.attachBentoListeners('side');
        }
      }
      
      openMenu() {
        this.openModal({
          title: 'Quick Actions',
          subtitle: 'Manage your week',
          bodyHTML: `
            <div class="menu-grid">
              <div class="menu-item" id="menuTheme">
                <div class="menu-item-icon">${this.state.theme === 'dark' ? '🌙' : '☀️'}</div>
                <div class="menu-item-content">
                  <h4>Toggle Theme</h4>
                  <p>${this.state.theme === 'dark' ? 'Switch to light' : 'Switch to dark'}</p>
                </div>
              </div>
              <div class="menu-item" id="menuRandomize">
                <div class="menu-item-icon">🎲</div>
                <div class="menu-item-content">
                  <h4>Randomize Week</h4>
                  <p>Auto-fill empty meals</p>
                </div>
              </div>
              <div class="menu-item" id="menuShopping">
                <div class="menu-item-icon">🛒</div>
                <div class="menu-item-content">
                  <h4>Shopping List</h4>
                  <p>View & share</p>
                </div>
              </div>
              <div class="menu-item" id="menuClear">
                <div class="menu-item-icon">🗑️</div>
                <div class="menu-item-content">
                  <h4>Clear Week</h4>
                  <p>Reset all selections</p>
                </div>
              </div>
            </div>
          `,
          footer: [{ label: 'Close', onClick: () => this.closeModal() }]
        });
        
        document.getElementById('menuTheme').onclick = () => {
          this.toggleTheme();
          this.closeModal();
        };
        
        document.getElementById('menuRandomize').onclick = () => {
          this.randomizeWeek();
          this.closeModal();
          this.showToast('Week randomized! 🎲');
        };
        
        document.getElementById('menuShopping').onclick = () => {
          this.openGroceryList();
        };
        
        document.getElementById('menuClear').onclick = () => {
          if (confirm('Clear all meals for this week?')) {
            this.state.days = this.state.days.map(day => ({
              ...day,
              lunch: null,
              dinner: null,
              side: null,
              busy: false,
              dinnerType: 'regular',
              customLunch: null,
              customDinner: null,
              customSide: null
            }));
            this.saveState();
            this.closeModal();
            this.render();
            this.showToast('Week cleared');
          }
        };
      }
      
      renderBentoGrid(type, selected, options) {
        return `
          <div class="bento-grid" data-type="${type}">
            ${options.map(item => `
              <div class="bento-item ${selected === item ? 'selected' : ''}" data-value="${item}">
                <span class="bento-emoji">${MEAL_EMOJIS[item] || '🍽️'}</span>
                <span>${item}</span>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      attachBentoListeners(type) {
        const grid = document.querySelector(`.bento-grid[data-type="${type}"]`);
        if (!grid) return;
        
        grid.querySelectorAll('.bento-item').forEach(item => {
          item.onclick = () => {
            const value = item.dataset.value;
            const day = this.state.days[this.currentDayIndex];
            
            grid.querySelectorAll('.bento-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            
            day[type] = value;
            
            if (value === 'Custom') {
              if (type === 'lunch') {
                this.openLunchModal(this.currentDayIndex);
              } else if (type === 'dinner') {
                this.openDinnerModal(this.currentDayIndex);
              }
            }
          };
        });
      }
      
      randomizeWeek() {
        this.state.days = this.state.days.map(day => {
          if (!day.lunch) {
            const lunchOptions = MEAL_DATA.lunch.filter(m => m !== 'None' && m !== 'Custom');
            day.lunch = lunchOptions[Math.floor(Math.random() * lunchOptions.length)];
          }
          
          if (!day.dinner) {
            let dinnerOptions;
            const isWeekend = day.name === 'Saturday' || day.name === 'Sunday';
            
            if (day.busy && day.dinnerType === 'quick') {
              dinnerOptions = MEAL_DATA.dinnerQuick;
            } else if (day.busy && day.dinnerType === 'delivery') {
              dinnerOptions = MEAL_DATA.delivery;
            } else if (!day.busy && isWeekend) {
              dinnerOptions = MEAL_DATA.dinnerWeekend;
            } else {
              dinnerOptions = MEAL_DATA.dinnerRegular;
            }
            
            dinnerOptions = dinnerOptions.filter(m => m !== 'None' && m !== 'Custom');
            day.dinner = dinnerOptions[Math.floor(Math.random() * dinnerOptions.length)];
          }
          
          if (!day.side && day.dinnerType !== 'delivery') {
            const sideOptions = MEAL_DATA.side.filter(m => m !== 'None' && m !== 'Custom');
            day.side = sideOptions[Math.floor(Math.random() * sideOptions.length)];
          }
          
          return day;
        });
        
        this.saveState();
        this.render();
      }
      
      openGroceryList() {
        const groceryData = this.computeGrocery();
        const stores = Object.keys(groceryData).sort();
        
        const bodyHTML = stores.length ? stores.map(store => `
          <div class="store-section">
            <h3 class="store-title">${store}</h3>
            ${groceryData[store].map((item, i) => `
              <div class="grocery-item" data-store="${store}" data-index="${i}">
                <div class="checkbox"></div>
                <div class="grocery-item-text">${INGREDIENT_EMOJIS[item] || ''} ${item}</div>
              </div>
            `).join('')}
          </div>
        `).join('') : '<div class="store-section"><p>No items to shop for</p></div>';
        
        this.openModal({
          title: 'Shopping List',
          subtitle: 'Check off items as you shop',
          bodyHTML,
          footer: [
            { label: 'Close', onClick: () => this.closeModal() },
            {
              label: 'Share',
              type: 'btn-primary',
              onClick: () => this.shareGroceryList(groceryData)
            }
          ]
        });
        
        document.querySelectorAll('.checkbox').forEach(checkbox => {
          checkbox.onclick = () => {
            checkbox.classList.toggle('checked');
            checkbox.parentElement.classList.toggle('checked');
          };
        });
      }
      
      computeGrocery() {
        const grouped = {};
        
        const addItem = (store, item) => {
          if (!grouped[store]) grouped[store] = [];
          if (!grouped[store].includes(item)) {
            grouped[store].push(item);
          }
        };
        
        this.state.days.forEach(day => {
          const meals = [];
          if (day.lunch && day.lunch !== 'None' && day.lunch !== 'Custom') meals.push(day.lunch);
          if (day.dinner && day.dinner !== 'None' && day.dinner !== 'Custom') meals.push(day.dinner);
          if (day.side && day.side !== 'None' && day.side !== 'Custom' && day.dinnerType !== 'delivery') {
            meals.push(day.side);
          }
          
          meals.forEach(meal => {
            const ingredients = INGREDIENTS[meal] || [];
            ingredients.forEach(ing => {
              const store = this.findStoreForItem(ing);
              addItem(store, ing);
            });
          });
        });
        
        return grouped;
      }
      
      findStoreForItem(item) {
        for (const [store, items] of Object.entries(STORES)) {
          if (items.includes(item)) return store;
        }
        return 'Other';
      }
      
      shareGroceryList(groceryData) {
        const lines = ['🛒 Shopping List\n'];
        Object.keys(groceryData).sort().forEach(store => {
          lines.push(`\n${store}:`);
          groceryData[store].forEach(item => {
            lines.push(`• ${INGREDIENT_EMOJIS[item] || ''} ${item}`);
          });
        });
        
        const text = lines.join('\n');
        
        if (navigator.share) {
          navigator.share({
            title: 'Shopping List',
            text
          });
        } else if (navigator.clipboard) {
          navigator.clipboard.writeText(text);
          this.showToast('Copied to clipboard! 📋');
        }
      }
      
      showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, CONFIG.animations.toast);
      }
    }
    
    // Initialize app
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        new MealPlannerApp();
      });
    } else {
      new MealPlannerApp();
    }
  </script>
</body>
</html>
