<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0b">
  <title>Meal Planner</title>
  <style>
    /* ============================================
   DESIGN SYSTEM & CSS VARIABLES
   ============================================ */
    :root {
      /* Color Palette - Rich, sophisticated gradients */
      --gradient-dark: linear-gradient(145deg, #0f0f10 0%, #1a1a2e 50%, #16213e 100%);
      --gradient-light: linear-gradient(180deg, #fafafa 0%, #f5f5f7 100%);

      /* Semantic colors with depth */
      --surface-1: rgba(255, 255, 255, 0.04);
      --surface-2: rgba(255, 255, 255, 0.08);
      --surface-3: rgba(255, 255, 255, 0.12);
      --surface-hover: rgba(255, 255, 255, 0.10);
      --surface-active: rgba(255, 255, 255, 0.06);

      --border-subtle: rgba(255, 255, 255, 0.08);
      --border-default: rgba(255, 255, 255, 0.12);
      --border-strong: rgba(255, 255, 255, 0.18);

      --text-primary: rgba(255, 255, 255, 0.95);
      --text-secondary: rgba(255, 255, 255, 0.70);
      --text-tertiary: rgba(255, 255, 255, 0.50);

      /* Accent colors - Vibrant but refined */
      --accent-primary: #6366f1;
      --accent-primary-dark: #5558e3;
      --accent-primary-glow: rgba(99, 102, 241, 0.25);

      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-danger: #ef4444;
      --accent-info: #60a5fa;

      /* Typography scale - iOS inspired */
      --font-xs: 11px;
      --font-sm: 13px;
      --font-base: 15px;
      --font-md: 17px;
      --font-lg: 20px;
      --font-xl: 24px;
      --font-2xl: 28px;
      --font-3xl: 34px;

      /* Spacing system - 4px base unit */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;

      /* Border radius - Smooth, modern curves */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-2xl: 24px;
      --radius-full: 9999px;

      /* Animations - Natural, fluid motion */
      --ease-out: cubic-bezier(0.0, 0.0, 0.2, 1);
      --ease-in-out: cubic-bezier(0.4, 0.0, 0.2, 1);
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);

      /* Shadows - Subtle depth */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.10);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.20);

      /* Safe areas */
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    /* Light theme overrides */
    :root[data-theme="light"] {
      --gradient-light: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);

      --surface-1: rgba(0, 0, 0, 0.02);
      --surface-2: rgba(0, 0, 0, 0.04);
      --surface-3: rgba(0, 0, 0, 0.06);
      --surface-hover: rgba(0, 0, 0, 0.05);
      --surface-active: rgba(0, 0, 0, 0.03);

      --border-subtle: rgba(0, 0, 0, 0.06);
      --border-default: rgba(0, 0, 0, 0.10);
      --border-strong: rgba(0, 0, 0, 0.15);

      --text-primary: rgba(0, 0, 0, 0.90);
      --text-secondary: rgba(0, 0, 0, 0.60);
      --text-tertiary: rgba(0, 0, 0, 0.40);

      --accent-primary: #5558e3;
      --accent-primary-dark: #4447d1;

      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.08);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.10);
    }

    /* ============================================
   RESET & BASE STYLES
   ============================================ */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
    }

    html {
      height: 100%;
      -webkit-text-size-adjust: 100%;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', system-ui, sans-serif;
      font-size: var(--font-base);
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--gradient-dark);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      overscroll-behavior: none;
    }

    :root[data-theme="light"] body {
      background: var(--gradient-light);
    }

    /* ============================================
   LAYOUT COMPONENTS
   ============================================ */

    /* Header - Premium glass morphism */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: calc(var(--space-3) + var(--safe-top)) var(--space-4) var(--space-3);
      background: rgba(15, 15, 16, 0.75);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.3s var(--ease-in-out);
    }

    :root[data-theme="light"] .header {
      background: rgba(255, 255, 255, 0.80);
    }

    .header-title {
      flex: 1;
      margin: 0;
      font-size: var(--font-lg);
      font-weight: 700;
      letter-spacing: -0.3px;
      background: linear-gradient(135deg, #a78bfa 0%, #fbbf24 50%, #60a5fa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {

      0%,
      100% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }
    }

    /* Icon Button - Enhanced touch target */
    .btn-icon {
      position: relative;
      display: grid;
      place-items: center;
      width: 44px;
      height: 44px;
      padding: 0;
      font-size: 20px;
      background: var(--surface-1);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s var(--ease-out);
      -webkit-tap-highlight-color: transparent;
    }

    .btn-icon:hover {
      background: var(--surface-hover);
      transform: scale(1.05);
    }

    .btn-icon:active {
      transform: scale(0.95);
      background: var(--surface-active);
    }

    /* Theme Toggle - Delightful animation */
    .theme-toggle {
      position: relative;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--surface-2);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all 0.3s var(--ease-out);
    }

    .theme-toggle-label {
      font-size: var(--font-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .theme-toggle-switch {
      position: relative;
      width: 42px;
      height: 24px;
      background: var(--surface-3);
      border-radius: var(--radius-full);
      transition: background 0.3s var(--ease-out);
    }

    .theme-toggle-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      box-shadow: var(--shadow-sm);
      transition: transform 0.3s var(--ease-spring);
    }

    :root[data-theme="light"] .theme-toggle-knob {
      transform: translateX(18px);
    }

    /* Container */
    .container {
      padding: var(--space-4);
      padding-bottom: calc(var(--space-5) + var(--safe-bottom));
    }

    /* ============================================
   CARDS & DAYS
   ============================================ */

    .days-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .day-card {
      position: relative;
      padding: var(--space-4);
      background: var(--surface-1);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor: pointer;
      transition: all 0.3s var(--ease-out);
      transform-style: preserve-3d;
      will-change: transform;
    }

    .day-card:hover {
      background: var(--surface-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .day-card:active {
      transform: scale(0.98);
    }

    .day-card.incomplete {
      border-style: dashed;
      border-color: var(--border-strong);
      animation: pulse-border 2s ease-in-out infinite;
    }

    @keyframes pulse-border {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-3);
    }

    .day-title {
      font-size: var(--font-md);
      font-weight: 600;
      color: var(--text-primary);
    }

    .day-date {
      font-size: var(--font-sm);
      color: var(--text-secondary);
      margin-left: var(--space-2);
    }

    /* Status Chip */
    .chip {
      display: inline-flex;
      align-items: center;
      padding: var(--space-1) var(--space-3);
      font-size: var(--font-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: var(--radius-full);
      background: var(--surface-2);
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
    }

    .chip.missing {
      background: rgba(239, 68, 68, 0.10);
      border-color: rgba(239, 68, 68, 0.30);
      color: #fca5a5;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    /* ============================================
   MEALS
   ============================================ */

    .meals-grid {
      display: grid;
      gap: var(--space-2);
    }

    .meal-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--surface-2);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      transition: all 0.2s var(--ease-out);
    }

    .meal-item.empty {
      opacity: 0.5;
      filter: grayscale(0.3);
    }

    .meal-item:not(.empty):hover {
      background: var(--surface-3);
      transform: translateX(4px);
    }

    .meal-icon {
      display: grid;
      place-items: center;
      width: 40px;
      height: 40px;
      font-size: var(--font-md);
      font-weight: 700;
      color: white;
      border-radius: var(--radius-md);
      flex-shrink: 0;
    }

    .meal-icon.lunch {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.25);
    }

    .meal-icon.dinner {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }

    .meal-content {
      flex: 1;
      min-width: 0;
    }

    .meal-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-2);
    }

    .meal-title {
      margin: 0;
      font-size: var(--font-base);
      font-weight: 600;
      color: var(--text-primary);
    }

    .meal-description {
      margin: var(--space-1) 0 0;
      font-size: var(--font-sm);
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .meal-placeholder {
      color: var(--text-tertiary);
      font-style: italic;
    }

    /* Busy Toggle Inline */
    .busy-toggle-inline {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1) var(--space-3);
      font-size: var(--font-xs);
      font-weight: 600;
      background: var(--surface-3);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s var(--ease-out);
    }

    .busy-toggle-inline.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .busy-toggle-inline:active {
      transform: scale(0.95);
    }

    /* ============================================
   WEEKEND TOGGLE
   ============================================ */

    .weekend-toggle-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4);
      margin-top: var(--space-3);
      background: var(--surface-1);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .weekend-toggle-label {
      font-size: var(--font-base);
      font-weight: 600;
      color: var(--text-primary);
    }

    .weekend-toggle-switch {
      position: relative;
      width: 51px;
      height: 31px;
      background: var(--surface-3);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all 0.3s var(--ease-out);
    }

    .weekend-toggle-switch.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    .weekend-toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 27px;
      height: 27px;
      background: white;
      border-radius: 50%;
      box-shadow: var(--shadow-sm);
      transition: transform 0.3s var(--ease-spring);
    }

    .weekend-toggle-switch.active::after {
      transform: translateX(20px);
    }

    /* ============================================
   MODAL
   ============================================ */

    .modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      padding: var(--space-3);
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.35s var(--ease-out);
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      background: rgba(25, 25, 30, 0.95);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
      transform: translateY(100%);
      transition: transform 0.45s var(--ease-spring);
      overflow: hidden;
      max-height: 85vh;
    }

    :root[data-theme="light"] .modal {
      background: rgba(255, 255, 255, 0.98);
    }

    .modal-overlay.show .modal {
      transform: translateY(0);
    }

    .modal-handle {
      width: 36px;
      height: 5px;
      margin: var(--space-3) auto var(--space-2);
      background: var(--border-strong);
      border-radius: var(--radius-full);
      opacity: 0.5;
    }

    .modal-header {
      padding: 0 var(--space-5) var(--space-3);
      text-align: center;
    }

    .modal-title {
      margin: 0;
      font-size: var(--font-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-subtitle {
      margin: var(--space-1) 0 0;
      font-size: var(--font-sm);
      color: var(--text-secondary);
    }

    .modal-body {
      max-height: 60vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0;
    }

    .modal-footer {
      display: flex;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      background: var(--surface-1);
      border-top: 1px solid var(--border-subtle);
    }

    /* ============================================
   BUTTONS
   ============================================ */

    .btn {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-base);
      font-weight: 600;
      text-align: center;
      background: var(--surface-2);
      color: var(--text-primary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s var(--ease-out);
      -webkit-tap-highlight-color: transparent;
    }

    .btn:hover {
      background: var(--surface-hover);
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-primary-dark) 100%);
      color: white;
      border: none;
      box-shadow: 0 4px 12px var(--accent-primary-glow);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px var(--accent-primary-glow);
    }

    .btn-primary:active {
      transform: scale(0.97);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
    }

    /* ============================================
   MENU GRID
   ============================================ */

    .menu-grid {
      display: grid;
      gap: var(--space-2);
      padding: var(--space-3);
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--surface-1);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.2s var(--ease-out);
    }

    .menu-item:hover {
      background: var(--surface-hover);
      transform: translateX(4px);
    }

    .menu-item:active {
      transform: scale(0.98);
    }

    .menu-item-icon {
      font-size: var(--font-xl);
      width: 32px;
      text-align: center;
    }

    .menu-item-content h4 {
      margin: 0;
      font-size: var(--font-base);
      font-weight: 600;
      color: var(--text-primary);
    }

    .menu-item-content p {
      margin: var(--space-1) 0 0;
      font-size: var(--font-sm);
      color: var(--text-secondary);
    }

    /* ============================================
   TABS & CONTROLS
   ============================================ */

    .tabs {
      display: flex;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      position: sticky;
      top: 0;
      background: inherit;
      z-index: 10;
    }

    .tab {
      flex: 1;
      padding: var(--space-3);
      font-size: var(--font-base);
      font-weight: 600;
      text-align: center;
      background: var(--surface-1);
      color: var(--text-secondary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s var(--ease-out);
    }

    .tab:hover {
      background: var(--surface-hover);
    }

    .tab.active {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-primary-dark) 100%);
      color: white;
      border: none;
    }

    .controls {
      display: flex;
      gap: var(--space-2);
      padding: var(--space-3);
      align-items: center;
      flex-wrap: wrap;
    }

    .switch-control {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-sm);
      font-weight: 600;
      background: var(--surface-2);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s var(--ease-out);
    }

    .switch-control.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .radio-group {
      display: flex;
      gap: var(--space-2);
    }

    .radio {
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-sm);
      font-weight: 600;
      background: var(--surface-2);
      color: var(--text-secondary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s var(--ease-out);
    }

    .radio:hover {
      background: var(--surface-hover);
    }

    .radio.active {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-primary-dark) 100%);
      color: white;
      border: none;
    }

    /* ============================================
   BENTO GRID
   ============================================ */

    .bento-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-2);
      padding: var(--space-3);
    }

    .bento-item {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      min-height: 72px;
      padding: var(--space-3) var(--space-2);
      background: var(--surface-1);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.2s var(--ease-out);
      overflow: hidden;
    }

    .bento-item:hover {
      background: var(--surface-hover);
      transform: scale(1.05);
    }

    .bento-item:active {
      transform: scale(0.98);
    }

    .bento-item.selected {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(99, 102, 241, 0.05) 100%);
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.20) inset;
    }

    .bento-item.selected::before {
      content: '✓';
      position: absolute;
      top: var(--space-2);
      right: var(--space-2);
      display: grid;
      place-items: center;
      width: 20px;
      height: 20px;
      background: var(--accent-primary);
      color: white;
      font-size: var(--font-xs);
      font-weight: 700;
      border-radius: 50%;
    }

    .bento-emoji {
      font-size: var(--font-lg);
      opacity: 0.85;
    }

    .bento-label {
      font-size: var(--font-xs);
      font-weight: 600;
      text-align: center;
      line-height: 1.2;
      color: var(--text-primary);
    }

    /* ============================================
   FORMS
   ============================================ */

    .input-group {
      padding: 0 var(--space-3) var(--space-3);
    }

    .input-label {
      display: block;
      margin: 0 0 var(--space-2);
      font-size: var(--font-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
    }

    .input {
      width: 100%;
      padding: var(--space-3);
      font-size: var(--font-base);
      background: var(--surface-1);
      color: var(--text-primary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      transition: all 0.2s var(--ease-out);
    }

    .input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px var(--accent-primary-glow);
    }

    /* ============================================
   GROCERY LIST
   ============================================ */

    .store-section {
      margin: var(--space-3);
      padding: var(--space-4);
      background: var(--surface-1);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
    }

    .store-title {
      margin: 0 0 var(--space-3);
      font-size: var(--font-base);
      font-weight: 600;
      color: var(--text-primary);
    }

    .grocery-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      margin-bottom: var(--space-2);
      background: var(--surface-2);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      transition: all 0.2s var(--ease-out);
    }

    .grocery-item:last-child {
      margin-bottom: 0;
    }

    .checkbox {
      position: relative;
      width: 24px;
      height: 24px;
      background: var(--surface-3);
      border: 2px solid var(--border-strong);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s var(--ease-out);
    }

    .checkbox.checked {
      background: var(--accent-success);
      border-color: var(--accent-success);
    }

    .checkbox.checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: var(--font-sm);
      font-weight: 700;
    }

    .grocery-item-text {
      flex: 1;
      font-size: var(--font-base);
      color: var(--text-primary);
      transition: all 0.2s var(--ease-out);
    }

    .grocery-item.checked .grocery-item-text {
      opacity: 0.5;
      text-decoration: line-through;
    }

    .add-item-row {
      display: grid;
      grid-template-columns: 1fr 2fr auto;
      gap: var(--space-2);
      margin-top: var(--space-3);
    }

    /* ============================================
   SUMMARY
   ============================================ */

    .summary-container {
      margin: var(--space-3);
      padding: var(--space-4);
      background: var(--surface-1);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      font-family: 'SF Mono', ui-monospace, Menlo, Consolas, monospace;
      font-size: var(--font-xs);
      line-height: 1.6;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 50vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ============================================
   TOAST
   ============================================ */

    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(100px + var(--safe-bottom));
      transform: translateX(-50%) translateY(20px);
      padding: var(--space-3) var(--space-5);
      background: rgba(25, 25, 30, 0.95);
      color: white;
      font-size: var(--font-sm);
      font-weight: 600;
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-full);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow-xl);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s var(--ease-out);
      z-index: 2000;
    }

    :root[data-theme="light"] .toast {
      background: rgba(255, 255, 255, 0.95);
      color: var(--text-primary);
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    /* ============================================
   UTILITIES
   ============================================ */

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* ============================================
   ANIMATIONS
   ============================================ */

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slide-up {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fade-in 0.3s var(--ease-out) forwards;
    }

    /* ============================================
   RESPONSIVE & ACCESSIBILITY
   ============================================ */

    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    @media (max-width: 375px) {
      .bento-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Focus visible for keyboard navigation */
    :focus-visible {
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header" role="banner">
    <button id="menuBtn" class="btn-icon" aria-label="Open menu">
      <span aria-hidden="true">☰</span>
    </button>
    <h1 class="header-title">Meal Planner</h1>
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
      <span class="theme-toggle-label">Dark</span>
      <div class="theme-toggle-switch">
        <div class="theme-toggle-knob"></div>
      </div>
    </button>
  </header>

  <!-- Main Content -->
  <main class="container" role="main">
    <div id="daysList" class="days-list" aria-label="Week days"></div>
  </main>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-handle" aria-hidden="true"></div>
      <div class="modal-header">
        <h2 id="modalTitle" class="modal-title"></h2>
        <p id="modalSubtitle" class="modal-subtitle"></p>
      </div>
      <div id="modalBody" class="modal-body"></div>
      <div id="modalFooter" class="modal-footer"></div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    /**
     * Meal Planner App - Modern Refactored Version
     * 
     * Architecture:
     * - Modular ES6+ code structure
     * - Reactive state management
     * - Component-based rendering
     * - Event delegation for performance
     * - Accessibility-first approach
     */

    // ============================================
    // CONSTANTS & CONFIGURATION
    // ============================================

    const CONFIG = {
      storageKey: 'mp_v2_state',
      animations: {
        modal: 450,
        toast: 1500,
        transition: 200
      },
      touch: {
        minSwipeDistance: 50,
        tapDelay: 300
      }
    };

    const MEAL_DATA = {
      lunch: [
        "Ravioli burro e salvia", "Spaghetti al limone", "Pasta e ceci", "Pasta col tonno",
        "Pasta sugo tonno", "Piadine prosciutto provolone", "Uova fritte", "Pasta al pesto",
        "Pasta coi pomodorini", "Lenticchie", "Spaghetti aglio e olio", "Carbonara",
        "Frittata di pasta", "Pasta e fagioli"
      ],
      dinnerRegular: [
        "Salmone col riso", "Frittata di zucchine", "Polpette", "Pollo al limone",
        "Merluzzo", "Hamburger", "Cotolette", "Salsicce", "Minestrone", "Pollo al forno",
        "Scaloppine al limone", "Caprese"
      ],
      dinnerQuick: [
        "Cordon bleu", "Würstel", "Dumplings", "Fish sticks", "Pollo allo spiedo"
      ],
      delivery: [
        "Pizza Delivery", "Greco Delivery", "Chinese Delivery", "Vietnamese Delivery", "Ramen Delivery"
      ],
      dinnerWeekend: [
        "Pasta al forno", "Parmigiana di melanzane", "Zucchine ripiene", "Lasagna",
        "Spezzatino con patate", "Tortellini con la panna", "Tortellini col sugo",
        "Pasta col ragù", "Polpettone", "Scrimpelle mbuss", "Polenta col sugo",
        "Cannelloni", "Bistecca"
      ],
      side: [
        "Purè di patate", "Broccoli al vapore", "Insalata di pomodori", "Tater tots",
        "Barbabietole", "Insalata di mais", "Patate lesse", "Carote al forno",
        "Carote a insalata", "Zucchine trifolate", "Insalata di cetrioli", "Insalata"
      ]
    };

    const INGREDIENTS = {
      "Ravioli burro e salvia": ["Ravioli", "Sage"],
      "Spaghetti al limone": ["Spaghetti", "Lemons"],
      "Pasta e ceci": ["Ditalini", "Chickpeas"],
      "Pasta col tonno": ["Spaghetti", "Tuna"],
      "Pasta sugo tonno": ["Pasta", "Tuna", "Tomato sauce"],
      "Piadine prosciutto provolone": ["Flatbreads", "Prosciutto", "Provolone cheese"],
      "Uova fritte": ["Eggs"],
      "Pasta al pesto": ["Pasta", "Pesto"],
      "Pasta coi pomodorini": ["Pasta", "Cherry tomatoes"],
      "Lenticchie": ["Lentils", "Croutons"],
      "Spaghetti aglio e olio": ["Spaghetti"],
      "Carbonara": ["Spaghetti", "Eggs", "Bacon"],
      "Frittata di pasta": ["Eggs"],
      "Pasta e fagioli": ["Pasta", "Beans"],
      "Salmone col riso": ["Salmon", "Rice"],
      "Frittata di zucchine": ["Eggs", "Zucchini"],
      "Polpette": ["Ground beef", "Eggs", "Bread", "Breadcrumbs"],
      "Pollo al limone": ["Chicken breast", "Lemons"],
      "Merluzzo": ["Cod"],
      "Hamburger": ["Buns", "Hamburger buns", "American cheese slices", "Lettuce", "Tomatoes"],
      "Cotolette": ["Breaded cutlets", "Breadcrumbs", "Eggs"],
      "Salsicce": ["Sausages"],
      "Minestrone": ["Vegetable soup mix", "Pasta", "Beans"],
      "Pollo al forno": ["Chicken thighs"],
      "Scaloppine al limone": ["Veal cutlets", "Lemons"],
      "Caprese": ["Fresh mozzarella", "Tomatoes"],
      "Cordon bleu": ["Cordon bleu"],
      "Würstel": ["Hot dogs"],
      "Dumplings": ["Dumplings"],
      "Fish sticks": ["Fish sticks"],
      "Pollo allo spiedo": ["Whole chicken"],
      "Pasta al forno": ["Pasta", "Tomato sauce", "Shredded mozzarella"],
      "Parmigiana di melanzane": ["Eggplant", "Tomato sauce", "Shredded mozzarella"],
      "Zucchine ripiene": ["Zucchini", "Ground beef", "Bread"],
      "Lasagna": ["Lasagna noodles", "Meat sauce"],
      "Spezzatino con patate": ["Beef", "Potatoes", "Onion", "Carrots"],
      "Tortellini con la panna": ["Tortellini", "Cream"],
      "Tortellini col sugo": ["Tortellini", "Tomato sauce"],
      "Pasta col ragù": ["Pasta", "Meat sauce"],
      "Polpettone": ["Ground beef", "Eggs", "Bacon", "Bread"],
      "Scrimpelle mbuss": ["Eggs", "Flour", "Milk", "Broth"],
      "Polenta col sugo": ["Polenta", "Tomato sauce", "Sausages"],
      "Cannelloni": ["Cannelloni", "Ricotta", "Spinach"],
      "Bistecca": ["Steak"],
      "Purè di patate": ["Potatoes"],
      "Broccoli al vapore": ["Broccoli"],
      "Insalata di pomodori": ["Tomatoes"],
      "Tater tots": ["Tater tots"],
      "Barbabietole": ["Beets"],
      "Insalata di mais": ["Corn"],
      "Patate lesse": ["Potatoes"],
      "Carote al forno": ["Carrots"],
      "Carote a insalata": ["Carrots"],
      "Zucchine trifolate": ["Zucchini"],
      "Insalata di cetrioli": ["Cucumbers"],
      "Insalata": ["Lettuce"]
    };

    const STORES = {
      Aldi: ["Bacon", "Beets", "Cannelloni", "Carrots", "Chicken thighs", "Breaded cutlets", "Croutons", "Dumplings", "Beans", "Fish sticks", "Lemons", "Corn", "Shredded mozzarella", "Potatoes", "Chicken breast", "Flatbreads", "Tomatoes", "Cherry tomatoes", "Provolone cheese", "Prosciutto", "Ravioli", "Sausages", "American cheese slices", "Spinach", "Tater tots", "Tortellini", "Eggs", "Hot dogs", "Zucchini", "Ground beef", "Ricotta", "Milk", "Pesto sauce"],
      Wegmans: ["Steak", "Broccoli", "Cucumbers", "Onion", "Hamburger buns", "Butter", "Lettuce", "Lentils", "Eggplant", "Cod", "Whole chicken", "Sage", "Salmon", "Bread", "Tomato sauce"],
      Amazon: ["Pasta", "Tuna", "Breadcrumbs", "Rice"],
      Other: []
    };

    const SYNONYMS = {
      'Buns': 'Hamburger buns',
      'Pesto': 'Pesto sauce'
    };

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    const Utils = {
      // Date helpers
      getNextMonday(date = new Date()) {
        const day = date.getDay();
        const diff = (8 - day) % 7 || 7;
        const monday = new Date(date);
        monday.setDate(date.getDate() + diff);
        monday.setHours(0, 0, 0, 0);
        return monday;
      },

      addDays(date, days) {
        const result = new Date(date);
        result.setDate(date.getDate() + days);
        return result;
      },

      formatDate(date) {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      },

      // Array helpers
      pickRandom(array) {
        return array[Math.floor(Math.random() * array.length)] || null;
      },

      // DOM helpers
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },

      // Storage helpers
      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
    };

    // ============================================
    // STATE MANAGEMENT
    // ============================================

    class StateManager {
      constructor() {
        this.state = this.load() || this.createInitialState();
        this.listeners = new Set();
      }

      createInitialState() {
        const weekStart = Utils.getNextMonday();
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        return {
          weekStart: weekStart.toISOString(),
          showWeekend: true,
          theme: 'dark',
          days: days.map((name, index) => ({
            name,
            date: Utils.addDays(weekStart, index).toISOString(),
            lunch: null,
            dinner: null,
            side: null,
            busy: false,
            dinnerType: 'regular'
          })),
          groceryExtras: []
        };
      }

      get() {
        return this.state;
      }

      set(updates) {
        this.state = { ...this.state, ...updates };
        this.save();
        this.notify();
      }

      updateDay(index, updates) {
        const days = [...this.state.days];
        days[index] = { ...days[index], ...updates };
        this.set({ days });
      }

      save() {
        try {
          localStorage.setItem(CONFIG.storageKey, JSON.stringify(this.state));
        } catch (e) {
          console.error('Failed to save state:', e);
        }
      }

      load() {
        try {
          const stored = localStorage.getItem(CONFIG.storageKey);
          return stored ? JSON.parse(stored) : null;
        } catch (e) {
          console.error('Failed to load state:', e);
          return null;
        }
      }

      subscribe(callback) {
        this.listeners.add(callback);
        return () => this.listeners.delete(callback);
      }

      notify() {
        this.listeners.forEach(callback => callback(this.state));
      }

      reset() {
        const theme = this.state.theme;
        this.state = this.createInitialState();
        this.state.theme = theme;
        this.save();
        this.notify();
      }
    }

    // ============================================
    // COMPONENTS
    // ============================================

    class MealPlannerApp {
      constructor() {
        this.state = new StateManager();
        this.currentTab = 'lunch';
        this.currentDayIndex = null;
        this.init();
      }

      init() {
        this.checkWeekRollover();
        this.applyTheme();
        this.attachEventListeners();
        this.render();

        // Subscribe to state changes
        this.state.subscribe(() => this.render());
      }

      checkWeekRollover() {
        const current = Utils.getNextMonday().toISOString();
        if (this.state.get().weekStart !== current) {
          this.state.reset();
        }
      }

      applyTheme() {
        const theme = this.state.get().theme;
        document.documentElement.setAttribute('data-theme', theme);
        document.querySelector('.theme-toggle-label').textContent =
          theme === 'light' ? 'Light' : 'Dark';
      }

      toggleTheme() {
        const newTheme = this.state.get().theme === 'light' ? 'dark' : 'light';
        this.state.set({ theme: newTheme });
        this.applyTheme();
      }

      attachEventListeners() {
        // Theme toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
          this.toggleTheme();
        });

        // Menu button
        document.getElementById('menuBtn').addEventListener('click', () => {
          this.openMenu();
        });

        // Modal overlay click to close
        const overlay = document.getElementById('modalOverlay');
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            this.closeModal();
          }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && overlay.classList.contains('show')) {
            this.closeModal();
          }
        });
      }

      render() {
        this.renderDays();
      }

      renderDays() {
        const state = this.state.get();
        const days = state.days.filter(d =>
          state.showWeekend || (d.name !== 'Sat' && d.name !== 'Sun')
        );

        const daysHtml = days.map((day, index) => {
          const realIndex = state.days.indexOf(day);
          const lunchMissing = !day.lunch;
          const dinnerMissing = !day.dinner;
          const sideMissing = day.dinnerType !== 'delivery' && !day.side;
          const incomplete = lunchMissing || dinnerMissing || sideMissing;

          const lunchText = day.lunch || '<span class="meal-placeholder">Tap to select</span>';
          const dinnerText = day.dinner || '<span class="meal-placeholder">Tap to select</span>';
          const sideText = day.dinnerType === 'delivery' ?
            '<span class="meal-placeholder">—</span>' :
            (day.side || '<span class="meal-placeholder">Select</span>');

          let dinnerLabel = 'Dinner';
          if (day.busy && day.dinnerType === 'quick') dinnerLabel += ' • Quick';
          if (day.busy && day.dinnerType === 'delivery') dinnerLabel += ' • Order In';

          return `
        <article class="day-card ${incomplete ? 'incomplete' : ''}" 
                 data-index="${realIndex}" 
                 role="button" 
                 tabindex="0"
                 aria-label="${day.name} ${Utils.formatDate(new Date(day.date))}">
          <div class="day-header">
            <div>
              <span class="day-title">${day.name}</span>
              <span class="day-date">${Utils.formatDate(new Date(day.date))}</span>
            </div>
            ${incomplete ? '<span class="chip missing">Missing</span>' : ''}
          </div>
          
          <div class="meals-grid">
            <div class="meal-item ${lunchMissing ? 'empty' : ''}">
              <div class="meal-icon lunch" aria-hidden="true">L</div>
              <div class="meal-content">
                <h4 class="meal-title">Lunch</h4>
                <p class="meal-description">${lunchText}</p>
              </div>
            </div>
            
            <div class="meal-item ${dinnerMissing ? 'empty' : ''}">
              <div class="meal-icon dinner" aria-hidden="true">D</div>
              <div class="meal-content">
                <div class="meal-header-row">
                  <h4 class="meal-title">${dinnerLabel}</h4>
                  <button class="busy-toggle-inline ${day.busy ? 'active' : ''}" 
                          data-index="${realIndex}"
                          aria-label="${day.busy ? 'Busy day on' : 'Busy day off'}">
                    ${day.busy ? '✓ Busy' : 'Busy'}
                  </button>
                </div>
                <p class="meal-description">
                  ${dinnerText}
                  ${day.dinnerType !== 'delivery' ? ` • Side: ${sideText}` : ''}
                </p>
              </div>
            </div>
          </div>
        </article>
      `;
        }).join('');

        const weekendToggleHtml = `
      <div class="weekend-toggle-card">
        <div class="weekend-toggle-label">Weekend Planning</div>
        <div id="weekendSwitch" 
             class="weekend-toggle-switch ${state.showWeekend ? 'active' : ''}"
             role="switch"
             aria-checked="${state.showWeekend}"
             tabindex="0"></div>
      </div>
    `;

        document.getElementById('daysList').innerHTML = daysHtml + weekendToggleHtml;

        // Attach event listeners
        this.attachDayListeners();
      }

      attachDayListeners() {
        // Day cards
        document.querySelectorAll('.day-card').forEach(card => {
          card.addEventListener('click', (e) => {
            if (!e.target.closest('.busy-toggle-inline')) {
              this.openDayModal(parseInt(card.dataset.index));
            }
          });

          card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              this.openDayModal(parseInt(card.dataset.index));
            }
          });
        });

        // Busy toggles
        document.querySelectorAll('.busy-toggle-inline').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const index = parseInt(btn.dataset.index);
            const day = this.state.get().days[index];
            const newBusy = !day.busy;

            const updates = { busy: newBusy };
            if (newBusy) {
              updates.dinnerType = 'quick';
              updates.dinner = null;
            } else {
              updates.dinnerType = 'regular';
            }

            this.state.updateDay(index, updates);
          });
        });

        // Weekend switch
        const weekendSwitch = document.getElementById('weekendSwitch');
        if (weekendSwitch) {
          weekendSwitch.addEventListener('click', () => {
            this.state.set({ showWeekend: !this.state.get().showWeekend });
          });

          weekendSwitch.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              this.state.set({ showWeekend: !this.state.get().showWeekend });
            }
          });
        }
      }

      openModal({ title, subtitle = '', bodyHTML = '', footer = [] }) {
        const overlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubtitle = document.getElementById('modalSubtitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');

        modalTitle.textContent = title || '';
        modalSubtitle.textContent = subtitle || '';
        modalBody.innerHTML = bodyHTML || '';

        modalFooter.innerHTML = '';
        footer.forEach(btn => {
          const button = document.createElement('button');
          button.className = `btn ${btn.type || ''}`;
          button.textContent = btn.label;
          button.addEventListener('click', btn.onClick);
          modalFooter.appendChild(button);
        });

        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');

        // Focus management
        setTimeout(() => {
          const firstButton = modalFooter.querySelector('button');
          if (firstButton) firstButton.focus();
        }, CONFIG.animations.modal);
      }

      closeModal() {
        const overlay = document.getElementById('modalOverlay');
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
      }

      openMenu() {
        this.openModal({
          title: 'Menu',
          subtitle: 'Quick actions',
          bodyHTML: `
        <div class="menu-grid">
          <div class="menu-item" id="menuRandomize">
            <div class="menu-item-icon">🎲</div>
            <div class="menu-item-content">
              <h4>Randomize Week</h4>
              <p>Auto-fill all meals</p>
            </div>
          </div>
          <div class="menu-item" id="menuShopping">
            <div class="menu-item-icon">🛒</div>
            <div class="menu-item-content">
              <h4>Shopping List</h4>
              <p>Grouped by store</p>
            </div>
          </div>
          <div class="menu-item" id="menuSummary">
            <div class="menu-item-icon">📋</div>
            <div class="menu-item-content">
              <h4>Weekly Summary</h4>
              <p>Share your meal plan</p>
            </div>
          </div>
          <div class="menu-item" id="menuClear">
            <div class="menu-item-icon">🗑️</div>
            <div class="menu-item-content">
              <h4>Clear Week</h4>
              <p>Reset all selections</p>
            </div>
          </div>
        </div>
      `,
          footer: [
            { label: 'Close', onClick: () => this.closeModal() }
          ]
        });

        // Attach menu item listeners
        document.getElementById('menuRandomize').onclick = () => {
          this.randomizeWeek();
          this.closeModal();
          this.showToast('Week randomized! 🎲');
        };

        document.getElementById('menuShopping').onclick = () => {
          this.openGroceryList();
        };

        document.getElementById('menuSummary').onclick = () => {
          this.openSummary();
        };

        document.getElementById('menuClear').onclick = () => {
          if (confirm('Clear all meals for this week?')) {
            this.state.reset();
            this.closeModal();
            this.showToast('Week cleared');
          }
        };
      }

      openDayModal(index) {
        this.currentDayIndex = index;
        const day = this.state.get().days[index];

        this.openModal({
          title: `${day.name} • ${Utils.formatDate(new Date(day.date))}`,
          subtitle: 'Select your meals',
          bodyHTML: `
        <div class="tabs">
          <button class="tab ${this.currentTab === 'lunch' ? 'active' : ''}" data-tab="lunch">
            Lunch
          </button>
          <button class="tab ${this.currentTab === 'dinner' ? 'active' : ''}" data-tab="dinner">
            Dinner
          </button>
        </div>
        <div id="tabContent"></div>
      `,
          footer: [
            { label: 'Cancel', onClick: () => this.closeModal() },
            {
              label: 'Save',
              type: 'btn-primary',
              onClick: () => {
                this.state.save();
                this.closeModal();
                this.showToast('Saved! ✓');
              }
            }
          ]
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => {
            this.currentTab = tab.dataset.tab;
            document.querySelectorAll('.tab').forEach(t =>
              t.classList.toggle('active', t === tab)
            );
            this.renderTabContent();
          });
        });

        this.renderTabContent();
      }

      renderTabContent() {
        const day = this.state.get().days[this.currentDayIndex];
        const content = document.getElementById('tabContent');

        if (this.currentTab === 'lunch') {
          content.innerHTML = this.renderBentoGrid('lunch', day.lunch, MEAL_DATA.lunch);
          this.attachBentoListeners('lunch');
        } else {
          const isWeekend = day.name === 'Sat' || day.name === 'Sun';
          let dinnerOptions = MEAL_DATA.dinnerRegular;

          if (day.busy && day.dinnerType === 'quick') {
            dinnerOptions = MEAL_DATA.dinnerQuick;
          } else if (day.busy && day.dinnerType === 'delivery') {
            dinnerOptions = MEAL_DATA.delivery;
          } else if (!day.busy && isWeekend) {
            dinnerOptions = MEAL_DATA.dinnerWeekend;
          }

          content.innerHTML = `
        <div class="controls">
          <button id="busyToggle" class="switch-control ${day.busy ? 'active' : ''}">
            ${day.busy ? '✓ Busy Day' : 'Busy Day'}
          </button>
          ${day.busy ? `
            <div class="radio-group">
              <button class="radio ${day.dinnerType === 'quick' ? 'active' : ''}" data-type="quick">
                Quick
              </button>
              <button class="radio ${day.dinnerType === 'delivery' ? 'active' : ''}" data-type="delivery">
                Delivery
              </button>
            </div>
          ` : ''}
        </div>
        
        <div id="dinnerBento">
          ${this.renderBentoGrid('dinner', day.dinner, dinnerOptions)}
        </div>
        
        ${day.dinnerType !== 'delivery' ? `
          <div class="input-group">
            <label class="input-label">Side Dish</label>
          </div>
          <div id="sideBento">
            ${this.renderBentoGrid('side', day.side, MEAL_DATA.side)}
          </div>
        ` : ''}
      `;

          // Busy toggle
          document.getElementById('busyToggle').onclick = () => {
            const newBusy = !day.busy;
            const updates = { busy: newBusy };

            if (newBusy) {
              updates.dinnerType = 'quick';
              updates.dinner = null;
            } else {
              updates.dinnerType = 'regular';
            }

            this.state.updateDay(this.currentDayIndex, updates);
            this.renderTabContent();
          };

          // Type radios
          document.querySelectorAll('.radio[data-type]').forEach(radio => {
            radio.onclick = () => {
              const type = radio.dataset.type;
              const updates = { dinnerType: type };

              if (type === 'delivery') {
                updates.side = null;
              }
              updates.dinner = null;

              this.state.updateDay(this.currentDayIndex, updates);
              this.renderTabContent();
            };
          });

          this.attachBentoListeners('dinner', dinnerOptions);
          if (day.dinnerType !== 'delivery') {
            this.attachBentoListeners('side');
          }
        }
      }

      renderBentoGrid(type, selected, options = MEAL_DATA[type]) {
        return `
      <div class="bento-grid" data-type="${type}">
        ${options.map(item => `
          <div class="bento-item ${selected === item ? 'selected' : ''}" 
               data-value="${item}"
               role="button"
               tabindex="0"
               aria-pressed="${selected === item}">
            <span class="bento-emoji" aria-hidden="true">🍽️</span>
            <span class="bento-label">${item}</span>
          </div>
        `).join('')}
      </div>
    `;
      }

      attachBentoListeners(type, options) {
        const grid = document.querySelector(`.bento-grid[data-type="${type}"]`);
        if (!grid) return;

        grid.querySelectorAll('.bento-item').forEach(item => {
          const handler = () => {
            const value = item.dataset.value;
            grid.querySelectorAll('.bento-item').forEach(i => {
              i.classList.remove('selected');
              i.setAttribute('aria-pressed', 'false');
            });
            item.classList.add('selected');
            item.setAttribute('aria-pressed', 'true');

            const updates = {};
            updates[type] = value;
            this.state.updateDay(this.currentDayIndex, updates);
          };

          item.addEventListener('click', handler);
          item.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handler();
            }
          });
        });
      }

      randomizeWeek() {
        const days = this.state.get().days.map(day => {
          const isWeekend = day.name === 'Sat' || day.name === 'Sun';
          const dinnerOptions = isWeekend ? MEAL_DATA.dinnerWeekend : MEAL_DATA.dinnerRegular;

          return {
            ...day,
            lunch: Utils.pickRandom(MEAL_DATA.lunch),
            dinner: Utils.pickRandom(dinnerOptions),
            side: Utils.pickRandom(MEAL_DATA.side),
            busy: false,
            dinnerType: 'regular'
          };
        });

        this.state.set({ days });
      }

      openGroceryList() {
        const groceryData = this.computeGrocery();
        const stores = Object.keys(groceryData).sort();

        const bodyHTML = stores.length ? stores.map(store => `
      <div class="store-section" data-store="${store}">
        <h3 class="store-title">${store}</h3>
        ${groceryData[store].map((item, i) => `
          <div class="grocery-item ${item.checked ? 'checked' : ''}" data-index="${i}">
            <div class="checkbox ${item.checked ? 'checked' : ''}" 
                 role="checkbox" 
                 aria-checked="${item.checked}"
                 tabindex="0"></div>
            <div class="grocery-item-text">${item.item}</div>
          </div>
        `).join('')}
        <div class="add-item-row">
          <input class="input store-input" placeholder="Store" value="${store}">
          <input class="input item-input" placeholder="Item name">
          <button class="btn add-btn">Add</button>
        </div>
      </div>
    `).join('') : `
      <div class="store-section">
        <p class="grocery-item-text">No items yet. Add them below.</p>
        <div class="add-item-row">
          <input class="input store-input" placeholder="Store">
          <input class="input item-input" placeholder="Item name">
          <button class="btn add-btn">Add</button>
        </div>
      </div>
    `;

        this.openModal({
          title: 'Shopping List',
          subtitle: 'Check off items as you shop',
          bodyHTML,
          footer: [
            { label: 'Close', onClick: () => this.closeModal() }
          ]
        });

        // Checkbox interactions
        document.querySelectorAll('.checkbox').forEach(checkbox => {
          checkbox.onclick = () => {
            checkbox.classList.toggle('checked');
            checkbox.parentElement.classList.toggle('checked');
            const checked = checkbox.classList.contains('checked');
            checkbox.setAttribute('aria-checked', checked);
          };
        });

        // Add item buttons
        document.querySelectorAll('.add-btn').forEach(btn => {
          btn.onclick = () => {
            const section = btn.closest('.store-section');
            const store = section.querySelector('.store-input').value.trim() || 'Other';
            const item = section.querySelector('.item-input').value.trim();

            if (item) {
              const extras = [...this.state.get().groceryExtras];
              extras.push({ store, item, checked: false });
              this.state.set({ groceryExtras: extras });
              this.openGroceryList();
            }
          };
        });
      }

      computeGrocery() {
        const grouped = {};

        const addItem = (store, item) => {
          if (!grouped[store]) grouped[store] = [];
          if (!grouped[store].some(x => x.item.toLowerCase() === item.toLowerCase())) {
            grouped[store].push({ item, checked: false });
          }
        };

        this.state.get().days.forEach(day => {
          const meals = [day.lunch, day.dinner];
          if (day.dinnerType !== 'delivery' && day.side) {
            meals.push(day.side);
          }

          meals.forEach(meal => {
            if (!meal) return;
            const ingredients = INGREDIENTS[meal] || [];
            ingredients.forEach(ing => {
              const normalizedIng = SYNONYMS[ing] || ing;
              const store = this.findStoreForItem(normalizedIng);
              addItem(store, normalizedIng);
            });
          });
        });

        // Add extras
        this.state.get().groceryExtras.forEach(extra => {
          const store = extra.store || 'Other';
          if (!grouped[store]) grouped[store] = [];
          grouped[store].push({
            item: extra.item,
            checked: extra.checked || false
          });
        });

        return grouped;
      }

      findStoreForItem(item) {
        for (const [store, items] of Object.entries(STORES)) {
          if (items.some(x => x.toLowerCase() === item.toLowerCase())) {
            return store;
          }
        }
        return 'Other';
      }

      openSummary() {
        const lines = [];
        const state = this.state.get();

        lines.push('📅 WEEKLY MEAL PLAN\n');

        state.days.forEach(day => {
          if (!state.showWeekend && (day.name === 'Sat' || day.name === 'Sun')) return;

          const tag = day.busy && day.dinnerType === 'quick' ? ' [Quick]' :
            day.busy && day.dinnerType === 'delivery' ? ' [Delivery]' : '';

          lines.push(`${day.name} ${Utils.formatDate(new Date(day.date))}`);
          lines.push(`  Lunch:  ${day.lunch || '—'}`);
          lines.push(`  Dinner: ${day.dinner || '—'}${tag}`);
          if (day.dinnerType !== 'delivery') {
            lines.push(`  Side:   ${day.side || '—'}`);
          }
          lines.push('');
        });

        lines.push('\n🛒 SHOPPING LIST\n');
        const grocery = this.computeGrocery();
        Object.keys(grocery).sort().forEach(store => {
          lines.push(`${store}:`);
          grocery[store].forEach(item => {
            lines.push(`  • ${item.item}`);
          });
          lines.push('');
        });

        const text = lines.join('\n');

        this.openModal({
          title: 'Weekly Summary',
          subtitle: 'Copy or share your meal plan',
          bodyHTML: `<div class="summary-container">${Utils.escapeHtml(text)}</div>`,
          footer: [
            { label: 'Close', onClick: () => this.closeModal() },
            {
              label: 'Share',
              type: 'btn-primary',
              onClick: async () => {
                try {
                  if (navigator.share) {
                    await navigator.share({
                      title: 'Meal Plan',
                      text
                    });
                  } else if (navigator.clipboard) {
                    await navigator.clipboard.writeText(text);
                    this.showToast('Copied to clipboard! 📋');
                  }
                } catch (e) {
                  console.error('Share failed:', e);
                }
              }
            }
          ]
        });
      }

      showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');

        setTimeout(() => {
          toast.classList.remove('show');
        }, CONFIG.animations.toast);
      }
    }

    // ============================================
    // INITIALIZATION
    // ============================================

    // Wait for DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        new MealPlannerApp();
      });
    } else {
      new MealPlannerApp();
    }

    // Register service worker for PWA capabilities (optional)
    if ('serviceWorker' in navigator && location.protocol === 'https:') {
      navigator.serviceWorker.register('/sw.js').catch(() => {
        // Service worker registration failed, app still works
      });
    }
  </script>
</body>

</html>
