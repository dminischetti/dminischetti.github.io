<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="color-scheme" content="light dark">
<title>Weekly Meal Planner</title>
<style>
/* --- base --- */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
:root{
  --bg-primary:#f2f2f7;--bg-secondary:#fff;--bg-tertiary:#f2f2f7;
  --text-primary:#000;--text-secondary:#3c3c43;--text-tertiary:#8e8e93;
  --border-color:#c6c6c8;--border-secondary:#e5e5ea;
  --accent-primary:#007aff;--accent-success:#34c759;--accent-warning:#ff9500;--accent-danger:#ff3b30;--accent-purple:#af52de;
  --modal-backdrop:rgba(0,0,0,.40);--shadow-sm:0 1px 3px rgba(0,0,0,.12);--shadow-md:0 4px 10px rgba(0,0,0,.18);
  --toggle-bg:#e5e5ea;--input-bg:#fff;--safe-area-top:env(safe-area-inset-top);--safe-area-bottom:env(safe-area-inset-bottom);
  --active-bg:#f7faff;

  /* Elevation & picker palette (light) — MOLTO più distinta */
  --elev-1: 0 6px 18px rgba(0,0,0,.10);
  --elev-2: 0 16px 40px rgba(0,0,0,.24);
  --surface-1:#ffffff;
  --surface-2:#f7f8fb;
  --divider-strong:#c0c4cf;
  --focus-ring: 2px solid rgba(0,122,255,.55);

  /* Picker specific (light) */
  --picker-scrim: rgba(0,0,0,.30);
  --picker-bg:#ffffff;          /* foglio chiaro, ma con ombra forte */
  --picker-header:#f3f5fb;      /* barra superiore distinta */
  --picker-option-bg:#ffffff;
  --picker-option-hover:#eef3ff;
  --picker-option-border:#e1e4ec;
  --picker-selected-bg:#e2ecff;
  --picker-selected-text:#0a3d91;
  --picker-custom-bg:#f3f5fb;
}
[data-theme="dark"]{
  --bg-primary:#000;--bg-secondary:#1c1c1e;--bg-tertiary:#2c2c2e;
  --text-primary:#fff;--text-secondary:#ebebf5;--text-tertiary:#999aa3;
  --border-color:#38383a;--border-secondary:#48484a;
  --accent-primary:#0a84ff;--accent-success:#30d158;--accent-warning:#ff9f0a;--accent-danger:#ff453a;--accent-purple:#bf5af2;
  --modal-backdrop:rgba(0,0,0,.75);--toggle-bg:#38383a;--input-bg:#2c2c2e;
  --active-bg:#1f2733;

  /* Elevation & picker palette (dark) — più scuro del resto */
  --elev-1: 0 10px 26px rgba(0,0,0,.55);
  --elev-2: 0 26px 60px rgba(0,0,0,.85);
  --surface-1:#1c1c1e;
  --surface-2:#141416;
  --divider-strong:#4c4f57;
  --focus-ring: 2px solid rgba(10,132,255,.55);

  /* Picker specific (dark) */
  --picker-scrim: rgba(0,0,0,.55);
  --picker-bg:#0f1116;          /* foglio nettamente staccato */
  --picker-header:#0b0d12;
  --picker-option-bg:#0f1116;
  --picker-option-hover:#161a23;
  --picker-option-border:#2a2e38;
  --picker-selected-bg:#0a2a55;
  --picker-selected-text:#d6e6ff;
  --picker-custom-bg:#0c0f15;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display','Helvetica Neue',sans-serif;
  background:var(--bg-primary);min-height:100vh;color:var(--text-primary);
  -webkit-font-smoothing:antialiased;overscroll-behavior:none
}
.container{max-width:100%;background:var(--bg-primary);min-height:100vh;padding-bottom:calc(90px + var(--safe-area-bottom))}

/* Header */
.header{background:var(--surface-1);padding-top:var(--safe-area-top);position:sticky;top:0;z-index:100;border-bottom:.5px solid var(--border-color);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.header-content{padding:12px 16px}.header-top{display:flex;justify-content:space-between;align-items:center}
.header-title{font-size:20px;font-weight:600;letter-spacing:-.5px}.header-actions{display:flex;gap:8px;align-items:center}
.week-toggle{display:flex;background:var(--toggle-bg);border-radius:9px;padding:2px;height:32px}
.week-btn{padding:0 12px;border:none;background:transparent;color:var(--text-secondary);font-size:13px;font-weight:600;border-radius:7px;transition:.2s}
.week-btn.active{background:var(--surface-1);color:var(--text-primary);box-shadow:var(--shadow-sm)}
.theme-btn{width:32px;height:32px;border:none;background:transparent;font-size:20px;display:flex;align-items:center;justify-content:center;border-radius:16px}

/* Weekend toggle */
.weekend-bar{background:var(--surface-1);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-top:.5px solid var(--border-color)}
.weekend-label{font-size:15px;color:var(--text-primary)}
.ios-switch{width:51px;height:31px;background:var(--toggle-bg);border-radius:16px;position:relative;transition:background .3s}
.ios-switch.active{background:var(--accent-success)}
.ios-switch::after{content:'';position:absolute;width:27px;height:27px;background:#fff;border-radius:14px;top:2px;left:2px;transition:transform .3s;box-shadow:0 3px 8px rgba(0,0,0,.15)}
.ios-switch.active::after{transform:translateX(20px)}

/* Days list */
.days-list{background:var(--bg-primary)}
.day-cell{background:var(--surface-1);margin-bottom:.5px;transition:background .2s}
.day-cell.weekend{background:var(--surface-2)}
.day-cell.active-edit{background:var(--active-bg);position:relative;box-shadow:var(--elev-1)}
.day-cell.active-edit::before{content:"";position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent-primary);border-radius:0 2px 2px 0;opacity:.9}
.day-header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;min-height:52px;position:relative}
.day-header::after{content:"";position:absolute;bottom:0;left:16px;right:0;height:.5px;background:var(--divider-strong);opacity:.5}
.day-cell.expanded .day-header::after{opacity:0}
.day-left{display:flex;align-items:center;gap:12px;flex:1}
.day-indicator{width:8px;height:8px;border-radius:4px;background:var(--accent-success);opacity:0;transition:opacity .3s}
.day-cell.has-meals .day-indicator{opacity:1}
.day-info{flex:1}.day-name{font-size:17px;font-weight:400;color:var(--text-primary)}.day-date{font-size:13px;color:var(--text-tertiary);margin-top:2px}
.day-right{display:flex;align-items:center;gap:8px}.day-badge{padding:2px 6px;border-radius:10px;font-size:11px;font-weight:600;text-transform:uppercase;color:#fff;box-shadow:0 1px 2px rgba(0,0,0,.15)}
.badge-quick{background:var(--accent-warning)}.badge-delivery{background:var(--accent-purple)}
.lock-icon{font-size:14px;color:var(--text-tertiary)}.chevron{font-size:14px;color:var(--text-tertiary);transition:transform .3s;margin-left:4px}
.day-cell.expanded .chevron{transform:rotate(180deg)}

/* Meals content */
.meals-content{max-height:0;overflow:hidden;transition:max-height .3s ease;background:var(--surface-1);box-shadow: inset 0 1px 0 var(--border-secondary)}
.day-cell.expanded .meals-content{max-height:1000px}
.meal-group{padding:16px;border-bottom:.5px solid var(--border-secondary)}.meal-group:last-child{border-bottom:none}
.meal-label{font-size:13px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.meal-field{position:relative;margin-bottom:12px}
.meal-input{width:100%;height:44px;padding:0 44px 0 16px;border:1px solid var(--border-secondary);border-radius:10px;background:var(--input-bg);font-size:16px;color:var(--text-primary);-webkit-appearance:none;appearance:none}
.meal-input:focus{outline:none;border-color:var(--accent-primary)}
.shuffle-btn{position:absolute;right:6px;top:6px;width:32px;height:32px;border:none;border-radius:8px;background:var(--surface-2);display:flex;align-items:center;justify-content:center;font-size:16px;border:1px solid var(--border-secondary)}
.shuffle-btn:active{background:var(--accent-warning);transform:scale(.98)}
.mode-pills{display:flex;gap:8px;margin-bottom:12px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.mode-pill{flex:1;min-width:80px;height:36px;border:1px solid var(--border-secondary);background:var(--bg-tertiary);border-radius:18px;font-size:14px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:4px;transition:.2s}
.mode-pill.active{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary)}
.mode-pill.active.quick{background:var(--accent-warning);border-color:var(--accent-warning)}
.mode-pill.active.delivery{background:var(--accent-purple);border-color:var(--accent-purple)}

/* Day actions */
.day-actions{padding:12px 16px;background:var(--surface-2);display:flex;gap:8px;border-top:.5px solid var(--divider-strong)}
.action-btn{flex:1;height:36px;border:1px solid var(--border-secondary);background:var(--surface-1);border-radius:10px;font-size:13px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:4px}
.action-btn:active{background:var(--bg-tertiary);transform:scale(.98)}
.action-btn.locked{background:var(--accent-danger);color:#fff;border-color:var(--accent-danger)}

/* Bottom tab bar */
.tab-bar{position:fixed;bottom:0;left:0;right:0;background:var(--surface-1);padding-bottom:var(--safe-area-bottom);border-top:.5px solid var(--border-color);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:1000}
.tab-bar-content{display:flex;padding:8px 0}
.tab-btn{flex:1;padding:8px;border:none;background:transparent;display:flex;flex-direction:column;align-items:center;gap:4px}
.tab-btn:active{opacity:.6}.tab-icon{font-size:24px}.tab-label{font-size:10px;font-weight:500}
.tab-btn.shuffle{color:var(--accent-warning)}.tab-btn.grocery{color:var(--accent-success)}.tab-btn.share{color:var(--accent-primary)}.tab-btn.clear{color:var(--accent-danger)}

/* ---------- Picker: foglio sopraelevato + scrim ---------- */

/* Scrim dietro al picker (cattura tap e aumenta profondità) */
.picker-scrim{
  position:fixed;inset:0;z-index:2999;display:none;
  background: var(--picker-scrim);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.picker-scrim.show{display:block}

.meal-picker{
  position:fixed;bottom:0;left:0;right:0;background:var(--picker-bg);
  border-radius:14px 14px 0 0;max-height:65vh;transform:translateY(100%);
  transition:transform .28s ease;z-index:3000;display:none;
  box-shadow: var(--elev-2);
  border-top: 1px solid rgba(255,255,255,.06);
}
.meal-picker.show{display:block;transform:translateY(0)}
.picker-header{
  padding:14px 16px;border-bottom:1px solid var(--picker-option-border);
  display:flex;justify-content:space-between;align-items:center;
  background: var(--picker-header);
}
.picker-title{font-size:17px;font-weight:700}
.picker-done{
  color:var(--accent-primary);font-size:17px;font-weight:800;
  background: transparent;border:1.5px solid var(--accent-primary);
  padding:4px 10px;border-radius:8px;
}
.picker-done:active{opacity:.85}

.picker-custom{
  display:none;gap:8px;padding:10px 16px;border-top:1px solid var(--picker-option-border);
  border-bottom:1px solid var(--picker-option-border);background:var(--picker-custom-bg)
}
.picker-custom.show{display:flex}
.picker-custom input{flex:1;height:40px;border:1px solid var(--picker-option-border);border-radius:10px;padding:0 12px;background:var(--input-bg);color:var(--text-primary)}
.picker-custom button{height:40px;padding:0 14px;border:none;border-radius:10px;background:var(--accent-primary);color:#fff;font-weight:700}
.picker-custom button:disabled{opacity:.5}

.picker-options{max-height:340px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:var(--safe-area-bottom);background:var(--picker-bg)}
.picker-option{
  padding:16px;border-bottom:1px solid var(--picker-option-border);font-size:17px;background:var(--picker-option-bg);line-height:1.25
}
.picker-option:hover,.picker-option:focus{background:var(--picker-option-hover)}
.picker-option.selected{
  background:var(--picker-selected-bg);
  color:var(--picker-selected-text);
  font-weight:800;
  border-left:4px solid var(--accent-primary);
}
.picker-option.selected::after{content:'✓';float:right;color:var(--accent-primary);font-weight:900}
.picker-option.special{
  background:var(--picker-custom-bg);
  border-top:1px solid var(--picker-option-border);
  border-bottom:1px solid var(--picker-option-border);
  font-weight:800;
}

/* Utility */
.share-text,.picker-option,input.meal-input,.picker-custom input{-webkit-user-select:text;user-select:text}
@keyframes shuffle-spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}.shuffling{animation:shuffle-spin .5s ease}
input,textarea,button{-webkit-appearance:none;appearance:none}
.no-scroll{overflow:hidden;position:fixed;width:100%}
:focus-visible{outline:var(--focus-ring);outline-offset:2px}
@media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
</style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <div class="header-top">
          <h1 class="header-title">Meal Planner</h1>
          <div class="header-actions">
            <div class="week-toggle" role="tablist" aria-label="Week selector">
              <button class="week-btn" id="thisWeek" onclick="selectWeek('this')" role="tab" aria-selected="false">This</button>
              <button class="week-btn active" id="nextWeek" onclick="selectWeek('next')" role="tab" aria-selected="true">Next</button>
            </div>
            <button class="theme-btn" onclick="toggleTheme()" id="themeBtn" aria-label="Toggle theme">🌙</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Days -->
    <div class="days-list" id="daysList"></div>

    <!-- Weekend toggle -->
    <div class="weekend-bar">
      <span class="weekend-label" id="weekendLabel">Include weekend meals</span>
      <div class="ios-switch" id="weekendSwitch" role="switch" aria-checked="false" aria-labelledby="weekendLabel" tabindex="0" onclick="toggleWeekend()"></div>
    </div>
  </div>

  <!-- Bottom Tab Bar -->
  <div class="tab-bar">
    <div class="tab-bar-content">
      <button class="tab-btn shuffle" onclick="shuffleAll()">
        <span class="tab-icon">🔀</span><span class="tab-label">Shuffle</span>
      </button>
      <button class="tab-btn grocery" onclick="showGrocery()">
        <span class="tab-icon">🛒</span><span class="tab-label">Grocery</span>
      </button>
      <button class="tab-btn share" onclick="sharePlan()">
        <span class="tab-icon">📤</span><span class="tab-label">Send</span>
      </button>
      <button class="tab-btn clear" onclick="clearAll()">
        <span class="tab-icon">🗑️</span><span class="tab-label">Clear</span>
      </button>
    </div>
  </div>

  <!-- SCRIM per il picker -->
  <div class="picker-scrim" id="pickerScrim"></div>

  <!-- Meal Picker -->
  <div class="meal-picker" id="mealPicker" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
    <div class="picker-header">
      <span class="picker-title" id="pickerTitle">Select Meal</span>
      <button class="picker-done" onclick="closePicker()">Done</button>
    </div>

    <!-- appare SOLO se tocchi “Add custom…” -->
    <div class="picker-custom" id="pickerCustomRow">
      <input id="pickerCustomInput" type="text" placeholder="Type custom meal… (Enter to use)">
      <button id="pickerUseBtn" disabled>Use</button>
    </div>

    <div class="picker-options" id="pickerOptions"></div>
  </div>

  <!-- Grocery Modal -->
  <div class="ios-modal" id="groceryModal">
    <div class="ios-modal-content">
      <div class="modal-handle"></div>
      <div class="modal-header"><h2 class="modal-title">Grocery List</h2></div>
      <div class="modal-body" id="groceryList"></div>
      <div class="modal-actions">
        <button class="modal-btn primary" onclick="sendGrocery()">Send List</button>
        <button class="modal-btn secondary" onclick="closeModal('groceryModal')">Done</button>
      </div>
    </div>
  </div>

  <!-- Send Modal -->
  <div class="ios-modal" id="shareModal">
    <div class="ios-modal-content">
      <div class="modal-handle"></div>
      <div class="modal-header"><h2 class="modal-title" id="shareTitle">Send Meal Plan</h2></div>
      <div class="modal-body"><div class="share-text" id="shareText"></div></div>
      <div class="modal-actions">
        <button class="modal-btn primary" onclick="copyText(this)">Copy</button>
        <button class="modal-btn secondary" onclick="closeModal('shareModal')">Done</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG: Costanti editabili
   ========================= */
const meals = {
  lunch: [
    "Ravioli burro e salvia","Spaghetti al limone","Pasta e ceci","Pasta col tonno",
    "Pasta sugo tonno","Piadine prosciutto provolone","Uova fritte","Pasta al pesto",
    "Pasta coi pomodorini","Lenticchie","Spaghetti aglio e olio","Carbonara",
    "Frittata di pasta","Pasta e fagioli"
  ],
  dinner: {
    regular: [
      "Salmone col riso","Frittata di zucchine","Polpette","Pollo al limone","Merluzzo",
      "Hamburger","Cotolette","Salsicce","Minestrone","Pollo al forno","Scaloppine al limone","Caprese"
    ],
    quick: ["Cordon bleu","Würstel","Dumplings","Fish sticks","Pollo allo spiedo"],
    delivery: ["Pizza Delivery","Greco Delivery","Chinese Delivery","Vietnamese Delivery","Ramen Delivery"],
    weekend: [
      "Pasta al forno","Parmigiana di melanzane","Zucchine ripiene","Lasagna","Spezzatino con patate",
      "Tortellini con la panna","Tortellini col sugo","Pasta col ragù","Polpettone","Scrimpelle mbuss",
      "Polenta col sugo","Cannelloni","Bistecca"
    ],
    other: ["Colacena"]
  },
  side: [
    "Purè di patate","Broccoli al vapore","Insalata di pomodori","Tater tots","Barbabietole",
    "Insalata di mais","Patate lesse","Carote al forno","Carote a insalata","Zucchine trifolate",
    "Insalata di cetrioli","Insalata"
  ]
};

const ingredients = {
  "Ravioli burro e salvia": ["Ravioli","Sage"],
  "Spaghetti al limone": ["Spaghetti","Lemons"],
  "Pasta e ceci": ["Ditalini","Chickpeas"],
  "Pasta col tonno": ["Spaghetti","Tuna"],
  "Pasta sugo tonno": ["Pasta","Tuna","Tomato sauce"],
  "Piadine prosciutto provolone": ["Flatbreads","Prosciutto","Provolone cheese"],
  "Uova fritte": ["Eggs"],
  "Pasta al pesto": ["Pasta","Pesto"],
  "Pasta coi pomodorini": ["Pasta","Cherry tomatoes"],
  "Lenticchie": ["Lentils","Croutons"],
  "Spaghetti aglio e olio": ["Spaghetti"],
  "Carbonara": ["Spaghetti","Eggs","Bacon"],
  "Frittata di pasta": ["Eggs"],
  "Pasta e fagioli": ["Pasta","Beans"],
  "Salmone col riso": ["Salmon","Rice"],
  "Frittata di zucchine": ["Eggs","Zucchini"],
  "Polpette": ["Ground beef","Eggs","Bread","Breadcrumbs"],
  "Pollo al limone": ["Chicken breast","Lemons"],
  "Merluzzo": ["Cod"],
  "Hamburger": ["Buns","Hamburger buns","American cheese slices","Lettuce","Tomatoes"],
  "Cotolette": ["Breaded cutlets","Breadcrumbs","Eggs"],
  "Salsicce": ["Sausages"],
  "Minestrone": ["Vegetable soup mix","Pasta","Beans"],
  "Pollo al forno": ["Chicken thighs"],
  "Scaloppine al limone": ["Veal cutlets","Lemons"],
  "Caprese": ["Fresh mozzarella","Tomatoes"],
  "Cordon bleu": ["Cordon bleu"],
  "Würstel": ["Hot dogs"],
  "Dumplings": ["Dumplings"],
  "Fish sticks": ["Fish sticks"],
  "Pollo allo spiedo": ["Whole chicken"],
  "Pasta al forno": ["Pasta","Tomato sauce","Shredded mozzarella"],
  "Parmigiana di melanzane": ["Eggplant","Tomato sauce","Shredded mozzarella"],
  "Zucchine ripiene": ["Zucchini","Ground beef","Bread"],
  "Lasagna": ["Lasagna noodles","Meat sauce"],
  "Spezzatino con patate": ["Beef","Potatoes","Onion","Carrots"],
  "Tortellini con la panna": ["Tortellini","Cream"],
  "Tortellini col sugo": ["Tortellini","Tomato sauce"],
  "Pasta col ragù": ["Pasta","Meat sauce"],
  "Polpettone": ["Ground beef","Eggs","Bacon","Bread"],
  "Scrimpelle mbuss": ["Eggs","Flour","Milk","Broth"],
  "Polenta col sugo": ["Polenta","Tomato sauce","Sausages"],
  "Cannelloni": ["Cannelloni","Ricotta","Spinach"],
  "Bistecca": ["Steak"],
  "Purè di patate": ["Potatoes"],
  "Broccoli al vapore": ["Broccoli"],
  "Insalata di pomodori": ["Tomatoes"],
  "Tater tots": ["Tater tots"],
  "Barbabietole": ["Beets"],
  "Insalata di mais": ["Corn"],
  "Patate lesse": ["Potatoes"],
  "Carote al forno": ["Carrots"],
  "Carote a insalata": ["Carrots"],
  "Zucchine trifolate": ["Zucchini"],
  "Insalata di cetrioli": ["Cucumbers"],
  "Insalata": ["Lettuce"],
};

const stores = {
  Aldi: [
    "Bacon","Beets","Cannelloni","Carrots","Chicken thighs","Breaded cutlets","Croutons","Dumplings",
    "Beans","Fish sticks","Lemons","Corn","Shredded mozzarella","Potatoes","Chicken breast","Flatbreads",
    "Tomatoes","Cherry tomatoes","Provolone cheese","Prosciutto","Ravioli","Sausages","American cheese slices",
    "Spinach","Tater tots","Tortellini","Eggs","Hot dogs","Zucchini","Ground beef","Ricotta","Milk","Pesto sauce"
  ],
  Wegmans: [
    "Steak","Broccoli","Cucumbers","Onion","Hamburger buns","Butter","Lettuce","Lentils","Eggplant",
    "Cod","Whole chicken","Sage","Salmon","Bread","Tomato sauce"
  ],
  Amazon: ["Pasta","Tuna","Breadcrumbs","Rice"],
  Other: []
};

/* =========================
   Stato & runtime
   ========================= */
let data={},week='next',weekendOn={},locked={},modes={},currentPicker=null,shareContent='',lastOpen=null,untrapPicker=null;

function init(){
  load(); syncWeekToggle(); render(); updateWeekend(); setTheme();
  addSwipeToDismiss(document.getElementById('mealPicker'), closePicker);
  addSwipeToDismiss(document.querySelector('#groceryModal .ios-modal-content'),()=>closeModal('groceryModal'));
  addSwipeToDismiss(document.querySelector('#shareModal .ios-modal-content'),()=>closeModal('shareModal'));

  // scrim: tap per chiudere
  document.getElementById('pickerScrim').addEventListener('click', closePicker);

  // custom input handlers (mostra tastiera solo su richiesta)
  const useBtn=document.getElementById('pickerUseBtn');
  const input=document.getElementById('pickerCustomInput');
  useBtn.addEventListener('click', useCustomFromInput);
  input.addEventListener('input', e=>{ useBtn.disabled = e.target.value.trim().length===0; });
  input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); useCustomFromInput(); } });
}

function syncWeekToggle(){
  document.getElementById('thisWeek').classList.toggle('active', week==='this');
  document.getElementById('nextWeek').classList.toggle('active', week==='next');
  document.getElementById('thisWeek').setAttribute('aria-selected', String(week==='this'));
  document.getElementById('nextWeek').setAttribute('aria-selected', String(week==='next'));
}

function setTheme(){
  const saved=localStorage.getItem('theme');
  const dark=saved?saved==='dark':window.matchMedia('(prefers-color-scheme: dark)').matches;
  document.documentElement.setAttribute('data-theme', dark?'dark':'light');
  document.getElementById('themeBtn').textContent=dark?'☀️':'🌙';
}
function toggleTheme(){
  const cur=document.documentElement.getAttribute('data-theme');
  const nxt=cur==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',nxt);
  localStorage.setItem('theme',nxt);
  document.getElementById('themeBtn').textContent=nxt==='dark'?'☀️':'🌙';
}

function selectWeek(w){
  if(week!==w) lastOpen=null;
  week=w; syncWeekToggle(); updateWeekend(); save(); render();
}

function toggleWeekend(){
  weekendOn[week]=!weekendOn[week];
  if(!weekendOn[week] && lastOpen && getIndex(lastOpen)>=5) lastOpen=null;
  updateWeekend();
  if(!weekendOn[week]){
    for(let i=5;i<=6;i++){ const k=getKey(i); delete data[k]; delete locked[k]; delete modes[k];}
  }
  save(); render();
}
function updateWeekend(){
  const el=document.getElementById('weekendSwitch'); const on=!!weekendOn[week];
  el.classList.toggle('active',on); el.setAttribute('aria-checked', String(on));
}
document.getElementById('weekendSwitch').addEventListener('keydown',e=>{
  if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleWeekend(); }
},{passive:true});

/* Render */
function render(){
  const list=document.getElementById('daysList');
  const days=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  const start=getWeekStart();

  list.innerHTML = days.map((name,i)=>{
    if(i>=5 && !weekendOn[week]) return '';
    const k=getKey(i,start);
    const d=data[k]||{lunch:'',dinner:'',side:''};
    const isWeekend=i>=5; const isLocked=locked[k]; const mode=modes[k]||'regular';
    const hasMeals=d.lunch||d.dinner; const date=getDate(i,start);
    let badges=''; if(isLocked) badges+='<span class="lock-icon" aria-hidden="true">🔒</span>';
    if(mode==='quick') badges+='<span class="day-badge badge-quick">Quick</span>';
    if(mode==='delivery') badges+='<span class="day-badge badge-delivery">Delivery</span>';

    const labelId=`day-${k}-label`, panelId=`panel-${k}`;
    const activeClass = (lastOpen===k) ? 'active-edit' : '';
    return `
      <div class="day-cell ${isWeekend?'weekend':''} ${has-meals?'has-meals':''} ${activeClass}" id="day-${k}">
        <div class="day-header" role="button" aria-expanded="false" aria-controls="${panelId}" tabindex="0"
             onclick="toggleDay('${k}')"
             onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleDay('${k}')}">
          <div class="day-left">
            <div class="day-indicator" aria-hidden="true"></div>
            <div class="day-info">
              <div class="day-name" id="${labelId}">${name}</div>
              <div class="day-date">${date.toLocaleDateString('en',{month:'short',day:'numeric'})}</div>
            </div>
          </div>
          <div class="day-right">${badges}<span class="chevron" aria-hidden="true">▼</span></div>
        </div>
        <div class="meals-content" id="${panelId}" role="region" aria-labelledby="${labelId}">
          ${renderMeals(k,isWeekend)}
        </div>
      </div>`;
  }).join('');

  const cell = lastOpen && document.getElementById(`day-${lastOpen}`);
  if (cell) {
    cell.classList.add('expanded','active-edit');
    cell.querySelector('.day-header')?.setAttribute('aria-expanded','true');
  } else {
    // Nessun auto-open: tutti possono restare chiusi
    document.querySelectorAll('.day-header[aria-expanded="true"]')
      .forEach(h => h.setAttribute('aria-expanded','false'));
  }
}

function renderMeals(k,isWeekend){
  const d=data[k]||{lunch:'',dinner:'',side:''};
  const mode=modes[k]||'regular'; const isLocked=locked[k];
  return `
    <div class="meal-group">
      <div class="meal-label">Lunch</div>
      <div class="meal-field">
        <input type="text" class="meal-input" value="${d.lunch}" placeholder="Tap to select..." readonly onclick="openPicker('${k}','lunch')">
        <button class="shuffle-btn" onclick="event.stopPropagation(); shuffleMeal('${k}','lunch',this)">🎲</button>
      </div>
    </div>

    <div class="meal-group">
      <div class="meal-label">Dinner</div>
      ${!isWeekend?`
        <div class="mode-pills">
          <button class="mode-pill ${mode==='regular'?'active':''}" onclick="setMode('${k}','regular')">🍽️ Regular</button>
          <button class="mode-pill ${mode==='quick'?'active quick':''}" onclick="setMode('${k}','quick')">⚡ Quick</button>
          <button class="mode-pill ${mode==='delivery'?'active delivery':''}" onclick="setMode('${k}','delivery')">🚚 Delivery</button>
        </div>`:''}
      <div class="meal-field">
        <input type="text" class="meal-input" value="${d.dinner}" placeholder="Tap to select..." readonly onclick="openPicker('${k}','dinner')">
        <button class="shuffle-btn" onclick="event.stopPropagation(); shuffleMeal('${k}','dinner',this)">🎲</button>
      </div>

      ${mode!=='delivery'?`
        <div style="margin-top:12px;">
          <div class="meal-label">Side Dish</div>
          <div class="meal-field">
            <input type="text" class="meal-input" value="${d.side}" placeholder="Tap to select..." readonly onclick="openPicker('${k}','side')">
            <button class="shuffle-btn" onclick="event.stopPropagation(); shuffleMeal('${k}','side',this)">🎲</button>
          </div>
        </div>`:`<div aria-hidden="true" aria-disabled="true"></div>`}
    </div>

    <div class="day-actions">
      <button class="action-btn ${isLocked?'locked':''}" onclick="toggleLock('${k}')">${isLocked?'🔒 Locked':'🔓 Lock'}</button>
      <button class="action-btn" onclick="shuffleDay('${k}')">🎲 Shuffle</button>
      <button class="action-btn" onclick="clearDay('${k}')">🗑️ Clear</button>
    </div>`;
}

/* Picker: lista + “Add custom…” */
document.getElementById('pickerOptions').addEventListener('click',e=>{
  const opt=e.target.closest('.picker-option'); if(!opt) return;
  const val=opt.dataset.value;
  if(val==='__custom__'){ showCustomInput(); return; }
  selectMeal(val);
});
document.getElementById('pickerOptions').addEventListener('keydown',e=>{
  const opts=Array.from(e.currentTarget.querySelectorAll('.picker-option'));
  const i=opts.indexOf(document.activeElement);
  if(e.key==='ArrowDown'){(opts[i+1]||opts[0])?.focus();e.preventDefault();}
  if(e.key==='ArrowUp'){(opts[i-1]||opts.at(-1))?.focus();e.preventDefault();}
  if(e.key==='Enter'||e.key===' '){const v=document.activeElement?.dataset.value; if(v){ if(v==='__custom__') showCustomInput(); else selectMeal(v); }}
});

function trapFocus(container){
  const F='button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])';
  const nodes=()=>Array.from(container.querySelectorAll(F)).filter(el=>!el.disabled&&el.offsetParent!==null);
  function onKey(e){
    if(e.key!=='Tab')return; const list=nodes(); if(!list.length)return;
    const first=list[0], last=list[list.length-1];
    if(e.shiftKey && document.activeElement===first){last.focus();e.preventDefault();}
    else if(!e.shiftKey && document.activeElement===last){first.focus();e.preventDefault();}
  }
  container.addEventListener('keydown',onKey); return()=>container.removeEventListener('keydown',onKey);
}

function openPicker(k,type){
  currentPicker={key:k,type:type};
  const picker=document.getElementById('mealPicker');
  const scrim=document.getElementById('pickerScrim');
  const title=document.getElementById('pickerTitle');
  const options=document.getElementById('pickerOptions');

  title.textContent=`Select ${type.charAt(0).toUpperCase()+type.slice(1)}`;

  // pool base; “None” va in fondo
  let items=[];
  if(type==='lunch'){ items=meals.lunch.slice(); }
  else if(type==='dinner'){
    const mode=modes[k]||'regular'; const isWeekend=getIndex(k)>=5;
    items = mode==='quick'?meals.dinner.quick.slice()
          : mode==='delivery'?meals.dinner.delivery.slice()
          : isWeekend?meals.dinner.weekend.slice()
          : meals.dinner.regular.slice();
    if(!isWeekend && mode==='regular'){ items.push(...meals.dinner.other); }
  } else { items=meals.side.slice(); }
  items.push('None'); // ultimo

  const current=(data[k]||{})[type];
  renderPickerOptions(items, current);

  // reset custom row
  const row=document.getElementById('pickerCustomRow');
  row.classList.remove('show');
  document.getElementById('pickerCustomInput').value='';
  document.getElementById('pickerUseBtn').disabled=true;

  scrim.classList.add('show');
  picker.classList.add('show'); document.body.classList.add('no-scroll');
  untrapPicker=trapFocus(picker);

  const selected = options.querySelector('.picker-option.selected');
  if(selected) options.scrollTop = Math.max(0, selected.offsetTop - 120);
}

function renderPickerOptions(items, current){
  const options=document.getElementById('pickerOptions');
  const addCustom = `<div class="picker-option special" data-value="__custom__" tabindex="0">➕ Add custom…</div>`;
  const list = items.map(item=>`<div class="picker-option ${item===current?'selected':''}" data-value="${item}" tabindex="0">${item}</div>`).join('');
  options.innerHTML = addCustom + list;
}

function showCustomInput(){
  const row=document.getElementById('pickerCustomRow');
  row.classList.add('show');
  setTimeout(()=>document.getElementById('pickerCustomInput').focus(),0);
}

function useCustomFromInput(){
  const input=document.getElementById('pickerCustomInput');
  const txt=input.value.trim();
  if(!txt || !currentPicker) return;
  if(!data[currentPicker.key]) data[currentPicker.key]={lunch:'',dinner:'',side:''};
  data[currentPicker.key][currentPicker.type]= (txt.toLowerCase()==='none') ? '' : txt;
  if(currentPicker.type==='dinner' && /delivery/i.test(txt)) { data[currentPicker.key].side=''; }
  save(); render(); closePicker();
}

function selectMeal(value){
  if(!currentPicker) return;
  const {key,type}=currentPicker;
  if(!data[key]) data[key]={lunch:'',dinner:'',side:''};
  if(value==='None'){ data[key][type]=''; }
  else{
    data[key][type]=value;
    if(type==='dinner' && /delivery/i.test(value)) data[key].side='';
  }
  save(); render(); closePicker();
}

function closePicker(){
  document.getElementById('mealPicker').classList.remove('show');
  document.getElementById('pickerScrim').classList.remove('show');
  document.body.classList.remove('no-scroll');
  untrapPicker?.(); untrapPicker=null; currentPicker=null;
}

function trySystemShare(title,text){
  if(navigator.share){
    navigator.share({title,text}).catch(()=>{
      document.getElementById('shareTitle').textContent=title;
      document.getElementById('shareText').textContent=text;
      showModal('shareModal');
    });
    return true;
  }
  return false;
}

/* Giorni */
function toggleDay(k){
  document.querySelectorAll('.day-cell.expanded').forEach(c=>{
    c.classList.remove('expanded','active-edit');
    c.querySelector('.day-header')?.setAttribute('aria-expanded','false');
  });
  const cell=document.getElementById(`day-${k}`);
  const opening=!cell.classList.contains('expanded');
  if(opening){
    cell.classList.add('expanded','active-edit');
    cell.querySelector('.day-header')?.setAttribute('aria-expanded','true');
    lastOpen=k; if(!data[k]) data[k]={lunch:'',dinner:'',side:''};
  }else{
    lastOpen=null;
    cell.querySelector('.day-header')?.setAttribute('aria-expanded','false');
  }
  save();
}

/* Lock & Mode */
function toggleLock(k){ locked[k]=!locked[k]; save(); render(); }
function setMode(k,mode){
  modes[k]=mode; if(!data[k]) data[k]={lunch:'',dinner:'',side:''};
  const isWeekend=getIndex(k)>=5;
  const validDinner= mode==='quick'?meals.dinner.quick
                    : mode==='delivery'?meals.dinner.delivery
                    : isWeekend?meals.dinner.weekend
                    : meals.dinner.regular;
  if(data[k].dinner && !validDinner.includes(data[k].dinner)) data[k].dinner='';
  if(mode==='delivery') data[k].side='';
  save(); render();
}

/* Shuffle con anti-doppioni leggeri */
function pickDifferent(pool,prev){ if(!pool.length) return ''; if(pool.length===1) return pool[0];
  let choice,tries=0; do{ choice=pool[Math.floor(Math.random()*pool.length)]; tries++; } while(choice===prev && tries<6);
  return choice;
}
function shuffleMeal(k,type,btn){
  if(locked[k])return; if(!data[k]) data[k]={lunch:'',dinner:'',side:''};
  btn?.classList.add('shuffling');
  let pool=[];
  if(type==='lunch') pool=meals.lunch;
  else if(type==='dinner'){
    const mode=modes[k]||'regular'; const isWeekend=getIndex(k)>=5;
    pool = mode==='quick'?meals.dinner.quick : mode==='delivery'?meals.dinner.delivery : isWeekend?meals.dinner.weekend : meals.dinner.regular;
  } else pool=meals.side;

  const i=getIndex(k), prevKey=getKey(i-1), prev=data[prevKey]||{}, prevVal=prev[type];
  data[k][type]=pickDifferent(pool,prevVal);

  setTimeout(()=>{btn?.classList.remove('shuffling'); save(); render();},500);
}
function shuffleDay(k){
  if(locked[k])return; if(!data[k]) data[k]={lunch:'',dinner:'',side:''};
  const i=getIndex(k), prevKey=getKey(i-1), prev=data[prevKey]||{}, mode=modes[k]||'regular', isWeekend=i>=5;
  data[k].lunch=pickDifferent(meals.lunch,prev.lunch);
  const dinnerPool = mode==='quick'?meals.dinner.quick : mode==='delivery'?meals.dinner.delivery : isWeekend?meals.dinner.weekend : meals.dinner.regular;
  data[k].dinner=pickDifferent(dinnerPool,prev.dinner);
  if(mode!=='delivery') data[k].side=pickDifferent(meals.side,prev.side);
  save(); render();
}
function clearDay(k){ data[k]={lunch:'',dinner:'',side:''}; save(); render(); }

/* Week actions */
function shuffleAll(){ for(let i=0;i<7;i++){ if(i>=5 && !weekendOn[week]) continue; const k=getKey(i); if(!locked[k]) shuffleDay(k); } }
function clearAll(){
  if(!confirm('Clear all meals?')) return;
  for(let i=0;i<7;i++){ const k=getKey(i); data[k]={lunch:'',dinner:'',side:''}; delete locked[k]; delete modes[k]; }
  lastOpen=null; save(); render();
}

/* Grocery */
function showGrocery(){
  const list=document.getElementById('groceryList'); const items={};
  Object.values(data).forEach(d=>['lunch','dinner','side'].forEach(t=>{
    const meal=d[t]; if(meal && ingredients[meal]) ingredients[meal].forEach(ing=>{ items[ing]=(items[ing]||0)+1; });
  }));
  if(Object.keys(items).length===0){ list.innerHTML='<div class="empty-state"><div class="empty-icon">🛒</div><p>No meals planned yet</p></div>'; }
  else{
    const organized={};
    Object.entries(items).forEach(([ing,count])=>{
      let added=false;
      for(const [store,keys] of Object.entries(stores)){
        if(keys.some(k=>ing.toLowerCase().includes(k.toLowerCase()))){ (organized[store]??=[]).push({name:ing,count}); added=true; break; }
      }
      if(!added) (organized.Other??=[]).push({name:ing,count});
    });
    list.innerHTML = Object.entries(organized).map(([store,arr])=>`
      <div class="grocery-section"><div class="grocery-title">${store}</div>
      ${arr.map(item=>`<div class="grocery-item"><input type="checkbox" class="grocery-check"><span>${item.name} ${item.count>1?`(×${item.count})`:''}</span></div>`).join('')}</div>`).join('');
  }
  showModal('groceryModal');
}
function sendGrocery(){
  const rows=[...document.querySelectorAll('.grocery-item')];
  const items=rows.filter(r=>!r.querySelector('.grocery-check').checked).map(r=>r.querySelector('span').textContent);
  if(!items.length) return;
  shareContent='🛒 Grocery List\n\n'+items.map(t=>'☐ '+t).join('\n');
  closeModal('groceryModal');
  if(!trySystemShare('Grocery List',shareContent)){
    document.getElementById('shareTitle').textContent='Send Grocery List';
    document.getElementById('shareText').textContent=shareContent;
    showModal('shareModal');
  }
}

/* Send plan */
function weekRange(){
  const start=getWeekStart(), end=new Date(start); end.setDate(start.getDate()+6);
  const fmt={month:'short',day:'numeric'}; return `${start.toLocaleDateString('en',fmt)} - ${end.toLocaleDateString('en',fmt)}`;
}
function sharePlan(){
  const days=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  shareContent=`📅 Meal Plan - ${week==='this'?'This':'Next'} Week\n${weekRange()}\n\n`;
  days.forEach((day,i)=>{
    if(i>=5 && !weekendOn[week]) return;
    const k=getKey(i), d=data[k]||{};
    shareContent+=`${day}\n`;
    if(d.lunch) shareContent+=`  Lunch: ${d.lunch}\n`;
    if(d.dinner){ shareContent+=`  Dinner: ${d.dinner}`; if(d.side) shareContent+=' with '+d.side; shareContent+='\n'; }
    if(!d.lunch && !d.dinner) shareContent+=`  No meals\n`;
    shareContent+='\n';
  });
  if(!trySystemShare('Send Meal Plan',shareContent)){
    document.getElementById('shareTitle').textContent='Send Meal Plan';
    document.getElementById('shareText').textContent=shareContent;
    showModal('shareModal');
  }
}
function copyText(btn){
  navigator.clipboard.writeText(shareContent).then(()=>{
    navigator.vibrate?.(8); const orig=btn.textContent; btn.textContent='Copied! ✓'; btn.style.background='var(--accent-success)';
    setTimeout(()=>{ btn.textContent=orig; btn.style.background=''; closeModal('shareModal'); },1000);
  });
}

/* Modali & util */
function showModal(id){ document.getElementById(id).classList.add('show'); document.body.classList.add('no-scroll'); }
function closeModal(id){ document.getElementById(id).classList.remove('show'); document.body.classList.remove('no-scroll'); }
document.addEventListener('click',e=>{ if(e.target.classList.contains('ios-modal')){ e.target.classList.remove('show'); document.body.classList.remove('no-scroll'); }});
document.addEventListener('keydown',e=>{
  if(e.key!=='Escape') return;
  const picker=document.getElementById('mealPicker'), grocery=document.getElementById('groceryModal'), share=document.getElementById('shareModal');
  if(picker.classList.contains('show')) closePicker();
  else if(grocery.classList.contains('show')) closeModal('groceryModal');
  else if(share.classList.contains('show')) closeModal('shareModal');
});
function addSwipeToDismiss(panel,onDismiss){
  if(!panel) return;
  let startY=null,deltaY=0;
  panel.addEventListener('touchstart',e=>{startY=e.touches[0].clientY;deltaY=0;},{passive:true});
  panel.addEventListener('touchmove',e=>{ if(startY===null)return; deltaY=e.touches[0].clientY-startY; if(deltaY>0) panel.style.transform=`translateY(${Math.min(deltaY,140)}px)`; },{passive:true});
  panel.addEventListener('touchend',()=>{ if(deltaY>90) onDismiss(); panel.style.transform=''; startY=null; deltaY=0; },{passive:true});
}

/* Date utils */
function getKey(index,startRef){ const date=getDate(index,startRef); return `${week}-${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`; }
function getIndex(key){ const p=key.split('-'); const date=new Date(p[1],p[2],p[3]); const start=getWeekStart(); return Math.floor((date-start)/86400000); }
function getDate(index,startRef){ const start=startRef||getWeekStart(); const d=new Date(start); d.setDate(start.getDate()+index); return d; }
function getWeekStart(){ const now=new Date(); const mondayIndex=(now.getDay()+6)%7; const start=new Date(now); start.setDate(now.getDate()-mondayIndex+(week==='next'?7:0)); start.setHours(0,0,0,0); return start; }

/* Storage */
function save(){
  localStorage.setItem('mealData',JSON.stringify(data));
  localStorage.setItem('mealWeek',week);
  localStorage.setItem('mealWeekend',JSON.stringify(weekendOn));
  localStorage.setItem('mealLocked',JSON.stringify(locked));
  localStorage.setItem('mealModes',JSON.stringify(modes));
  localStorage.setItem('mealLastOpen',lastOpen||'');
}
function load(){
  try{
    data=JSON.parse(localStorage.getItem('mealData')||'{}');
    week=localStorage.getItem('mealWeek')||'next';
    weekendOn=JSON.parse(localStorage.getItem('mealWeekend')||'{}');
    locked=JSON.parse(localStorage.getItem('mealLocked')||'{}');
    modes=JSON.parse(localStorage.getItem('mealModes')||'{}');
    lastOpen=localStorage.getItem('mealLastOpen')||null;
  }catch{}
}

document.addEventListener('touchmove',()=>{}, {passive:true});
init();
</script>
</body>
</html>