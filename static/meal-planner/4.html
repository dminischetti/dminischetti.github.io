<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Weekly Meal Planner — Next Week</title>
<style>
/* ===== Single modern theme, iPhone 11/12 tuned ===== */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#f6f5f4; --surface:#ffffff; --surface-2:#f1efec;
  --text:#1c1b19; --muted:#6b665e; --line:#ddd6cb;
  --brand:#1f6b66; --brand-2:#329d96; --warn:#c06a1d; --danger:#c2352a; --ok:#2e7a49;
  --radius:14px; --radius-sm:10px; --shadow:0 8px 20px rgba(28,27,25,.08);
  --safe-top:env(safe-area-inset-top); --safe-bottom:env(safe-area-inset-bottom);
}
html,body{height:100%}
body{
  font:16px/1.15 -apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display','Helvetica Neue',Arial,sans-serif;
  color:var(--text); background:var(--bg); -webkit-font-smoothing:antialiased;
  overscroll-behavior-y:contain;
}
:focus-visible{outline:2px solid color-mix(in hsl,var(--brand) 55%, white); outline-offset:2px}
button{font:inherit;color:inherit;background:none;border:none}
hr{border:none;border-top:1px solid var(--line);margin:8px 0}

/* Layout */
.app{min-height:100%;padding-bottom:calc(72px + var(--safe-bottom))}
.header{
  position:sticky;top:0;z-index:10;background:var(--surface);
  padding:calc(6px + var(--safe-top)) 12px 10px;border-bottom:1px solid var(--line);
  backdrop-filter:blur(10px)
}
.header-row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.h-left{display:flex;align-items:center;gap:10px}
.title{font-weight:800;letter-spacing:-.2px}
.sub{font-size:12px;color:var(--muted)}
.h-right{display:flex;align-items:center;gap:10px}
.switch{width:54px;height:30px;border-radius:999px;background:var(--surface-2);border:1px solid var(--line);position:relative}
.switch[data-on="true"]{background:color-mix(in srgb,var(--brand) 32%, var(--surface));border-color:transparent}
.switch .knob{position:absolute;top:2px;left:2px;width:26px;height:26px;border-radius:999px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.2);transition:transform .2s ease}
.switch[data-on="true"] .knob{transform:translateX(24px)}
.clear-btn{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--surface-2);font-weight:800;color:var(--danger)}

.days{padding:10px 8px 0}
.row{
  display:grid;grid-template-columns:86px 1fr;gap:8px;
  background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);
  padding:8px 10px;margin-bottom:8px
}
.day-col{display:flex;flex-direction:column;justify-content:center}
.day-name{font-weight:800}
.day-date{font-size:12px;color:var(--muted);margin-top:2px}
.controls{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.field{
  height:38px;border:1px solid var(--line);background:var(--surface-2);
  border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:space-between;padding:0 10px
}
.field>.val{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text)}
.field>.ph{color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
.seg{display:flex;gap:6px;margin-top:6px}
.seg button{
  flex:1;height:30px;border:1px solid var(--line);border-radius:999px;background:var(--surface-2);
  font-size:12px;font-weight:800;color:var(--muted)
}
.seg button[aria-pressed="true"]{color:var(--brand);background:#f0f7f6;border-color:color-mix(in srgb,var(--brand) 30%, #dfeceb)}

.bar{
  position:fixed;left:0;right:0;bottom:0;z-index:20;background:var(--surface);
  border-top:1px solid var(--line);padding-bottom:var(--safe-bottom)
}
.bar-inner{display:flex;gap:8px;padding:8px}
.bar button{
  flex:1;height:44px;border-radius:999px;border:1px solid var(--line);
  background:var(--surface-2);font-weight:900
}
.bar .brand{color:var(--brand)}
.bar .ok{color:var(--ok)}
.bar .share{color:var(--brand-2)}
.bar .danger{color:var(--danger)}

/* Sheets + scrim */
.scrim{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:100;backdrop-filter:blur(2px)}
.scrim.show{display:block}
.sheet{
  position:fixed;left:0;right:0;bottom:0;z-index:101;display:none;
  background:var(--surface);border-radius:16px 16px 0 0;box-shadow:var(--shadow);
  max-height:75vh;transform:translateY(100%);transition:transform .22s ease
}
.sheet.show{display:block;transform:translateY(0)}
.sheet-h{padding:12px;border-bottom:1px solid var(--line);text-align:center}
.sheet-h .handle{width:44px;height:4px;background:var(--line);border-radius:3px;margin:6px auto 10px}
.sheet-h .title{font-weight:900}
.sheet-b{overflow:auto;-webkit-overflow-scrolling:touch}
.sheet-f{padding:10px;border-top:1px solid var(--line);display:flex;gap:8px}

.list{padding:6px 10px 10px}
.opt{padding:12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.opt[aria-selected="true"]{background:var(--surface-2);font-weight:800;color:var(--brand)}
.custom-row{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);background:var(--surface-2)}
.custom-row input{flex:1;height:40px;border:1px solid var(--line);border-radius:10px;padding:0 10px;background:#fff;color:#111}
.custom-row button{height:40px;padding:0 14px;border:1px solid var(--line);border-radius:10px;font-weight:800;background:var(--surface)}

.group{padding:10px}
.group h4{font-size:12px;color:var(--muted);letter-spacing:.4px;text-transform:uppercase;margin-bottom:6px}
.item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--line)}
.item input{width:18px;height:18px;accent-color:var(--brand)}

.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--surface-2);padding:10px;border-radius:10px;border:1px solid var(--line);white-space:pre-wrap}
</style>
</head>
<body>
<div id="app" class="app">
  <header class="header">
    <div class="header-row">
      <div class="h-left">
        <div class="title">Meal Planner</div>
        <div id="range" class="sub"></div>
      </div>
      <div class="h-right">
        <div id="weekend" class="switch" role="switch" aria-checked="true" tabindex="0" title="Include weekend">
          <div class="knob"></div>
        </div>
        <button id="clearAll" class="clear-btn" title="Clear all">Clear</button>
      </div>
    </div>
  </header>

  <main id="days" class="days" aria-live="polite"></main>

  <footer class="bar" aria-label="Actions">
    <div class="bar-inner">
      <button id="btnShuffle" class="brand">Randomize Week</button>
      <button id="btnGrocery" class="ok">Grocery</button>
      <button id="btnShare" class="share">Share</button>
    </div>
  </footer>
</div>

<!-- Scrim + Sheets -->
<div id="scrim" class="scrim" aria-hidden="true"></div>

<section id="picker" class="sheet" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
  <div class="sheet-h">
    <div class="handle" aria-hidden="true"></div>
    <div id="pickerTitle" class="title">Choose</div>
  </div>
  <div id="pickerCustom" class="custom-row" hidden>
    <input id="customInput" type="text" placeholder="Type a custom meal…">
    <button id="customUse">Use</button>
  </div>
  <div id="pickerList" class="sheet-b"></div>
  <div class="sheet-f">
    <button id="pickerDone" style="flex:1;height:40px;border-radius:999px" class="brand">Done</button>
  </div>
</section>

<section id="grocery" class="sheet" role="dialog" aria-modal="true" aria-labelledby="groceryTitle">
  <div class="sheet-h">
    <div class="handle"></div>
    <div id="groceryTitle" class="title">Grocery List (by store)</div>
  </div>
  <div id="groceryBody" class="sheet-b"></div>
  <div class="sheet-f">
    <button id="groceryCopy" style="flex:1;height:40px;border-radius:999px" class="brand">Copy</button>
    <button id="groceryClose" style="flex:1;height:40px;border-radius:999px">Done</button>
  </div>
</section>

<section id="share" class="sheet" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
  <div class="sheet-h">
    <div class="handle"></div>
    <div id="shareTitle" class="title">Share Plan + Grocery</div>
  </div>
  <div class="sheet-b" style="padding:10px">
    <div id="shareText" class="mono"></div>
  </div>
  <div class="sheet-f">
    <button id="shareCopy" style="flex:1;height:40px;border-radius:999px" class="brand">Copy</button>
    <button id="shareClose" style="flex:1;height:40px;border-radius:999px">Done</button>
  </div>
</section>

<script>
/* ========= Config ========== */
const LIB = {
  lunch: [
    "Ravioli burro e salvia","Spaghetti al limone","Pasta e ceci","Pasta col tonno",
    "Pasta sugo tonno","Piadine prosciutto provolone","Uova fritte","Pasta al pesto",
    "Pasta coi pomodorini","Lenticchie","Spaghetti aglio e olio","Carbonara",
    "Frittata di pasta","Pasta e fagioli","None","Custom…"
  ],
  dinner: {
    regular: [
      "Salmone col riso","Frittata di zucchine","Polpette","Pollo al limone","Merluzzo",
      "Hamburger","Cotolette","Salsicce","Minestrone","Pollo al forno","Scaloppine al limone","Caprese","None","Custom…"
    ],
    quick: ["Cordon bleu","Wurstel","Dumplings","Fish sticks","Pollo allo spiedo","None","Custom…"],
    delivery: ["Pizza Delivery","Greco Delivery","Chinese Delivery","Vietnamese Delivery","Ramen Delivery","None","Custom…"],
    weekend: [
      "Pasta al forno","Parmigiana di melanzane","Zucchine ripiene","Lasagna","Spezzatino con patate",
      "Tortellini con la panna","Tortellini col sugo","Pasta col ragù","Polpettone","Polenta col sugo",
      "Cannelloni","Bistecca","None","Custom…"
    ]
  },
  side: [
    "Pure di patate","Broccoli al vapore","Insalata di pomodori","Tater tots","Barbabietole",
    "Insalata di mais","Patate lesse","Carote al forno","Carote a insalata","Zucchine trifolate",
    "Insalata di cetrioli","Insalata","None","Custom…"
  ]
};

// Ingredient mapping (normalized names)
const ING = {
  "Ravioli burro e salvia":["ravioli","sage"],
  "Spaghetti al limone":["spaghetti","lemon"],
  "Pasta e ceci":["pasta","chickpea"],
  "Pasta col tonno":["spaghetti","tuna"],
  "Pasta sugo tonno":["pasta","tuna","tomato sauce"],
  "Piadine prosciutto provolone":["flatbread","prosciutto","provolone"],
  "Uova fritte":["egg"],
  "Pasta al pesto":["pasta","pesto"],
  "Pasta coi pomodorini":["pasta","cherry tomato"],
  "Lenticchie":["lentil","crouton"],
  "Spaghetti aglio e olio":["spaghetti","garlic","olive oil"],
  "Carbonara":["spaghetti","egg","bacon"],
  "Frittata di pasta":["egg","pasta"],
  "Pasta e fagioli":["pasta","bean"],

  "Salmone col riso":["salmon","rice"],
  "Frittata di zucchine":["egg","zucchini"],
  "Polpette":["ground beef","egg","bread","breadcrumb"],
  "Pollo al limone":["chicken breast","lemon"],
  "Merluzzo":["cod"],
  "Hamburger":["bun","ground beef","cheese slice","lettuce","tomato"],
  "Cotolette":["cutlet","breadcrumb","egg"],
  "Salsicce":["sausage"],
  "Minestrone":["vegetable mix","pasta","bean"],
  "Pollo al forno":["chicken thigh"],
  "Scaloppine al limone":["veal cutlet","lemon"],
  "Caprese":["mozzarella","tomato"],

  "Cordon bleu":["cordon bleu"],
  "Wurstel":["hot dog"],
  "Dumplings":["dumpling"],
  "Fish sticks":["fish stick"],
  "Pollo allo spiedo":["whole chicken"],

  "Pasta al forno":["pasta","tomato sauce","mozzarella shredded"],
  "Parmigiana di melanzane":["eggplant","tomato sauce","mozzarella shredded"],
  "Zucchine ripiene":["zucchini","ground beef","bread"],
  "Lasagna":["lasagna noodle","meat sauce"],
  "Spezzatino con patate":["beef","potato","onion","carrot"],
  "Tortellini con la panna":["tortellini","cream"],
  "Tortellini col sugo":["tortellini","tomato sauce"],
  "Pasta col ragù":["pasta","meat sauce"],
  "Polpettone":["ground beef","egg","bacon","bread"],
  "Polenta col sugo":["polenta","tomato sauce","sausage"],
  "Cannelloni":["cannelloni","ricotta","spinach"],
  "Bistecca":["steak"],

  "Pure di patate":["potato"], "Broccoli al vapore":["broccoli"], "Insalata di pomodori":["tomato"],
  "Tater tots":["tater tot"], "Barbabietole":["beet"], "Insalata di mais":["corn"], "Patate lesse":["potato"],
  "Carote al forno":["carrot"], "Carote a insalata":["carrot"], "Zucchine trifolate":["zucchini"],
  "Insalata di cetrioli":["cucumber"], "Insalata":["lettuce"]
};

// Store suggestions
const STORE_PREF = {
  Aldi:["bacon","beet","cannelloni","carrot","chicken thigh","cutlet","crouton","dumpling","bean","fish stick","lemon","corn","mozzarella shredded","potato","chicken breast","flatbread","tomato","cherry tomato","provolone","prosciutto","ravioli","sausage","cheese slice","spinach","tater tot","tortellini","egg","hot dog","zucchini","ground beef","ricotta","milk","pesto","tuna","pasta","rice","breadcrumb","tomato sauce"],
  Wegmans:["steak","broccoli","cucumber","onion","bun","butter","lettuce","lentil","eggplant","cod","whole chicken","sage","salmon","bread"],
  Amazon:["pasta","tuna","breadcrumb","rice","meat sauce","pesto"],
  Other:[]
};

/* ========= State ========== */
const state = {
  week: "next",         // fixed
  weekend: true,
  days: {},             // key -> { lunch, dinner, side, mode, locked }
};
const $ = sel => document.querySelector(sel);
const el = (t, cls)=>{ const n=document.createElement(t); if(cls) n.className=cls; return n; };

function nextWeekStart(){
  const now = new Date(); const d = new Date(now);
  const mondayIndex = (d.getDay()+6)%7;
  const thisMon = new Date(d); thisMon.setDate(d.getDate()-mondayIndex); thisMon.setHours(0,0,0,0);
  const nextMon = new Date(thisMon); nextMon.setDate(thisMon.getDate()+7);
  return nextMon;
}
function keyFor(index){
  const start = nextWeekStart(); const d = new Date(start); d.setDate(start.getDate()+index);
  return `next-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}
function idxFromKey(k){
  const [,Y,M,D] = k.split("-"); const d = new Date(+Y,+M-1,+D);
  const start = nextWeekStart(); return Math.round((d - start)/86400000);
}
function ensureDay(k){
  if(!state.days[k]) state.days[k] = { lunch:"", dinner:"", side:"", mode:"regular", locked:false };
  return state.days[k];
}

/* ========= Render ========== */
function renderRange(){
  const s = nextWeekStart(); const e = new Date(s); e.setDate(s.getDate()+6);
  $("#range").textContent = `${s.toLocaleDateString("en-US",{month:"short",day:"numeric"})} – ${e.toLocaleDateString("en-US",{month:"short",day:"numeric"})}`;
}
function render(){
  renderRange();
  const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  const container = $("#days"); container.innerHTML="";

  for(let i=0;i<7;i++){
    if(i>=5 && !state.weekend) continue;
    const k = keyFor(i);
    const d = ensureDay(k);

    const row = el("section","row"); row.id = `day-${k}`;

    // Left column: day + date
    const left = el("div","day-col");
    const name = el("div","day-name"); name.textContent = days[i]; left.appendChild(name);
    const date = el("div","day-date");
    const start = nextWeekStart(); const dt = new Date(start); dt.setDate(start.getDate()+i);
    date.textContent = dt.toLocaleDateString("en-US",{month:"short",day:"numeric"});
    left.appendChild(date);
    row.appendChild(left);

    // Right column: fields and mode
    const right = el("div");
    const controls = el("div","controls");

    controls.appendChild(pickField(d.lunch, "Lunch", ()=>openPicker(k,"lunch")));
    controls.appendChild(pickField(d.dinner, "Dinner", ()=>openPicker(k,"dinner")));
    // Side only if not delivery
    if(d.mode!=="delivery"){
      controls.appendChild(pickField(d.side, "Side", ()=>openPicker(k,"side")));
    }else{
      const placeholder = el("div","field"); const ph = el("span","small"); ph.textContent="Side (n/a)"; placeholder.appendChild(ph);
      controls.appendChild(placeholder);
    }

    right.appendChild(controls);

    // Mode segmented control (only meaningful on weekdays; but keep visible everywhere for consistency)
    const seg = el("div","seg");
    ["regular","quick","delivery"].forEach(m=>{
      const b = el("button"); b.textContent = m.charAt(0).toUpperCase()+m.slice(1);
      b.setAttribute("aria-pressed", String(d.mode===m));
      b.addEventListener("click", ()=>{
        d.mode = m;
        if(m==="delivery") d.side="";
        if(d.dinner){
          const pool = dinnerPool(d.mode, i>=5);
          if(!pool.includes(d.dinner)) d.dinner="";
        }
        render();
      });
      seg.appendChild(b);
    });
    right.appendChild(seg);

    row.appendChild(right);
    container.appendChild(row);
  }

  // Weekend switch state
  const sw = $("#weekend");
  sw.dataset.on = String(state.weekend);
  sw.setAttribute("aria-checked", String(state.weekend));
}

function pickField(value, label, onClick){
  const f = el("button","field"); f.type="button"; f.setAttribute("aria-label", label);
  const span = el("span", value ? "val" : "ph"); span.textContent = value || `Tap ${label}`;
  f.appendChild(span);
  f.addEventListener("click", onClick);
  return f;
}

/* ========= Picker ========= */
let pickerCtx = null; // {key,type}
function openPicker(key, type){
  pickerCtx = {key,type};
  $("#pickerTitle").textContent = `Choose ${type.charAt(0).toUpperCase()+type.slice(1)}`;
  const list = $("#pickerList"); list.innerHTML="";
  const d = ensureDay(key);
  const isWeekend = idxFromKey(key) >= 5;
  let options = [];

  if(type==="lunch"){ options = LIB.lunch.slice(); }
  else if(type==="dinner"){
    const mode = d.mode;
    if(mode==="quick") options = LIB.dinner.quick.slice();
    else if(mode==="delivery") options = LIB.dinner.delivery.slice();
    else options = (isWeekend ? LIB.dinner.weekend.slice() : LIB.dinner.regular.slice());
  }else{ options = LIB.side.slice(); }

  // Custom row hidden until "Custom…" tapped
  const customRow = $("#pickerCustom"); customRow.hidden = true;

  const listBox = el("div","list");
  options.forEach(name=>{
    const row = el("div","opt"); row.setAttribute("role","option"); row.tabIndex=0;
    row.addEventListener("click", ()=>{
      if(name==="Custom…"){
        customRow.hidden = false;
        $("#customInput").value="";
        $("#customInput").focus();
        return;
      }
      setValue(name==="None" ? "" : name);
      closePicker();
    });
    row.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); row.click(); }});
    const left = el("div"); left.textContent = name;
    const currentVal = (ensureDay(key))[type] || "";
    if((name==="None" && currentVal==="") || name===currentVal){ row.setAttribute("aria-selected","true"); }
    row.appendChild(left);
    listBox.appendChild(row);
  });
  list.appendChild(listBox);

  $("#customUse").onclick = ()=>{
    const v = $("#customInput").value.trim();
    if(!v) return;
    setValue(v); closePicker();
  };

  $("#pickerDone").onclick = closePicker;
  showSheet("#picker"); trapFocus("#picker");

  function setValue(val){
    const d = ensureDay(key);
    d[type] = val;
    if(type==="dinner" && /delivery/i.test(val)) d.side="";
    render();
  }
}
function closePicker(){ hideSheet("#picker"); untrap(); }

/* ========= Grocery (Store only) ========= */
function normalize(word){
  return word.toLowerCase().trim()
    .replace(/s\b/,"")
    .replace(/tomatoes?/,"tomato")
    .replace(/potatoes?/,"potato")
    .replace(/eggs?/,"egg")
    .replace(/buns?/,"bun");
}
function deriveGroceryByStore(){
  const counts = new Map();
  Object.values(state.days).forEach(d=>{
    ["lunch","dinner","side"].forEach(slot=>{
      const meal = d[slot]; if(!meal || !ING[meal]) return;
      ING[meal].forEach(item=>{
        const key = normalize(item);
        counts.set(key, (counts.get(key)||0)+1);
      });
    });
  });

  const byStore = {Aldi:[], Wegmans:[], Amazon:[], Other:[]};
  for(const [item,count] of counts){
    let store = "Other";
    for(const [S,list] of Object.entries(STORE_PREF)){
      if(list.includes(item)){ store = S; break; }
    }
    byStore[store].push({item,count});
  }
  Object.keys(byStore).forEach(s=> byStore[s].sort((a,b)=> a.item.localeCompare(b.item)));
  return byStore;
}

function openGrocery(){
  const body = $("#groceryBody"); body.innerHTML="";
  const data = deriveGroceryByStore();
  const stores = Object.keys(data).filter(s=>data[s].length>0);
  if(stores.length===0){
    const empty = el("div"); empty.style.padding="40px 16px"; empty.style.color="var(--muted)";
    empty.textContent = "No items yet. Add meals first.";
    body.appendChild(empty);
  }else{
    stores.forEach(store=>{
      const g = el("section","group");
      const h = el("h4"); h.textContent = store; g.appendChild(h);
      data[store].forEach(row=>{
        const it = el("div","item");
        const cb = el("input"); cb.type="checkbox";
        const label = el("label"); label.textContent = row.item + (row.count>1?` ×${row.count}`:"");
        it.append(cb,label); g.appendChild(it);
      });
      body.appendChild(g);
    });
  }
  showSheet("#grocery"); trapFocus("#grocery");
}

/* ========= Share (Plan + Grocery) ========= */
function dinnerPool(mode, isWeekend){
  if(mode==="quick") return LIB.dinner.quick.filter(x=>!["None","Custom…"].includes(x));
  if(mode==="delivery") return LIB.dinner.delivery.filter(x=>!["None","Custom…"].includes(x));
  if(isWeekend) return LIB.dinner.weekend.filter(x=>!["None","Custom…"].includes(x));
  return LIB.dinner.regular.filter(x=>!["None","Custom…"].includes(x));
}
function buildPlanText(){
  const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  const s = nextWeekStart(); const e = new Date(s); e.setDate(s.getDate()+6);
  let out = `Meal Plan — Next Week\n${s.toLocaleDateString("en-US",{month:"short",day:"numeric"})} – ${e.toLocaleDateString("en-US",{month:"short",day:"numeric"})}\n\n`;
  for(let i=0;i<7;i++){
    if(i>=5 && !state.weekend) continue;
    const k = keyFor(i), d = ensureDay(k);
    out += `${days[i]}\n`;
    if(d.lunch) out += `  Lunch: ${d.lunch}\n`;
    if(d.dinner){
      out += `  Dinner: ${d.dinner}`;
      if(d.side) out += ` with ${d.side}`;
      out += `\n`;
    }
    if(!d.lunch && !d.dinner) out += `  No meals\n`;
    out += `\n`;
  }
  return out.trim();
}
function buildGroceryText(){
  const data = deriveGroceryByStore();
  const stores = Object.keys(data).filter(s=>data[s].length>0);
  if(stores.length===0) return "Grocery List\n\n(Empty)";
  let out = "Grocery List (by store)\n\n";
  stores.forEach(store=>{
    out += `# ${store}\n`;
    data[store].forEach(r=>{ out += `• ${r.item}${r.count>1?` x${r.count}`:""}\n`; });
    out += `\n`;
  });
  return out.trim();
}
async function shareAll(){
  const text = `${buildPlanText()}\n\n${buildGroceryText()}`;
  if(navigator.share){
    try{ await navigator.share({title:"Meal Plan + Grocery", text}); return; }catch(e){}
  }
  $("#shareText").textContent = text;
  showSheet("#share"); trapFocus("#share");
}

/* ========= Randomize ========= */
function pick(pool, prev){
  if(pool.length===0) return "";
  if(pool.length===1) return pool[0];
  let c, tries=0;
  do{ c = pool[Math.floor(Math.random()*pool.length)]; tries++; } while(c===prev && tries<5);
  return c;
}
function shuffleDay(key){
  const d = ensureDay(key);
  const i = idxFromKey(key);
  const prevKey = keyFor(Math.max(i-1,0));
  const prev = state.days[prevKey] || {};
  const lunchPool = LIB.lunch.filter(x=>!["None","Custom…"].includes(x));
  const dinnerPoolList = dinnerPool(d.mode, i>=5);
  const sidePool = LIB.side.filter(x=>!["None","Custom…"].includes(x));

  d.lunch = pick(lunchPool, prev.lunch);
  d.dinner = pick(dinnerPoolList, prev.dinner);
  d.side = (d.mode==="delivery") ? "" : pick(sidePool, prev.side);
}
function shuffleWeek(){
  for(let i=0;i<7;i++){
    if(i>=5 && !state.weekend) continue;
    shuffleDay(keyFor(i));
  }
  render();
}

/* ========= Sheets, focus trap ========= */
const inertTargets = ["#app"];
function showSheet(sel){
  $("#scrim").classList.add("show");
  const sh = document.querySelector(sel); sh.classList.add("show");
  document.body.classList.add("no-scroll");
  inertTargets.forEach(s=>{ const n=document.querySelector(s); if(n) n.inert = true; });
}
function hideSheet(sel){
  $("#scrim").classList.remove("show");
  const sh = document.querySelector(sel); sh.classList.remove("show");
  document.body.classList.remove("no-scroll");
  inertTargets.forEach(s=>{ const n=document.querySelector(s); if(n) n.inert = false; });
}
let untrap = ()=>{};
function trapFocus(sel){
  const root = document.querySelector(sel);
  const F='button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])';
  const nodes = ()=> Array.from(root.querySelectorAll(F)).filter(n=>!n.disabled && n.offsetParent!==null);
  function onKey(e){
    if(e.key!=="Tab") return;
    const list = nodes(); if(!list.length) return;
    const first=list[0], last=list[list.length-1];
    if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
    if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
  }
  root.addEventListener("keydown", onKey);
  setTimeout(()=>{ nodes()[0]?.focus(); }, 0);
  untrap = ()=> root.removeEventListener("keydown", onKey);
}

/* ========= Events ========= */
$("#weekend").addEventListener("click", ()=>{ state.weekend = !state.weekend; render(); });
$("#weekend").addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); $("#weekend").click(); }});

$("#btnShuffle").addEventListener("click", shuffleWeek);
$("#btnGrocery").addEventListener("click", openGrocery);
$("#btnShare").addEventListener("click", shareAll);

$("#groceryCopy").addEventListener("click", async ()=>{
  await navigator.clipboard.writeText(buildGroceryText());
  hideSheet("#grocery");
});
$("#groceryClose").addEventListener("click", ()=> hideSheet("#grocery"));

$("#shareCopy").addEventListener("click", async ()=>{
  await navigator.clipboard.writeText(`${buildPlanText()}\n\n${buildGroceryText()}`);
  hideSheet("#share");
});
$("#shareClose").addEventListener("click", ()=> hideSheet("#share"));

$("#clearAll").addEventListener("click", ()=>{
  if(!confirm("Clear all meals for visible days?")) return;
  for(let i=0;i<7;i++){
    if(i>=5 && !state.weekend) continue;
    const k = keyFor(i), cur = ensureDay(k);
    state.days[k] = { lunch:"", dinner:"", side:"", mode:cur.mode, locked:false };
  }
  render();
});

$("#scrim").addEventListener("click", ()=>{
  ["#picker","#grocery","#share"].forEach(sel=> hideSheet(sel));
  untrap();
});
document.addEventListener("keydown",(e)=>{
  if(e.key!=="Escape") return;
  ["#picker","#grocery","#share"].forEach(sel=>{
    const node = document.querySelector(sel);
    if(node.classList.contains("show")) hideSheet(sel);
  });
  untrap();
});

/* ========= Init ========= */
render();
</script>
</body>
</html>
