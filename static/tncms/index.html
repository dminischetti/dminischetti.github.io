<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogLens Local</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.4;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #58a6ff;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            color: #8b949e;
            font-size: 1em;
        }
        .controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            margin-bottom: 20px;
            align-items: start;
        }
        .input-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 280px;
        }
        textarea {
            width: 100%;
            height: 200px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: #c9d1d9;
            padding: 15px;
            font-family: inherit;
            font-size: 13px;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        .filter-group {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
        }
        .filter-group h3 {
            color: #f0f6fc;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .filter-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        input, select {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            padding: 6px 10px;
            font-family: inherit;
            font-size: 12px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #58a6ff;
        }
        button {
            background: #238636;
            border: none;
            border-radius: 6px;
            color: white;
            padding: 8px 16px;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        button:hover {
            background: #2ea043;
        }
        button.secondary {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }
        button.secondary:hover {
            background: #30363d;
        }
        .floating-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        .floating-toolbar button {
            padding: 6px 12px;
            font-size: 11px;
        }
        .stats {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #58a6ff;
        }
        .stat-label {
            color: #8b949e;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .heatmap {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .heatmap h3 {
            color: #f0f6fc;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .heatmap-bar {
            display: flex;
            height: 40px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .heatmap-segment {
            height: 100%;
            transition: opacity 0.2s;
            cursor: pointer;
            position: relative;
        }
        .heatmap-segment:hover {
            opacity: 0.8;
        }
        .heatmap-legend {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #8b949e;
        }
        .log-entries {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .log-entry {
            border-bottom: 1px solid #21262d;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }
        .log-entry:hover {
            background: #161b22;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-entry.bookmarked {
            border-left: 4px solid #f1c40f;
        }
        .log-entry.highlighted {
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
        }
        .log-header {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
            position: sticky;
            top: 0;
            background: inherit;
            z-index: 10;
        }
        .timestamp {
            color: #7c3aed;
            font-weight: bold;
            font-size: 12px;
        }
        .timestamp .relative-time {
            color: #8b949e;
            font-size: 10px;
            display: block;
        }
        .level {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .level-error {
            background: #da3633;
            color: white;
        }
        .level-debug {
            background: #1f6feb;
            color: white;
        }
        .level-info {
            background: #238636;
            color: white;
        }
        .level-warning {
            background: #fb8500;
            color: white;
        }
        .level-notice {
            background: #fbbf24;
            color: #000;
        }
        .level-fatal {
            background: #dc2626;
            color: white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .server {
            color: #79c0ff;
            font-size: 12px;
        }
        .pid {
            color: #ffa657;
            font-size: 12px;
        }
        .bookmark-btn {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            transition: color 0.2s;
        }
        .bookmark-btn:hover {
            color: #f1c40f;
        }
        .bookmark-btn.active {
            color: #f1c40f;
        }
        .log-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .filename {
            color: #a5f3fc;
            font-size: 12px;
        }
        .filename .line-number {
            color: #fbbf24;
        }
        .message {
            background: #21262d;
            border-left: 3px solid #58a6ff;
            padding: 10px;
            border-radius: 4px;
            color: #f0f6fc;
            font-size: 13px;
        }
        .message.php-error {
            border-left-color: #da3633;
        }
        .message.php-notice {
            border-left-color: #fbbf24;
        }
        .message.php-warning {
            border-left-color: #fb8500;
        }
        .php-insight {
            background: #2d1b69;
            border: 1px solid #553c9a;
            border-radius: 4px;
            padding: 8px;
            margin-top: 5px;
            font-size: 11px;
            color: #c4b5fd;
        }
        .php-insight .insight-title {
            font-weight: bold;
            color: #a78bfa;
            margin-bottom: 3px;
        }
        .stack-trace {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            transition: max-height 0.3s ease;
            overflow: hidden;
        }
        .stack-trace-header {
            color: #fbbf24;
            margin-bottom: 5px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stack-trace-header:hover {
            color: #fde047;
        }
        .stack-trace-content {
            color: #94a3b8;
            white-space: pre-wrap;
        }
        .stack-trace.collapsed {
            max-height: 40px;
        }
        .stack-trace.collapsed .stack-trace-content {
            display: none;
        }
        .group-header {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 10px 0;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        .group-header:hover {
            background: #30363d;
            transform: translateY(-1px);
        }
        .group-count {
            background: #238636;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        .group-content {
            margin-left: 20px;
            border-left: 2px solid #30363d;
            padding-left: 15px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .group-content.collapsed {
            max-height: 0;
            padding: 0 0 0 15px;
        }
        .no-logs {
            text-align: center;
            padding: 60px 20px;
            color: #8b949e;
        }
        .regex-highlight {
            background: rgba(255, 193, 7, 0.3);
            padding: 1px 2px;
            border-radius: 2px;
        }
        .keyboard-shortcuts {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            display: none;
            z-index: 2000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        .keyboard-shortcuts h3 {
            color: #f0f6fc;
            margin-bottom: 15px;
        }
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .shortcut-key {
            background: #0d1117;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #30363d;
        }
        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            .log-header {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .container {
                padding: 15px;
            }
            .floating-toolbar {
                flex-direction: row;
                bottom: 10px;
                right: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>LogLens Local</h1>
            <p>Enhanced PHP log parser for backend developers</p>
        </div>
        <div class="controls">
            <div class="input-section">
                <textarea id="logInput" placeholder="Paste your raw log entries here...
Example:
Aug  1 16:04:12 172.20.10.2 townnews-error[1492212]: [filename=...] [level=error] [line=919] [message=...] [time=...] #0 ... #1 ...

Keyboard shortcuts: Ctrl+Enter to parse, Esc to clear, ? for help"></textarea>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="parseLog()">Parse Logs</button>
                    <button class="secondary" onclick="clearAll()">Clear All</button>
                    <input type="file" id="fileInput" accept=".txt,.log" style="display: none;" onchange="loadFile()">
                    <button class="secondary" onclick="document.getElementById('fileInput').click()">Load File</button>
                    <button class="secondary" onclick="exportLogs()">Export</button>
                    <button class="secondary" onclick="toggleShortcuts()">Shortcuts (?)</button>
                </div>
            </div>
            <div class="filter-section">
                <div class="filter-group">
                    <h3>Filters</h3>
                    <div class="filter-controls">
                        <div class="filter-row">
                            <select id="levelFilter">
                                <option value="">All Levels</option>
                                <option value="error">Error</option>
                                <option value="debug">Debug</option>
                                <option value="info">Info</option>
                                <option value="warning">Warning</option>
                                <option value="notice">Notice</option>
                                <option value="fatal">Fatal</option>
                            </select>
                        </div>
                        <div class="filter-row">
                            <input type="text" id="messageFilter" placeholder="Filter by message...">
                        </div>
                        <div class="filter-row">
                            <input type="text" id="filenameFilter" placeholder="Filter by filename...">
                        </div>
                        <div class="filter-row">
                            <input type="text" id="serverFilter" placeholder="Filter by server...">
                        </div>
                        <div class="filter-row">
                            <input type="text" id="regexFilter" placeholder="Regex highlight pattern...">
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <h3>Options</h3>
                    <div class="filter-controls">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                            <input type="checkbox" id="groupSimilar" checked>
                            Group similar errors
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                            <input type="checkbox" id="collapseStack" checked>
                            Collapse stack traces
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                            <input type="checkbox" id="showRelativeTime" checked>
                            Show relative time
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                            <input type="checkbox" id="phpInsights" checked>
                            PHP insights
                        </label>
                        <div class="filter-row">
                            <select id="timezoneSelect">
                                <option value="local">Local Time</option>
                                <option value="utc">UTC</option>
                                <option value="est">EST</option>
                                <option value="pst">PST</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="stats" class="stats" style="display: none;">
            <div class="stat-item">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total Entries</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="errorCount">0</div>
                <div class="stat-label">Errors</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="uniqueFiles">0</div>
                <div class="stat-label">Unique Files</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="timeRange">-</div>
                <div class="stat-label">Time Range</div>
            </div>
        </div>
        <div id="heatmap" class="heatmap" style="display: none;">
            <h3>Error Frequency Timeline</h3>
            <div class="heatmap-bar" id="heatmapBar"></div>
            <div class="heatmap-legend">
                <span>Low</span>
                <span>High</span>
            </div>
        </div>
        <div id="logOutput" class="log-entries">
            <div class="no-logs">
                <h3>No logs to display</h3>
                <p>Paste log entries above and click "Parse Logs" to get started</p>
                <p><small>Press Ctrl+Enter to parse quickly</small></p>
            </div>
        </div>
    </div>
    <div class="floating-toolbar" id="floatingToolbar">
        <button onclick="copyAllLogs()">📋 Copy All</button>
        <button onclick="collapseAllGroups()">📁 Collapse All</button>
        <button onclick="expandAllGroups()">📂 Expand All</button>
        <button onclick="clearBookmarks()">⭐ Clear Bookmarks</button>
    </div>
    <div class="keyboard-shortcuts" id="keyboardShortcuts">
        <h3>Keyboard Shortcuts</h3>
        <div class="shortcut-item">
            <span>Parse logs</span>
            <span class="shortcut-key">Ctrl + Enter</span>
        </div>
        <div class="shortcut-item">
            <span>Clear all</span>
            <span class="shortcut-key">Esc</span>
        </div>
        <div class="shortcut-item">
            <span>Focus filter</span>
            <span class="shortcut-key">F</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle shortcuts</span>
            <span class="shortcut-key">?</span>
        </div>
        <div class="shortcut-item">
            <span>Copy all logs</span>
            <span class="shortcut-key">Ctrl + C</span>
        </div>
        <div style="margin-top: 10px; text-align: center;">
            <button class="secondary" onclick="toggleShortcuts()">Close</button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
    <script>
        // LogLens Local - JavaScript Logic
        // This script handles parsing, filtering, and rendering of log entries.

        let parsedLogs = [];
        let filteredLogs = [];
        let bookmarkedLogs = new Set();
        let currentRegex = null;

        // PHP error patterns and insights for generating helpful suggestions.
        const phpInsights = {
            'Undefined array key': {
                title: 'Undefined Array Key',
                suggestion: 'Use isset() or null coalescing operator (??) to check if array key exists before accessing.'
            },
            'Trying to access array offset on null': {
                title: 'Null Array Access',
                suggestion: 'Check if variable is not null before accessing array elements. Use is_array() check.'
            },
            'Call to protected': {
                title: 'Protected Method Access',
                suggestion: 'Method is protected and called from outside class scope. Check visibility or use public method.'
            },
            'Declaration of': {
                title: 'Method Signature Mismatch',
                suggestion: 'Method signature doesn\'t match parent class. Ensure parameter types and counts match.'
            },
            'Connection timed out': {
                title: 'Network Timeout',
                suggestion: 'Check network connectivity, increase timeout values, or verify service availability.'
            },
            'Authentication failed': {
                title: 'Authentication Issue',
                suggestion: 'Verify credentials, check authentication server status, or review auth configuration.'
            }
        };

        /**
         * Main function to parse log input from the textarea.
         * It splits the input, parses each line, applies filters, and renders the output.
         */
        function parseLog() {
            const input = document.getElementById('logInput').value.trim();
            if (!input) return;

            const lines = input.split('\n').filter(line => line.trim());
            parsedLogs = [];
            lines.forEach((line, index) => {
                const parsed = parseLogLine(line);
                if (parsed) {
                    parsed.originalIndex = index;
                    parsedLogs.push(parsed);
                }
            });

            applyFilters();
            updateStats();
            generateHeatmap();
            renderLogs();
            showFloatingToolbar();
        }

        /**
         * Parses a single log line using a robust regex pattern.
         * @param {string} line The raw log string.
         * @returns {object|null} The parsed log object or null if parsing fails.
         */
        function parseLogLine(line) {
            // Updated regex to correctly parse the example log format.
            const pattern = /^(\w+\s+\d+\s+\d{2}:\d{2}:\d{2})\s+([^\[\]]+)\s+([^\[]+)\[(\d+)\]:\s*(.+)$/;
            const match = line.match(pattern);

            if (match) {
                const [, timestamp, server, service, pid, content] = match;
                
                const parsed = {
                    timestamp,
                    server,
                    service,
                    pid,
                    content,
                    raw: line,
                    parsedDate: parseTimestamp(timestamp)
                };
                parseStructuredContent(parsed, content);
                return parsed;
            }
            return null;
        }

        /**
         * Parses a timestamp string and returns a Date object. Assumes the current year.
         * @param {string} timestamp The timestamp string (e.g., "Aug 1 16:04:12").
         * @returns {Date} The parsed Date object.
         */
        function parseTimestamp(timestamp) {
            const year = new Date().getFullYear();
            const dateStr = `${timestamp} ${year}`;
            return new Date(dateStr);
        }

        /**
         * Parses the structured content of a log line (e.g., [key=value]).
         * @param {object} parsed The log object to populate.
         * @param {string} content The structured content part of the log line.
         */
        function parseStructuredContent(parsed, content) {
            const kvPattern = /\[([^=]+)=([^\]]*)\]/g;
            let match;
            const fields = {};
            while ((match = kvPattern.exec(content)) !== null) {
                fields[match[1]] = match[2];
            }

            parsed.level = fields.level || 'info';
            parsed.filename = fields.filename || 'Unknown';
            parsed.line = fields.line || '';
            parsed.message = fields.message || content; // Fallback to content if no message is found.

            // Extract and highlight stack trace
            const stackMatch = content.match(/#\d+[^\n]*(?:\n#\d+[^\n]*)*/);
            if (stackMatch) {
                parsed.stackTrace = highlightStackTrace(stackMatch[0]);
            }

            // Generate signature for grouping based on message prefix
            parsed.similarity = parsed.message.toLowerCase().split(/\s+/).slice(0, 5).join(' ');
        }

        /**
         * Highlights PHP syntax in a stack trace string.
         * @param {string} stackTrace The raw stack trace string.
         * @returns {string} The HTML-formatted stack trace.
         */
        function highlightStackTrace(stackTrace) {
            return stackTrace
                .replace(/(\w+)::/g, '<span style="color: #79c0ff">$1</span>::')
                .replace(/->(\w+)/g, '-><span style="color: #ffa657">$1</span>')
                .replace(/(\w+\.php)/g, '<span style="color: #a5f3fc">$1</span>')
                .replace(/\((\d+)\)/g, '(<span style="color: #fbbf24">$1</span>)');
        }

        /**
         * Applies filters from the UI to the parsed logs.
         */
        function applyFilters() {
            const levelFilter = document.getElementById('levelFilter').value;
            const messageFilter = document.getElementById('messageFilter').value.toLowerCase();
            const filenameFilter = document.getElementById('filenameFilter').value.toLowerCase();
            const serverFilter = document.getElementById('serverFilter').value.toLowerCase();
            const regexPattern = document.getElementById('regexFilter').value;

            // Compile regex if provided
            currentRegex = null;
            if (regexPattern) {
                try {
                    currentRegex = new RegExp(regexPattern, 'gi');
                } catch (e) {
                    console.error("Invalid regex:", e);
                }
            }

            filteredLogs = parsedLogs.filter(log => {
                if (levelFilter && log.level !== levelFilter) return false;
                if (messageFilter && !log.message.toLowerCase().includes(messageFilter)) return false;
                if (filenameFilter && !log.filename.toLowerCase().includes(filenameFilter)) return false;
                if (serverFilter && !log.server.toLowerCase().includes(serverFilter)) return false;
                return true;
            });
        }

        /**
         * Updates the statistics displayed in the stats bar.
         */
        function updateStats() {
            document.getElementById('stats').style.display = 'block';
            document.getElementById('totalCount').textContent = parsedLogs.length;
            
            const errorCount = parsedLogs.filter(log => log.level === 'error' || log.level === 'fatal').length;
            document.getElementById('errorCount').textContent = errorCount;

            const uniqueFiles = new Set(parsedLogs.map(log => log.filename)).size;
            document.getElementById('uniqueFiles').textContent = uniqueFiles;
            
            if (parsedLogs.length > 0) {
                const firstDate = parsedLogs[0].parsedDate;
                const lastDate = parsedLogs[parsedLogs.length - 1].parsedDate;
                const timeDiffMs = lastDate - firstDate;
                const timeDiffMin = Math.floor(timeDiffMs / 60000);
                document.getElementById('timeRange').textContent = `${timeDiffMin} minutes`;
            } else {
                 document.getElementById('timeRange').textContent = '-';
            }
        }

        /**
         * Generates the heatmap timeline visualization.
         */
        function generateHeatmap() {
            if (parsedLogs.length === 0) return;
            
            document.getElementById('heatmap').style.display = 'block';
            const heatmapBar = document.getElementById('heatmapBar');
            
            const hourlyData = {};
            parsedLogs.forEach(log => {
                const hour = log.parsedDate.getHours();
                hourlyData[hour] = (hourlyData[hour] || 0) + 1;
            });
            
            const maxCount = Math.max(...Object.values(hourlyData));
            heatmapBar.innerHTML = '';
            
            for (let hour = 0; hour < 24; hour++) {
                const count = hourlyData[hour] || 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                const segment = document.createElement('div');
                segment.className = 'heatmap-segment';
                segment.style.width = `${100/24}%`;
                segment.style.backgroundColor = `rgba(220, 38, 38, ${intensity})`;
                segment.title = `${hour}:00 - ${count} errors`;
                heatmapBar.appendChild(segment);
            }
        }

        /**
         * Renders the log entries based on filters and grouping options.
         */
        function renderLogs() {
            const output = document.getElementById('logOutput');
            const groupSimilar = document.getElementById('groupSimilar').checked;
            
            if (filteredLogs.length === 0) {
                output.innerHTML = '<div class="no-logs"><h3>No logs match your filters</h3></div>';
                return;
            }

            let html = '';
            if (groupSimilar) {
                const groups = {};
                filteredLogs.forEach(log => {
                    const key = log.similarity;
                    if (!groups[key]) {
                        groups[key] = [];
                    }
                    groups[key].push(log);
                });

                Object.keys(groups).forEach(key => {
                    const logs = groups[key];
                    const firstLog = logs[0];
                    const count = logs.length;
                    
                    html += `
                        <div class="group-header" onclick="toggleGroup('${btoa(key)}')">
                            <div>
                                <strong>${firstLog.service}</strong> - ${firstLog.filename}:${firstLog.line} 
                                ${firstLog.message.substring(0, 100)}${firstLog.message.length > 100 ? '...' : ''}
                            </div>
                            <div>
                                <span class="group-count">${count}</span>
                            </div>
                        </div>
                        <div class="group-content" id="group-${btoa(key)}">
                    `;
                    logs.forEach(log => {
                        html += renderLogEntry(log);
                    });
                    html += '</div>';
                });
            } else {
                filteredLogs.forEach(log => {
                    html += renderLogEntry(log);
                });
            }
            output.innerHTML = html;
        }

        /**
         * Renders a single log entry as an HTML string.
         * @param {object} log The log object to render.
         * @returns {string} The HTML string for the log entry.
         */
        function renderLogEntry(log) {
            const collapseStack = document.getElementById('collapseStack').checked;
            const showRelativeTime = document.getElementById('showRelativeTime').checked;
            const phpInsightsEnabled = document.getElementById('phpInsights').checked;
            
            const relativeTime = showRelativeTime ? getRelativeTime(log.parsedDate) : '';
            const isBookmarked = bookmarkedLogs.has(log.originalIndex);
            
            let highlightedMessage = log.message;
            if (currentRegex) {
                highlightedMessage = log.message.replace(currentRegex, `<span class="regex-highlight">$&</span>`);
            }
            
            const insight = phpInsightsEnabled ? getPHPInsight(log.message) : null;
            
            let messageClass = '';
            const message = log.message.toLowerCase();
            if (message.includes('fatal error') || message.includes('parse error')) {
                messageClass = 'php-error';
            } else if (message.includes('notice') || message.includes('undefined')) {
                messageClass = 'php-notice';  
            } else if (message.includes('warning')) {
                messageClass = 'php-warning';
            }
            
            return `
                <div class="log-entry ${isBookmarked ? 'bookmarked' : ''}" data-index="${log.originalIndex}">
                    <div class="log-header">
                        <div class="timestamp">
                            ${formatTimestamp(log.parsedDate)}
                            ${relativeTime ? `<span class="relative-time">${relativeTime}</span>` : ''}
                        </div>
                        <div class="server">${log.server}</div>
                        <div class="level level-${log.level}">${log.level}</div>
                        <div class="pid">PID: ${log.pid}</div>
                        <button class="bookmark-btn ${isBookmarked ? 'active' : ''}" onclick="toggleBookmark(${log.originalIndex})" title="Bookmark this entry">
                            ${isBookmarked ? '⭐' : '☆'}
                        </button>
                    </div>
                    <div class="log-details">
                        <div class="filename">
                            ${log.filename}${log.line ? `:<span class="line-number">${log.line}</span>` : ''}
                        </div>
                        <div class="message ${messageClass}">${highlightedMessage}</div>
                        ${insight ? `
                            <div class="php-insight">
                                <div class="insight-title">${insight.title}</div>
                                <div>${insight.suggestion}</div>
                            </div>
                        ` : ''}
                        ${log.stackTrace ? `
                            <div class="stack-trace ${collapseStack ? 'collapsed' : ''}">
                                <div class="stack-trace-header" onclick="toggleStackTrace(this)">
                                    <span>📋</span>
                                    <span>Stack Trace ${collapseStack ? '(click to expand)' : '(click to collapse)'}</span>
                                </div>
                                <div class="stack-trace-content"><pre><code class="language-php">${log.stackTrace}</code></pre></div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        /**
         * Formats a Date object to a string based on the selected timezone.
         * @param {Date} date The Date object to format.
         * @returns {string} The formatted date string.
         */
        function formatTimestamp(date) {
            const timezone = document.getElementById('timezoneSelect').value;
            const options = {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false
            };

            switch (timezone) {
                case 'utc':
                    options.timeZone = 'UTC';
                    break;
                case 'est':
                    options.timeZone = 'America/New_York';
                    break;
                case 'pst':
                    options.timeZone = 'America/Los_Angeles';
                    break;
                default: // local
                    return date.toLocaleString('en-US', options);
            }
            return date.toLocaleString('en-US', options);
        }

        /**
         * Calculates the relative time string (e.g., "5s ago").
         * @param {Date} date The date to compare against the current time.
         * @returns {string} The relative time string.
         */
        function getRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffDays > 0) return `${diffDays}d ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            if (diffMins > 0) return `${diffMins}m ago`;
            return `${diffSecs}s ago`;
        }

        /**
         * Gets a PHP insight object based on the log message.
         * @param {string} message The log message string.
         * @returns {object|null} The insight object or null.
         */
        function getPHPInsight(message) {
            for (const [pattern, insight] of Object.entries(phpInsights)) {
                if (message.includes(pattern)) {
                    return insight;
                }
            }
            return null;
        }

        /**
         * Toggles the visibility of a log group.
         * @param {string} signature The base64-encoded group signature.
         */
        function toggleGroup(signature) {
            const group = document.getElementById(`group-${signature}`);
            if (group) {
                group.classList.toggle('collapsed');
            }
        }

        /**
         * Toggles the visibility of a stack trace section.
         * @param {HTMLElement} element The header element of the stack trace.
         */
        function toggleStackTrace(element) {
            const stackTrace = element.parentElement;
            stackTrace.classList.toggle('collapsed');
            
            const span = element.querySelector('span:last-child');
            if (stackTrace.classList.contains('collapsed')) {
                span.textContent = 'Stack Trace (click to expand)';
            } else {
                span.textContent = 'Stack Trace (click to collapse)';
                Prism.highlightAllUnder(stackTrace);
            }
        }

        /**
         * Toggles the bookmarked status of a log entry.
         * @param {number} index The original index of the log entry.
         */
        function toggleBookmark(index) {
            if (bookmarkedLogs.has(index)) {
                bookmarkedLogs.delete(index);
            } else {
                bookmarkedLogs.add(index);
            }
            renderLogs();
        }

        /**
         * Shows the floating toolbar.
         */
        function showFloatingToolbar() {
            document.getElementById('floatingToolbar').style.display = 'flex';
        }

        /**
         * Copies all filtered logs to the clipboard.
         */
        function copyAllLogs() {
            const logText = filteredLogs.map(log => log.raw).join('\n');
            navigator.clipboard.writeText(logText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Copied!';
                setTimeout(() => btn.textContent = originalText, 2000);
            });
        }

        /**
         * Collapses all log groups and stack traces.
         */
        function collapseAllGroups() {
            document.querySelectorAll('.group-content').forEach(group => {
                group.classList.add('collapsed');
            });
            document.querySelectorAll('.stack-trace').forEach(stack => {
                stack.classList.add('collapsed');
            });
        }

        /**
         * Expands all log groups and stack traces.
         */
        function expandAllGroups() {
            document.querySelectorAll('.group-content').forEach(group => {
                group.classList.remove('collapsed');
            });
            document.querySelectorAll('.stack-trace').forEach(stack => {
                stack.classList.remove('collapsed');
            });
        }

        /**
         * Clears all bookmarks.
         */
        function clearBookmarks() {
            bookmarkedLogs.clear();
            renderLogs();
        }

        /**
         * Exports the filtered logs to a JSON file.
         */
        function exportLogs() {
            const data = {
                timestamp: new Date().toISOString(),
                totalLogs: parsedLogs.length,
                filteredLogs: filteredLogs.length,
                bookmarks: Array.from(bookmarkedLogs),
                logs: filteredLogs
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loglens-export-${new Date().toISOString().slice(0, 19)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        /**
         * Clears all log data from the app.
         */
        function clearAll() {
            document.getElementById('logInput').value = '';
            document.getElementById('logOutput').innerHTML = '<div class="no-logs"><h3>No logs to display</h3><p>Paste log entries above and click "Parse Logs" to get started</p><p><small>Press Ctrl+Enter to parse quickly</small></p></div>';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('heatmap').style.display = 'none';
            document.getElementById('floatingToolbar').style.display = 'none';
            parsedLogs = [];
            filteredLogs = [];
            bookmarkedLogs.clear();
        }

        /**
         * Loads a log file from the user's computer.
         */
        function loadFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('logInput').value = e.target.result;
                parseLog();
            };
            reader.readAsText(file);
        }

        /**
         * Toggles the keyboard shortcuts modal.
         */
        function toggleShortcuts() {
            const shortcuts = document.getElementById('keyboardShortcuts');
            shortcuts.style.display = shortcuts.style.display === 'block' ? 'none' : 'block';
        }

        // Keyboard shortcuts event listener
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter: Parse logs
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                parseLog();
            }
            
            // Escape: Clear all
            if (e.key === 'Escape') {
                e.preventDefault();
                if (document.getElementById('keyboardShortcuts').style.display === 'block') {
                    toggleShortcuts();
                } else {
                    clearAll();
                }
            }
            
            // F: Focus filter
            if (e.key === 'f' || e.key === 'F') {
                if (!e.ctrlKey && !e.altKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    document.getElementById('messageFilter').focus();
                }
            }
            
            // ?: Toggle shortcuts
            if (e.key === '?' && !e.ctrlKey && !e.altKey) {
                e.preventDefault();
                toggleShortcuts();
            }
            
            // Ctrl+C: Copy all (when not in input field)
            if (e.ctrlKey && e.key === 'c' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                if (filteredLogs.length > 0) {
                    e.preventDefault();
                    copyAllLogs();
                }
            }
        });

        // Event listeners for auto-applying filters
        ['levelFilter', 'messageFilter', 'filenameFilter', 'serverFilter', 'regexFilter'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                if (parsedLogs.length > 0) {
                    applyFilters();
                    renderLogs();
                }
            });
        });

        // Event listeners for rendering options
        ['groupSimilar', 'collapseStack', 'showRelativeTime', 'phpInsights'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                if (parsedLogs.length > 0) {
                    renderLogs();
                }
            });
        });

        // Event listener for timezone change
        document.getElementById('timezoneSelect').addEventListener('change', () => {
            if (parsedLogs.length > 0) {
                renderLogs();
            }
        });

        // URL parameter loading on window load
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const logData = urlParams.get('logs');
            if (logData) {
                try {
                    document.getElementById('logInput').value = decodeURIComponent(logData);
                    parseLog();
                } catch (e) {
                    console.error('Error loading logs from URL:', e);
                }
            }
            // Initial highlighting for the example logs in the textarea
            Prism.highlightAll();
        });
    </script>
</body>
</html>
