<header class="header" role="banner">
  <div class="header-inner">
    <div class="header-content">
      <!-- Logo -->
      <a href="/" class="logo" aria-label="Torna alla Homepage">
        <span class="logo-icon">DM</span>
        <span class="logo-text">Dominic Minischetti</span>
      </a>

      <!-- Back to Blog (solo nelle pagine articolo) -->
      {{ if .IsPage }}
      <a href="/blog" class="back-link" aria-label="Torna al Blog">
        <svg class="back-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span>Blog</span>
      </a>
      {{ end }}
    </div>
  </div>

  <!-- Theme Toggle Button -->
  <button
    class="theme-toggle"
    id="theme-toggle"
    aria-label="Cambia tema"
    title="Cambia tema chiaro/scuro"
  >
    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
    </svg>
    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>
</header>

document.addEventListener('DOMContentLoaded', function() {
  (function () {
    const btn = document.getElementById("theme-toggle");
    if (!btn) {
      // This is a good place to log if the button is truly missing
      // console.warn("Theme toggle button with id 'theme-toggle' was not found.");
      return;
    }

    // PaperMod toggles .dark on the <html> element with recent versions
    const target = document.documentElement;
    const storageKey = "pref-theme";

    // This function sets the theme and is reusable
    const applyTheme = (theme) => {
      if (theme === "dark") {
        target.classList.add("dark");
      } else {
        target.classList.remove("dark");
      }
      localStorage.setItem(storageKey, theme);
      updateMeta(theme === "dark");
    };

    // Optional: sync theme color meta for mobile browsers
    const themeMeta = document.querySelector('meta[name="theme-color"]');
    const updateMeta = (isDark) => {
      if (!themeMeta) return;
      themeMeta.setAttribute("content", isDark ? "#1d232a" : "#ffffff"); // Updated dark color
    };

    // Add toggle listener
    btn.addEventListener("click", () => {
      const isDark = target.classList.toggle("dark");
      localStorage.setItem(storageKey, isDark ? "dark" : "light");
      updateMeta(isDark);
    });

    // Listen to system theme changes ONLY if no preference is set
    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
        // Only change theme if the user hasn't manually set one
        if (!localStorage.getItem(storageKey)) {
             applyTheme(e.matches ? "dark" : "light");
        }
    });
  })();
});
