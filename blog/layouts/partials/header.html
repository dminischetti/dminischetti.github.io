{{- $defaultTheme := site.Params.defaultTheme | default "auto" -}}
{{- $disableToggle := site.Params.disableThemeToggle | default false -}}

{{- if not $disableToggle }}
<script>
  (function () {
    const storageKey = "pref-theme";
    const defaultTheme = "{{ $defaultTheme }}";
    const storedTheme = localStorage.getItem(storageKey);
    const supportsDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;

    if (storedTheme === "dark" || (!storedTheme && (defaultTheme === "dark" || (defaultTheme === "auto" && supportsDark)))) {
      document.body.classList.add("dark");
    } else {
      document.body.classList.remove("dark");
    }
  })();
</script>
{{- end }}

<header class="header" role="banner">
  <div class="container header-inner">
    <a href="/" class="logo" aria-label="Torna alla Homepage">
      <span class="logo-icon">DM</span>
      <span class="logo-text">Dominic Minischetti</span>
    </a>

    <div class="header-controls">
      {{- if .IsPage }}
      <a href="/blog" class="back-link" aria-label="Torna al Blog">
        <svg class="back-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
        <span>Blog</span>
      </a>
      {{- end }}

      {{- if not $disableToggle }}
      <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme" type="button">
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
      {{- end }}
    </div>
  </div>

  {{- if not $disableToggle }}
  <!-- Theme Toggle Button -->
  <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme" type="button">
    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
    </svg>
    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>
  {{- end }}
</header>

{{- if not $disableToggle }}
<script>
(function () {
  const storageKey = "pref-theme";
  const defaultTheme = "{{ $defaultTheme }}";
  const button = document.getElementById("theme-toggle");
  const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
  const root = document.body;
  const themeMeta = document.querySelector('meta[name="theme-color"]');

  if (!root || !button) {
    return;
  }

  const updateMeta = (theme) => {
    if (!themeMeta) return;
    themeMeta.setAttribute("content", theme === "dark" ? "#0f172a" : "#ffffff");
  };

  const applyTheme = (theme) => {
    const isDark = theme === "dark";
    root.classList.toggle("dark", isDark);
    button.setAttribute("aria-pressed", String(isDark));
    updateMeta(theme);
  };

  const storedTheme = localStorage.getItem(storageKey);

  const getPreferredTheme = () => {
    if (storedTheme === "dark" || storedTheme === "light") {
      return storedTheme;
    }
    if (defaultTheme === "dark" || defaultTheme === "light") {
      return defaultTheme;
    }
    return prefersDark && prefersDark.matches ? "dark" : "light";
  };

  applyTheme(getPreferredTheme());

  if (!storedTheme && defaultTheme === "auto" && prefersDark) {
    const listener = (event) => {
      applyTheme(event.matches ? "dark" : "light");
    };
    if (typeof prefersDark.addEventListener === "function") {
      prefersDark.addEventListener("change", listener);
    } else if (typeof prefersDark.addListener === "function") {
      prefersDark.addListener(listener);
    }
  }

  button.addEventListener("click", () => {
    const nextTheme = root.classList.contains("dark") ? "light" : "dark";
    applyTheme(nextTheme);
    localStorage.setItem(storageKey, nextTheme);
  });
})();
</script>
{{- end }}

