<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogLens Local</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --border-color: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .sidebar {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        textarea {
            width: 100%;
            height: 200px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 16px;
            font-family: inherit;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        input, select {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 8px 12px;
            font-family: inherit;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-group label {
            margin: 0;
            font-size: 13px;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        button {
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 10px 16px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        button.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        button.danger {
            background: var(--accent-red);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .timeline {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .timeline h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 16px;
        }

        .timeline-bar {
            height: 40px;
            background: var(--bg-primary);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            margin-bottom: 12px;
        }

        .timeline-segment {
            height: 100%;
            cursor: pointer;
            transition: opacity 0.2s;
            position: relative;
        }

        .timeline-segment:hover {
            opacity: 0.8;
        }

        .timeline-legend {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
        }

        .log-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .log-entry {
            border-bottom: 1px solid var(--border-color);
            padding: 20px;
            transition: background-color 0.2s;
            position: relative;
        }

        .log-entry:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.bookmarked {
            border-left: 4px solid var(--accent-yellow);
        }

        .log-entry.grouped {
            border-left: 4px solid var(--accent-purple);
        }

        .log-header {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 16px;
            align-items: center;
            margin-bottom: 12px;
        }

        .timestamp {
            color: var(--accent-purple);
            font-weight: 600;
            font-size: 12px;
        }

        .relative-time {
            color: var(--text-muted);
            font-size: 10px;
            display: block;
            margin-top: 2px;
        }

        .server {
            color: var(--accent-blue);
            font-size: 12px;
            font-weight: 500;
        }

        .service {
            color: var(--accent-green);
            font-size: 12px;
            font-weight: 500;
        }

        .level {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .level-error {
            background: var(--accent-red);
            color: white;
        }

        .level-debug {
            background: var(--accent-blue);
            color: white;
        }

        .level-info {
            background: var(--accent-green);
            color: white;
        }

        .level-warning {
            background: var(--accent-yellow);
            color: var(--bg-primary);
        }

        .level-notice {
            background: var(--accent-purple);
            color: white;
        }

        .bookmark-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .bookmark-btn:hover {
            color: var(--accent-yellow);
            background: rgba(245, 158, 11, 0.1);
        }

        .bookmark-btn.active {
            color: var(--accent-yellow);
        }

        .log-details {
            margin-bottom: 12px;
        }

        .filename {
            color: var(--accent-blue);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .line-number {
            color: var(--accent-yellow);
        }

        .message {
            background: var(--bg-primary);
            border-left: 3px solid var(--accent-blue);
            padding: 12px;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            margin-bottom: 8px;
        }

        .message.error {
            border-left-color: var(--accent-red);
        }

        .message.warning {
            border-left-color: var(--accent-yellow);
        }

        .php-insight {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .insight-title {
            font-weight: 600;
            color: var(--accent-purple);
            margin-bottom: 4px;
        }

        .stack-trace {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 8px;
            font-size: 11px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .stack-trace-header {
            background: var(--bg-tertiary);
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stack-trace-header:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .stack-trace-content {
            padding: 12px;
            color: var(--text-secondary);
            white-space: pre-wrap;
            font-family: 'SF Mono', monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        .stack-trace.collapsed .stack-trace-content {
            display: none;
        }

        .group-header {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .group-header:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .group-count {
            background: var(--accent-purple);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .group-content {
            margin-left: 20px;
            border-left: 2px solid var(--border-color);
            padding-left: 20px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .group-content.collapsed {
            max-height: 0;
            padding: 0 0 0 20px;
        }

        .no-logs {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .floating-controls button {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 6px;
            box-shadow: var(--shadow);
        }

        .regex-highlight {
            background: rgba(245, 158, 11, 0.3);
            padding: 1px 3px;
            border-radius: 2px;
        }

        .shortcuts-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            padding: 20px;
        }

        .shortcuts-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .shortcut-key {
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 11px;
            font-weight: 600;
        }

        @media (max-width: 1024px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
            
            .log-header {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .shortcuts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .floating-controls {
                flex-direction: row;
                bottom: 10px;
                left: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>LogLens Local</h1>
            <p>Advanced PHP log parser for backend developers</p>
        </div>

        <div class="controls">
            <div class="input-section">
                <div class="form-group">
                    <label for="logInput">Paste Your Log Data</label>
                    <textarea id="logInput" placeholder="Paste your raw log entries here...

Example:
Aug  1 16:04:12 172.20.10.2 townnews-error[1492212]: [filename=...] [level=error] [line=919] [message=...] [time=...] #0 ... #1 ...

Keyboard shortcuts: Ctrl+Enter to parse, Esc to clear, ? for help"></textarea>
                </div>
                
                <div class="button-group">
                    <button id="parseBtn">Parse Logs</button>
                    <button class="secondary" id="clearBtn">Clear All</button>
                    <input type="file" id="fileInput" accept=".txt,.log" style="display: none;">
                    <button class="secondary" onclick="document.getElementById('fileInput').click()">Load File</button>
                    <button class="secondary" id="exportBtn">Export</button>
                    <button class="secondary" id="shortcutsBtn">Shortcuts (?)</button>
                </div>
            </div>

            <div class="sidebar">
                <div class="form-group">
                    <label>Quick Filters</label>
                    <select id="levelFilter">
                        <option value="">All Levels</option>
                        <option value="error">Error</option>
                        <option value="debug">Debug</option>
                        <option value="info">Info</option>
                        <option value="warning">Warning</option>
                        <option value="notice">Notice</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Search Message</label>
                    <input type="text" id="messageFilter" placeholder="Filter by message content...">
                </div>

                <div class="form-group">
                    <label>Filename Filter</label>
                    <input type="text" id="filenameFilter" placeholder="Filter by filename...">
                </div>

                <div class="form-group">
                    <label>Server Filter</label>
                    <input type="text" id="serverFilter" placeholder="Filter by server IP...">
                </div>

                <div class="form-group">
                    <label>Regex Highlight</label>
                    <input type="text" id="regexFilter" placeholder="Regex pattern to highlight...">
                </div>

                <div class="form-group">
                    <label>Display Options</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="groupSimilar" checked>
                        <label for="groupSimilar">Group similar errors</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="collapseStack" checked>
                        <label for="collapseStack">Collapse stack traces</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showRelativeTime" checked>
                        <label for="showRelativeTime">Show relative time</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="phpInsights" checked>
                        <label for="phpInsights">PHP insights</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="stats" class="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total Entries</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errorCount">0</div>
                <div class="stat-label">Errors</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uniqueFiles">0</div>
                <div class="stat-label">Unique Files</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="timeRange">-</div>
                <div class="stat-label">Time Range</div>
            </div>
        </div>

        <div id="timeline" class="timeline" style="display: none;">
            <h3>Error Frequency Timeline</h3>
            <div class="timeline-bar" id="timelineBar"></div>
            <div class="timeline-legend">
                <span>Start</span>
                <span>End</span>
            </div>
        </div>

        <div id="logContainer" class="log-container">
            <div class="no-logs">
                <h3>No logs to display</h3>
                <p>Paste log entries above and click "Parse Logs" to get started</p>
                <p><small>Press Ctrl+Enter to parse quickly</small></p>
            </div>
        </div>
    </div>

    <div class="floating-controls" id="floatingControls" style="display: none;">
        <button id="copyAllBtn">📋 Copy All</button>
        <button id="collapseAllBtn">📁 Collapse All</button>
        <button id="expandAllBtn">📂 Expand All</button>
        <button id="clearBookmarksBtn">⭐ Clear Bookmarks</button>
    </div>

    <div class="shortcuts-modal" id="shortcutsModal">
        <div class="shortcuts-content">
            <h3>Keyboard Shortcuts</h3>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <span>Parse logs</span>
                    <span class="shortcut-key">Ctrl + Enter</span>
                </div>
                <div class="shortcut-item">
                    <span>Clear all</span>
                    <span class="shortcut-key">Esc</span>
                </div>
                <div class="shortcut-item">
                    <span>Focus filter</span>
                    <span class="shortcut-key">F</span>
                </div>
                <div class="shortcut-item">
                    <span>Toggle shortcuts</span>
                    <span class="shortcut-key">?</span>
                </div>
                <div class="shortcut-item">
                    <span>Copy filtered logs</span>
                    <span class="shortcut-key">Ctrl + C</span>
                </div>
                <div class="shortcut-item">
                    <span>Expand/collapse all</span>
                    <span class="shortcut-key">Ctrl + A</span>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="secondary" onclick="toggleShortcuts()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // LogLens Local - Enhanced PHP Log Parser
        let parsedLogs = [];
        let filteredLogs = [];
        let bookmarkedLogs = new Set();
        let currentRegex = null;
        let groupedData = {};

        // PHP error patterns and insights
        const phpInsights = {
            'Undefined array key': {
                title: 'Undefined Array Key',
                suggestion: 'Use isset() or null coalescing operator (??) to check if array key exists before accessing.'
            },
            'Trying to access array offset on null': {
                title: 'Null Array Access',
                suggestion: 'Check if variable is not null before accessing array elements. Use is_array() check.'
            },
            'Call to protected': {
                title: 'Protected Method Access',
                suggestion: 'Method is protected and called from outside class scope. Check visibility or use public method.'
            },
            'Declaration of': {
                title: 'Method Signature Mismatch',
                suggestion: 'Method signature doesn\'t match parent class. Ensure parameter types and counts match.'
            },
            'Connection timed out': {
                title: 'Network Timeout',
                suggestion: 'Check network connectivity, increase timeout values, or verify service availability.'
            },
            'Authentication failed': {
                title: 'Authentication Issue',
                suggestion: 'Verify credentials, check authentication server status, or review auth configuration.'
            },
            'preg_split()': {
                title: 'Deprecated Function Usage',
                suggestion: 'Update function call to match current PHP version requirements. Check parameter types.'
            }
        };

        // DOM elements
        const logInput = document.getElementById('logInput');
        const parseBtn = document.getElementById('parseBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');
        const shortcutsBtn = document.getElementById('shortcutsBtn');
        const fileInput = document.getElementById('fileInput');
        const logContainer = document.getElementById('logContainer');
        const stats = document.getElementById('stats');
        const timeline = document.getElementById('timeline');
        const floatingControls = document.getElementById('floatingControls');
        const shortcutsModal = document.getElementById('shortcutsModal');

        // Filter elements
        const levelFilter = document.getElementById('levelFilter');
        const messageFilter = document.getElementById('messageFilter');
        const filenameFilter = document.getElementById('filenameFilter');
        const serverFilter = document.getElementById('serverFilter');
        const regexFilter = document.getElementById('regexFilter');

        // Option elements
        const groupSimilar = document.getElementById('groupSimilar');
        const collapseStack = document.getElementById('collapseStack');
        const showRelativeTime = document.getElementById('showRelativeTime');
        const phpInsights = document.getElementById('phpInsights');

        // Event listeners
        parseBtn.addEventListener('click', parseLog);
        clearBtn.addEventListener('click', clearAll);
        exportBtn.addEventListener('click', exportLogs);
        shortcutsBtn.addEventListener('click', toggleShortcuts);
        fileInput.addEventListener('change', loadFile);

        // Filter event listeners
        [levelFilter, messageFilter, filenameFilter, serverFilter, regexFilter].forEach(element => {
            element.addEventListener('input', applyFiltersAndRender);
        });

        [groupSimilar, collapseStack, showRelativeTime, phpInsights].forEach(element => {
            element.addEventListener('change', renderLogs);
        });

        // Floating controls
        document.getElementById('copyAllBtn').addEventListener('click', copyAllLogs);
        document.getElementById('collapseAllBtn').addEventListener('click', collapseAll);
        document.getElementById('expandAllBtn').addEventListener('click', expandAll);
        document.getElementById('clearBookmarksBtn').addEventListener('click', clearBookmarks);

        function parseLog() {
            const input = logInput.value.trim();
            if (!input) return;

            const lines = input.split('\n').filter(line => line.trim());
            parsedLogs = [];
            
            lines.forEach((line, index) => {
                const parsed = parseLogLine(line);
                if (parsed) {
                    parsed.originalIndex = index;
                    parsedLogs.push(parsed);
                }
            });

            if (parsedLogs.length > 0) {
                applyFiltersAndRender();
                updateStats();
                generateTimeline();
                stats.style.display = 'block';
                timeline.style.display = 'block';
                floatingControls.style.display = 'flex';
            }
        }

        function parseLogLine(line) {
            // Enhanced regex to parse townnews/tncms log format
            const patterns = [
                // townnews-error pattern: Aug  1 16:04:12 172.20.10.2 townnews-error[1492212]: [logsplit=|-|] ...
                /^(\w+\s+\d+\s+\d{2}:\d{2}:\d{2})\s+([^\s]+)\s+([^\[]+)\[(\d+)\]:\s*(.+)$/,
                // tncms pattern: Aug  1 16:15:36 172.20.10.2 tncms-debug[1509035]: [logsplit=|domain|] ...
                /^(\w+\s+\d+\s+\d{2}:\d{2}:\d{2})\s+([^\s]+)\s+([^\[]+)\[(\d+)\]:\s*(.+)$/
            ];

            for (const pattern of patterns) {
                const match = line.match(pattern);
                if (match) {
                    const [, timestamp, server, service, pid, content] = match;
                    
                    const parsed = {
                        timestamp,
                        server,
                        service,
                        pid: parseInt(pid),
                        content,
                        raw: line,
                        parsedDate: parseTimestamp(timestamp)
                    };
                    
                    parseStructuredContent(parsed, content);
                    return parsed;
                }
            }
            
            return null;
        }

        function parseTimestamp(timestamp) {
            const year = new Date().getFullYear();
            const dateStr = `${timestamp} ${year}`;
            return new Date(dateStr);
        }

        function parseStructuredContent(parsed, content) {
            // Extract key-value pairs in brackets
            const kvPattern = /\[([^=\]]+)=([^\]]*)\]/g;
            let match;
            const fields = {};
            
            while ((match = kvPattern.exec(content)) !== null) {
                const key = match[1].trim();
                const value = match[2].trim();
                fields[key] = value;
            }

            // Set common fields
            parsed.level = fields.level || 'info';
            parsed.filename = fields.filename || 'Unknown';
            parsed.line = fields.line || '';
            parsed.message = fields.message || extractPlainMessage(content);
            parsed.logsplit = fields.logsplit || '';
            parsed.time = fields.time || '';
            
            // Add any additional fields
            Object.keys(fields).forEach(key => {
                if (!['level', 'filename', 'line', 'message', 'logsplit', 'time'].includes(key)) {
                    parsed[key] = fields[key];
                }
            });

            // Extract stack trace
            const stackMatch = content.match(/#\d+[^\n]*(?:\n.*#\d+[^\n]*)*/);
            if (stackMatch) {
                parsed.stackTrace = highlightStackTrace(stackMatch[0]);
            }

            // Generate signature for grouping
            parsed.signature = generateSignature(parsed);
        }

        function extractPlainMessage(content) {
            // Remove structured parts and stack traces to get plain message
            let message = content
                .replace(/\[[^=\]]+=[^\]]*\]/g, '') // Remove [key=value] pairs
                .replace(/#\d+.*$/s, '') // Remove stack traces
                .trim();
            
            return message || content.substring(0, 100);
        }

        function generateSignature(log) {
            // Create a signature for grouping similar errors
            const parts = [
                log.service,
                log.filename,
                log.line,
                log.message.split(/\s+/).slice(0, 8).join(' ') // First 8 words
            ];
            return parts.filter(p => p && p !== 'Unknown').join(' | ');
        }

        function highlightStackTrace(stackTrace) {
            return stackTrace
                .replace(/(\w+)::/g, '<span style="color: var(--accent-blue)">$1</span>::')
                .replace(/->(\w+)/g, '-><span style="color: var(--accent-green)">$1</span>')
                .replace(/(\w+\.php)/g, '<span style="color: var(--accent-blue)">$1</span>')
                .replace(/\((\d+)\)/g, '(<span style="color: var(--accent-yellow)">$1</span>)')
                .replace(/(#\d+)/g, '<span style="color: var(--accent-purple)">$1</span>');
        }

        function applyFiltersAndRender() {
            const levelValue = levelFilter.value;
            const messageValue = messageFilter.value.toLowerCase();
            const filenameValue = filenameFilter.value.toLowerCase();
            const serverValue = serverFilter.value.toLowerCase();
            const regexValue = regexFilter.value;

            // Compile regex if provided
            currentRegex = null;
            if (regexValue) {
                try {
                    currentRegex = new RegExp(regexValue, 'gi');
                } catch (e) {
                    console.warn('Invalid regex:', e);
                }
            }

            filteredLogs = parsedLogs.filter(log => {
                if (levelValue && log.level !== levelValue) return false;
                if (messageValue && !log.message.toLowerCase().includes(messageValue)) return false;
                if (filenameValue && !log.filename.toLowerCase().includes(filenameValue)) return false;
                if (serverValue && !log.server.toLowerCase().includes(serverValue)) return false;
                return true;
            });

            renderLogs();
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = parsedLogs.length;
            
            const errorCount = parsedLogs.filter(log => 
                ['error', 'fatal', 'critical'].includes(log.level.toLowerCase())
            ).length;
            document.getElementById('errorCount').textContent = errorCount;

            const uniqueFiles = new Set(parsedLogs.map(log => log.filename)).size;
            document.getElementById('uniqueFiles').textContent = uniqueFiles;
            
            if (parsedLogs.length > 0) {
                const dates = parsedLogs.map(log => log.parsedDate).sort();
                const timeDiff = dates[dates.length - 1] - dates[0];
                const minutes = Math.floor(timeDiff / 60000);
                document.getElementById('timeRange').textContent = minutes > 0 ? `${minutes}m` : '<1m';
            }
        }

        function generateTimeline() {
            if (parsedLogs.length === 0) return;
            
            const timelineBar = document.getElementById('timelineBar');
            const errorLogs = parsedLogs.filter(log => log.level === 'error');
            
            if (errorLogs.length === 0) {
                timelineBar.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No errors to display in timeline</div>';
                return;
            }

            // Group errors by hour
            const hourlyData = {};
            errorLogs.forEach(log => {
                const hour = log.parsedDate.getHours();
                hourlyData[hour] = (hourlyData[hour] || 0) + 1;
            });
            
            const maxCount = Math.max(...Object.values(hourlyData));
            timelineBar.innerHTML = '';
            
            for (let hour = 0; hour < 24; hour++) {
                const count = hourlyData[hour] || 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                const segment = document.createElement('div');
                segment.className = 'timeline-segment';
                segment.style.width = `${100/24}%`;
                segment.style.backgroundColor = `rgba(239, 68, 68, ${Math.max(0.1, intensity)})`;
                segment.title = `${hour}:00 - ${count} errors`;
                
                segment.addEventListener('click', () => {
                    // Filter logs for this hour
                    const hourLogs = errorLogs.filter(log => log.parsedDate.getHours() === hour);
                    if (hourLogs.length > 0) {
                        scrollToLog(hourLogs[0].originalIndex);
                    }
                });
                
                timelineBar.appendChild(segment);
            }
        }

        function renderLogs() {
            const shouldGroup = groupSimilar.checked;
            
            if (filteredLogs.length === 0) {
                logContainer.innerHTML = '<div class="no-logs"><h3>No logs match your filters</h3><p>Try adjusting your filter criteria</p></div>';
                return;
            }

            let html = '';
            
            if (shouldGroup) {
                const groups = groupLogsBySignature(filteredLogs);
                Object.entries(groups).forEach(([signature, logs]) => {
                    if (logs.length > 1) {
                        html += renderLogGroup(signature, logs);
                    } else {
                        html += renderLogEntry(logs[0]);
                    }
                });
            } else {
                filteredLogs.forEach(log => {
                    html += renderLogEntry(log);
                });
            }
            
            logContainer.innerHTML = html;
        }

        function groupLogsBySignature(logs) {
            const groups = {};
            logs.forEach(log => {
                const sig = log.signature;
                if (!groups[sig]) {
                    groups[sig] = [];
                }
                groups[sig].push(log);
            });
            return groups;
        }

        function renderLogGroup(signature, logs) {
            const firstLog = logs[0];
            const count = logs.length;
            const groupId = btoa(signature).replace(/[^a-zA-Z0-9]/g, '');
            
            let html = `
                <div class="group-header" onclick="toggleGroup('${groupId}')">
                    <div>
                        <strong>${firstLog.service}</strong> - ${firstLog.level.toUpperCase()}
                        <br><small>${signature}</small>
                    </div>
                    <div class="group-count">${count}</div>
                </div>
                <div class="group-content collapsed" id="group-${groupId}">
            `;
            
            logs.forEach(log => {
                html += renderLogEntry(log, true);
            });
            
            html += '</div>';
            return html;
        }

        function renderLogEntry(log, isGrouped = false) {
            const shouldCollapseStack = collapseStack.checked;
            const shouldShowRelativeTime = showRelativeTime.checked;
            const shouldShowInsights = phpInsights.checked;
            
            const relativeTime = shouldShowRelativeTime ? getRelativeTime(log.parsedDate) : '';
            const isBookmarked = bookmarkedLogs.has(log.originalIndex);
            
            let highlightedMessage = log.message;
            if (currentRegex) {
                highlightedMessage = log.message.replace(currentRegex, '<span class="regex-highlight">        function parseStructuredContent(parsed, content) {
            // Extract key-value pairs in brackets
            const kvPattern = /\[([^=\]]+)=([^\]]*)\]/g;
            let match;
            const fields = {};
            
            while ((match = kvPattern.exec(content)) !== null) {
                const key = match[1].trim();</span>');
            }
            
            const insight = shouldShowInsights ? getPHPInsight(log.message) : null;
            
            let messageClass = '';
            if (log.level === 'error') messageClass = 'error';
            else if (log.level === 'warning') messageClass = 'warning';
            
            return `
                <div class="log-entry ${isBookmarked ? 'bookmarked' : ''} ${isGrouped ? 'grouped' : ''}" 
                     data-index="${log.originalIndex}" id="log-${log.originalIndex}">
                    <div class="log-header">
                        <div class="timestamp">
                            ${formatTimestamp(log.parsedDate)}
                            ${relativeTime ? `<span class="relative-time">${relativeTime}</span>` : ''}
                        </div>
                        <div class="server">${log.server}</div>
                        <div class="service">${log.service}[${log.pid}]</div>
                        <div class="level level-${log.level}">${log.level}</div>
                        <button class="bookmark-btn ${isBookmarked ? 'active' : ''}" 
                                onclick="toggleBookmark(${log.originalIndex})" 
                                title="Bookmark this entry">
                            ${isBookmarked ? '⭐' : '☆'}
                        </button>
                    </div>
                    <div class="log-details">
                        ${log.filename !== 'Unknown' ? `
                            <div class="filename">
                                ${log.filename}${log.line ? `:<span class="line-number">${log.line}</span>` : ''}
                            </div>
                        ` : ''}
                        <div class="message ${messageClass}">${highlightedMessage}</div>
                        ${insight ? `
                            <div class="php-insight">
                                <div class="insight-title">${insight.title}</div>
                                <div>${insight.suggestion}</div>
                            </div>
                        ` : ''}
                        ${log.stackTrace ? `
                            <div class="stack-trace ${shouldCollapseStack ? 'collapsed' : ''}">
                                <div class="stack-trace-header" onclick="toggleStackTrace(this)">
                                    <span>📋</span>
                                    <span>Stack Trace ${shouldCollapseStack ? '(click to expand)' : '(click to collapse)'}</span>
                                </div>
                                <div class="stack-trace-content">${log.stackTrace}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function formatTimestamp(date) {
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function getRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffDays > 0) return `${diffDays}d ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            if (diffMins > 0) return `${diffMins}m ago`;
            return `${diffSecs}s ago`;
        }

        function getPHPInsight(message) {
            for (const [pattern, insight] of Object.entries(phpInsights)) {
                if (message.includes(pattern)) {
                    return insight;
                }
            }
            return null;
        }

        function toggleGroup(groupId) {
            const group = document.getElementById(`group-${groupId}`);
            if (group) {
                group.classList.toggle('collapsed');
            }
        }

        function toggleStackTrace(element) {
            const stackTrace = element.parentElement;
            stackTrace.classList.toggle('collapsed');
            
            const span = element.querySelector('span:last-child');
            if (stackTrace.classList.contains('collapsed')) {
                span.textContent = 'Stack Trace (click to expand)';
            } else {
                span.textContent = 'Stack Trace (click to collapse)';
            }
        }

        function toggleBookmark(index) {
            if (bookmarkedLogs.has(index)) {
                bookmarkedLogs.delete(index);
            } else {
                bookmarkedLogs.add(index);
            }
            
            // Update the visual state
            const logEntry = document.querySelector(`[data-index="${index}"]`);
            const bookmarkBtn = logEntry.querySelector('.bookmark-btn');
            
            if (bookmarkedLogs.has(index)) {
                logEntry.classList.add('bookmarked');
                bookmarkBtn.classList.add('active');
                bookmarkBtn.textContent = '⭐';
            } else {
                logEntry.classList.remove('bookmarked');
                bookmarkBtn.classList.remove('active');
                bookmarkBtn.textContent = '☆';
            }
        }

        function scrollToLog(index) {
            const logElement = document.getElementById(`log-${index}`);
            if (logElement) {
                logElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                logElement.style.background = 'rgba(59, 130, 246, 0.1)';
                setTimeout(() => {
                    logElement.style.background = '';
                }, 2000);
            }
        }

        function copyAllLogs() {
            const logText = filteredLogs.map(log => log.raw).join('\n');
            navigator.clipboard.writeText(logText).then(() => {
                showNotification('Logs copied to clipboard!');
            }).catch(() => {
                showNotification('Failed to copy logs', 'error');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.group-content').forEach(group => {
                group.classList.add('collapsed');
            });
            document.querySelectorAll('.stack-trace').forEach(stack => {
                stack.classList.add('collapsed');
                const span = stack.querySelector('.stack-trace-header span:last-child');
                if (span) span.textContent = 'Stack Trace (click to expand)';
            });
        }

        function expandAll() {
            document.querySelectorAll('.group-content').forEach(group => {
                group.classList.remove('collapsed');
            });
            document.querySelectorAll('.stack-trace').forEach(stack => {
                stack.classList.remove('collapsed');
                const span = stack.querySelector('.stack-trace-header span:last-child');
                if (span) span.textContent = 'Stack Trace (click to collapse)';
            });
        }

        function clearBookmarks() {
            bookmarkedLogs.clear();
            document.querySelectorAll('.log-entry').forEach(entry => {
                entry.classList.remove('bookmarked');
            });
            document.querySelectorAll('.bookmark-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.textContent = '☆';
            });
        }

        function exportLogs() {
            const data = {
                timestamp: new Date().toISOString(),
                totalLogs: parsedLogs.length,
                filteredLogs: filteredLogs.length,
                bookmarks: Array.from(bookmarkedLogs),
                logs: filteredLogs
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loglens-export-${new Date().toISOString().slice(0, 19)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadFile() {
            const file = fileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                logInput.value = e.target.result;
                parseLog();
            };
            reader.readAsText(file);
        }

        function clearAll() {
            logInput.value = '';
            parsedLogs = [];
            filteredLogs = [];
            bookmarkedLogs.clear();
            currentRegex = null;
            
            // Reset filters
            levelFilter.value = '';
            messageFilter.value = '';
            filenameFilter.value = '';
            serverFilter.value = '';
            regexFilter.value = '';
            
            // Hide sections
            stats.style.display = 'none';
            timeline.style.display = 'none';
            floatingControls.style.display = 'none';
            
            // Reset log container
            logContainer.innerHTML = `
                <div class="no-logs">
                    <h3>No logs to display</h3>
                    <p>Paste log entries above and click "Parse Logs" to get started</p>
                    <p><small>Press Ctrl+Enter to parse quickly</small></p>
                </div>
            `;
        }

        function toggleShortcuts() {
            const modal = shortcutsModal;
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 3000;
                background: ${type === 'error' ? 'var(--accent-red)' : 'var(--accent-green)'};
                box-shadow: var(--shadow);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter: Parse logs
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                parseLog();
            }
            
            // Escape: Clear all or close modal
            if (e.key === 'Escape') {
                if (shortcutsModal.style.display === 'block') {
                    toggleShortcuts();
                } else {
                    clearAll();
                }
            }
            
            // F: Focus message filter
            if (e.key === 'f' && !e.ctrlKey && !e.altKey && 
                document.activeElement.tagName !== 'INPUT' && 
                document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                messageFilter.focus();
            }
            
            // ?: Toggle shortcuts
            if (e.key === '?' && !e.ctrlKey && !e.altKey) {
                e.preventDefault();
                toggleShortcuts();
            }
            
            // Ctrl+C: Copy filtered logs (when not in input)
            if (e.ctrlKey && e.key === 'c' && 
                document.activeElement.tagName !== 'INPUT' && 
                document.activeElement.tagName !== 'TEXTAREA') {
                if (filteredLogs.length > 0) {
                    e.preventDefault();
                    copyAllLogs();
                }
            }
            
            // Ctrl+A: Toggle expand/collapse all
            if (e.ctrlKey && e.key === 'a' && 
                document.activeElement.tagName !== 'INPUT' && 
                document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                const hasCollapsed = document.querySelector('.group-content.collapsed, .stack-trace.collapsed');
                if (hasCollapsed) {
                    expandAll();
                } else {
                    collapseAll();
                }
            }
        });

        // Close shortcuts modal when clicking outside
        shortcutsModal.addEventListener('click', function(e) {
            if (e.target === shortcutsModal) {
                toggleShortcuts();
            }
        });

        // Auto-save state to localStorage (if available)
        function saveState() {
            try {
                const state = {
                    logs: logInput.value,
                    bookmarks: Array.from(bookmarkedLogs),
                    filters: {
                        level: levelFilter.value,
                        message: messageFilter.value,
                        filename: filenameFilter.value,
                        server: serverFilter.value,
                        regex: regexFilter.value
                    },
                    options: {
                        groupSimilar: groupSimilar.checked,
                        collapseStack: collapseStack.checked,
                        showRelativeTime: showRelativeTime.checked,
                        phpInsights: phpInsights.checked
                    }
                };
                localStorage.setItem('loglens-state', JSON.stringify(state));
            } catch (e) {
                // localStorage not available or quota exceeded
            }
        }

        function loadState() {
            try {
                const state = JSON.parse(localStorage.getItem('loglens-state') || '{}');
                if (state.logs) {
                    logInput.value = state.logs;
                }
                if (state.filters) {
                    levelFilter.value = state.filters.level || '';
                    messageFilter.value = state.filters.message || '';
                    filenameFilter.value = state.filters.filename || '';
                    serverFilter.value = state.filters.server || '';
                    regexFilter.value = state.filters.regex || '';
                }
                if (state.options) {
                    groupSimilar.checked = state.options.groupSimilar !== false;
                    collapseStack.checked = state.options.collapseStack !== false;
                    showRelativeTime.checked = state.options.showRelativeTime !== false;
                    phpInsights.checked = state.options.phpInsights !== false;
                }
                if (state.bookmarks) {
                    bookmarkedLogs = new Set(state.bookmarks);
                }
            } catch (e) {
                // Invalid state data
            }
        }

        // Auto-save on changes
        logInput.addEventListener('input', saveState);
        [levelFilter, messageFilter, filenameFilter, serverFilter, regexFilter].forEach(el => {
            el.addEventListener('input', saveState);
        });
        [groupSimilar, collapseStack, showRelativeTime, phpInsights].forEach(el => {
            el.addEventListener('change', saveState);
        });

        // Load state on page load
        window.addEventListener('load', loadState);

        // Add sample data button for demo
        const sampleBtn = document.createElement('button');
        sampleBtn.className = 'secondary';
        sampleBtn.textContent = 'Load Sample Data';
        sampleBtn.onclick = () => {
            logInput.value = `Aug  1 16:04:12 172.20.10.2 townnews-error[1492212]: [logsplit=|-|] [filename=/usr/local/lib/php/tncms/gearman/worker/driver/classifieds.php] [level=error] [line=919] [message=Trying to access array offset on null] [time=1754082252] #0 /usr/local/lib/php/tncms/gearman/worker/driver/classifieds.php(919): Townnews\\Error::toException(2, 'Trying to acces...', '/usr/local/lib/...', 919) #1 [internal function]: tncms_gearman_worker_driver_classifieds->_fatalShutdown() #2 {main}
Aug  1 16:00:07 172.20.10.4 townnews-error[2579448]: [logsplit=|-|] [filename=/usr/local/lib/php/tncms/job/driver/udloader.php] [level=error] [line=367] [message=preg_split(): Passing null to parameter #3 ($limit) of type int is deprecated] [time=1754082007] #0 [internal function]: Townnews\\Error::toException(8192, 'preg_split(): P...', '/usr/local/lib/...', 367) #1 /usr/local/lib/php/tncms/job/driver/udloader.php(367): preg_split('#\\n#', '', NULL, 1) #2 [internal function]: TNCMS\\Job\\Driver\\Udloader->_logOutput('', 9) #3 {main}
Aug  1 16:15:36 172.20.10.2 tncms-debug[1509035]: [logsplit=|jhansen.cms.dev1.vip.inn.mwn.leeent.net|] [app=editorial] [context=asset/manager/plugin] [domain=jhansen.cms.dev1.vip.inn.mwn.leeent.net] [level=error] [plugin=cache] [time=1754082936] [type=article] [uuid=b7b24b7f-fddc-50b0-b645-d19c95cbe052] Cache purging failed: Error purging cache: received status code 429`;
            parseLog();
        };
        parseBtn.parentNode.insertBefore(sampleBtn, exportBtn);
    </script>
</body>
</html>
